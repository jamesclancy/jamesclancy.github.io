<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Wilkens Avenue - Step 19 - Update Login Information in Navbar &middot; James Clancy
    
  </title>

  
  <link rel="canonical" href="/projects/wilkensavenue/2021/09/07/WilkensAvenueStep19UpdateLoginInfoInNavbar/">
  

  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6FZ90LRCT8"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-6FZ90LRCT8');
    </script>
  
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Largely a mess of content. The idea is to generate content then refine sometime in the future.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>
    








  
  
  

  
    

    

    
    

        

        
        <a class="sidebar-nav-item" href="/categories/bookreviews/">
          BookReviews
          (<span class="text-muted small font-weight-light">
              77
              
          </span>)
        </a>

        <!-- content count -->


    


    

  

  
  
  

  
    

    

    
    

        

        
        <a class="sidebar-nav-item" href="/categories/general/">
          General
          (<span class="text-muted small font-weight-light">
              2
              
          </span>)
        </a>

        <!-- content count -->


    


    

  

  
  
  

  

  
  
  

  
    

    

    
    

        

        
        <a class="sidebar-nav-item" href="/categories/projects/">
          Projects
          (<span class="text-muted small font-weight-light">
              38
              
          </span>)
        </a>

        <!-- content count -->


    
        
          
          
          <a class="sidebar-nav-item" 
              href="/categories/kafkaui/" style="padding-left:60px;">KafkaUI (<span class="text-muted small font-weight-light">
                1
                
              </span>)</a>

          
        
          
          
          <a class="sidebar-nav-item" 
              href="/categories/safecardgame/" style="padding-left:60px;">SafeCardGame (<span class="text-muted small font-weight-light">
                17
                
              </span>)</a>

          
        
          
          
          <a class="sidebar-nav-item" 
              href="/categories/wilkensavenue/" style="padding-left:60px;">WilkensAvenue (<span class="text-muted small font-weight-light">
                20
                
              </span>)</a>

          
        
    


    

  

  
  
  

  
    

    

    
    

        

        
        <a class="sidebar-nav-item" href="/categories/recipes/">
          Recipes
          (<span class="text-muted small font-weight-light">
              16
              
          </span>)
        </a>

        <!-- content count -->


    


    

  

  
  
  

  

  
  
  

  




  </nav>


<div class="sidebar-item">
  <p>
<a href="/about">About</a> | 
<a href="https://github.com/jamesclancy" aria-label="github" target="_blank" rel="noopener"> 
  <i class="fab fa-github-alt"></i> Github </a> | 
<a href="/feed.xml" aria-label="rss"> <i class="fas fa-rss"></i> RSS </a>
    </p>
    <p>
      &copy; 2022. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">James Clancy</a>
            <small>This needs to be reorganized in the future.</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Wilkens Avenue - Step 19 - Update Login Information in Navbar</h1>
  <span class="post-date">07 Sep 2021</span>
  <h2 id="goals-of-this-step">Goals of this Step</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* Navbar reflects if the user is logged in
* If the user is not logged in they are offered the option to login or register
* If the user is logged in they are offered the option to logout
</code></pre></div></div>

<h2 id="process">Process</h2>

<p>In order to check if a user is logged in I am adding a new <code class="language-plaintext highlighter-rouge">IPublicAccountApi</code> which is going to return the current logged in user and <code class="language-plaintext highlighter-rouge">ISecureAccountApi</code> which prompts the user to login.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">IPublicAccountApi</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="n">getCurrentUser</span><span class="p">:</span> <span class="kt">unit</span> <span class="p">-&gt;</span> <span class="nc">Async</span><span class="p">&lt;</span><span class="nc">Option</span><span class="p">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;</span>
    <span class="p">}</span>

<span class="k">type</span> <span class="nc">ISecureAccountApi</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="n">login</span><span class="p">:</span> <span class="kt">unit</span> <span class="p">-&gt;</span>  <span class="nc">Async</span><span class="p">&lt;</span><span class="nc">Option</span><span class="p">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;</span>
    <span class="p">}</span></code></pre></figure>

<p>I added function to <code class="language-plaintext highlighter-rouge">Authentication</code> to pull the user information from the <code class="language-plaintext highlighter-rouge">HttpContext</code></p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">userInformationFromContext</span> <span class="p">(</span><span class="n">ctx</span> <span class="p">:</span><span class="nc">HttpContext</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">nameClaim</span> <span class="p">=</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Security</span><span class="p">.</span><span class="nn">Claims</span><span class="p">.</span><span class="nc">Claim</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">Type</span> <span class="p">=</span> <span class="s2">"playerName"</span><span class="p">)</span> <span class="n">ctx</span><span class="p">.</span><span class="nn">User</span><span class="p">.</span><span class="nc">Claims</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">toList</span>
    <span class="k">let</span> <span class="n">idClaim</span> <span class="p">=</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Security</span><span class="p">.</span><span class="nn">Claims</span><span class="p">.</span><span class="nc">Claim</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">Type</span> <span class="p">=</span> <span class="s2">"playerId"</span><span class="p">)</span> <span class="n">ctx</span><span class="p">.</span><span class="nn">User</span><span class="p">.</span><span class="nc">Claims</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">toList</span>

    <span class="k">match</span> <span class="n">nameClaim</span><span class="p">,</span> <span class="n">idClaim</span> <span class="k">with</span>
    <span class="p">|</span> <span class="p">[</span> <span class="n">x</span> <span class="o">],</span> <span class="p">[</span> <span class="n">y</span> <span class="p">]</span> <span class="p">-&gt;</span> <span class="nc">Some</span> <span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nc">Value</span><span class="p">,</span> <span class="n">y</span><span class="p">.</span><span class="nc">Value</span><span class="p">)</span>
    <span class="p">|</span> <span class="bp">[]</span> <span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="p">-&gt;</span> <span class="nc">Some</span> <span class="p">(</span><span class="n">y</span><span class="p">.</span><span class="nc">Value</span><span class="p">,</span> <span class="n">y</span><span class="p">.</span><span class="nc">Value</span><span class="p">)</span>
    <span class="p">|</span> <span class="o">_,_</span> <span class="p">-&gt;</span> <span class="nc">None</span>

<span class="k">let</span> <span class="n">userDisplayNameFromContext</span> <span class="p">(</span><span class="n">ctx</span> <span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">userInformationFromContext</span> <span class="n">ctx</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span>  <span class="nc">None</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Some</span> <span class="n">x</span></code></pre></figure>

<p>I could then implement the server like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">generalPurposeApi</span> <span class="n">ctx</span> <span class="p">=</span>
        <span class="p">{</span>
            <span class="n">getCurrentUser</span> <span class="p">=</span> <span class="k">fun</span> <span class="kt">unit</span> <span class="p">-&gt;</span> <span class="n">async</span> <span class="p">{</span> <span class="k">return</span> <span class="n">userDisplayNameFromContext</span> <span class="n">ctx</span> <span class="p">}</span>
        <span class="p">}</span>

<span class="k">let</span> <span class="n">accountInformationApi</span> <span class="n">ctx</span> <span class="p">=</span>
        <span class="p">{</span>
            <span class="n">login</span> <span class="p">=</span> <span class="k">fun</span> <span class="kt">unit</span> <span class="p">-&gt;</span> <span class="n">async</span> <span class="p">{</span> <span class="k">return</span> <span class="n">userDisplayNameFromContext</span> <span class="n">ctx</span> <span class="p">}</span>
        <span class="p">}</span>

<span class="k">let</span> <span class="n">buildLocationApi</span> <span class="n">next</span> <span class="n">ctx</span> <span class="p">=</span>
    <span class="n">task</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">handler</span> <span class="p">=</span>
            <span class="nn">Remoting</span><span class="p">.</span><span class="n">createApi</span> <span class="bp">()</span>
            <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">withRouteBuilder</span> <span class="nn">Route</span><span class="p">.</span><span class="n">builderWithoutApiPrefix</span>
            <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">fromValue</span> <span class="n">locationInformationApi</span>
            <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">buildHttpHandler</span>
        <span class="k">return</span><span class="o">!</span> <span class="n">handler</span> <span class="n">next</span> <span class="n">ctx</span>
    <span class="p">}</span>

<span class="k">let</span> <span class="n">buildSecureAccountApi</span> <span class="n">next</span> <span class="n">ctx</span> <span class="p">=</span>
        <span class="n">task</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">handler</span> <span class="p">=</span>
                <span class="nn">Remoting</span><span class="p">.</span><span class="n">createApi</span> <span class="bp">()</span>
                <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">withRouteBuilder</span> <span class="nn">Route</span><span class="p">.</span><span class="n">builderWithoutApiPrefix</span>
                <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">fromValue</span> <span class="n">accountInformationApi</span>
                <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">buildHttpHandler</span>
            <span class="k">return</span><span class="o">!</span> <span class="n">handler</span> <span class="n">next</span> <span class="n">ctx</span>
        <span class="p">}</span>
        
<span class="k">let</span> <span class="n">buildPublicAccountApi</span> <span class="n">next</span> <span class="n">ctx</span> <span class="p">=</span>
                <span class="n">task</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="n">handler</span> <span class="p">=</span>
                        <span class="nn">Remoting</span><span class="p">.</span><span class="n">createApi</span> <span class="bp">()</span>
                        <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">withRouteBuilder</span> <span class="nn">Route</span><span class="p">.</span><span class="n">builderWithoutApiPrefix</span>
                        <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">fromValue</span> <span class="n">generalPurposeApi</span>
                        <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">buildHttpHandler</span>
                    <span class="k">return</span><span class="o">!</span> <span class="n">handler</span> <span class="n">next</span> <span class="n">ctx</span>
                <span class="p">}</span>

<span class="k">let</span> <span class="n">routes</span> <span class="p">:</span> <span class="nc">HttpFunc</span> <span class="p">-&gt;</span> <span class="nc">HttpContext</span> <span class="p">-&gt;</span> <span class="nc">HttpFuncResult</span> <span class="p">=</span>
    <span class="n">choose</span> <span class="p">[</span> <span class="n">route</span> <span class="s2">"/loggedinhomepage"</span>
             <span class="o">&gt;=&gt;</span> <span class="p">(</span><span class="n">authChallenge</span>
                  <span class="o">&gt;=&gt;</span> <span class="n">htmlString</span> <span class="s2">"You are logged in now."</span><span class="p">)</span>
             <span class="n">subRoute</span> <span class="s2">"/api"</span> <span class="p">(</span> <span class="n">buildLocationApi</span><span class="p">)</span>
             <span class="n">subRoute</span> <span class="s2">"/api"</span> <span class="p">(</span> <span class="n">buildPublicAccountApi</span><span class="p">)</span>
             <span class="n">subRoute</span> <span class="s2">"/api"</span> <span class="p">(</span> <span class="n">authChallenge</span> <span class="o">&gt;=&gt;</span> <span class="n">buildSecureAccountApi</span><span class="o">)]</span></code></pre></figure>

<p>In order to implement this on the client I registered instances of the IPublicAccountApi and ISecureAccountApi</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">secureAccountApi</span> <span class="p">=</span>
    <span class="nn">Remoting</span><span class="p">.</span><span class="n">createApi</span> <span class="bp">()</span>
    <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">withRouteBuilder</span> <span class="nn">Route</span><span class="p">.</span><span class="n">builder</span>
    <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">buildProxy</span><span class="p">&lt;</span><span class="nc">ISecureAccountApi</span><span class="p">&gt;</span>
<span class="k">let</span> <span class="n">publicAccountApi</span> <span class="p">=</span>
    <span class="nn">Remoting</span><span class="p">.</span><span class="n">createApi</span> <span class="bp">()</span>
    <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">withRouteBuilder</span> <span class="nn">Route</span><span class="p">.</span><span class="n">builder</span>
    <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">buildProxy</span><span class="p">&lt;</span><span class="nc">IPublicAccountApi</span><span class="p">&gt;</span></code></pre></figure>

<p>I know need to add a subscription in the elmish app to get current logged in user.</p>

<p>To accomplish this I first added two subtypes to the <code class="language-plaintext highlighter-rouge">Msg</code></p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">Msg</span> <span class="p">=</span>
    <span class="p">|</span> <span class="nc">ToggleBurger</span>
    <span class="p">|</span> <span class="nc">UserInformationRequired</span>
    <span class="p">|</span> <span class="nc">UserInformationFetched</span> <span class="k">of</span> <span class="kt">string</span> <span class="n">option</span>
    <span class="p">|</span> <span class="nc">ReceivedLocationDetail</span> <span class="k">of</span> <span class="nc">LocationDetailModel</span>
    <span class="p">|</span> <span class="nc">BrowsePageFilterChanged</span> <span class="k">of</span> <span class="nc">BrowsePageFilterChange</span>
    <span class="p">|</span> <span class="nc">ReceivedBrowsePageResult</span> <span class="k">of</span> <span class="nc">BrowsePageModel</span>
    <span class="p">|</span> <span class="nc">LocationDetailUpdated</span> <span class="k">of</span> <span class="nc">LocationDetailUpdate</span>
    <span class="p">|</span> <span class="nc">LocationDetailUpdateServerResponseReceived</span> <span class="k">of</span> <span class="nc">LocationDetailModel</span> <span class="p">*</span> <span class="nc">UpdateLocationDetailState</span></code></pre></figure>

<p>Then I added the logic to respond to the messages.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">update</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nc">Msg</span><span class="p">)</span> <span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nc">Model</span><span class="p">)</span> <span class="p">:</span> <span class="nc">Model</span> <span class="p">*</span> <span class="nc">Cmd</span><span class="p">&lt;</span><span class="nc">Msg</span><span class="p">&gt;</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">msg</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="nc">PageModel</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">ToggleBurger</span><span class="p">,</span> <span class="p">_</span> <span class="p">-&gt;</span>
        <span class="p">{</span> <span class="n">model</span> <span class="k">with</span>
              <span class="nc">MenuBurgerExpanded</span> <span class="p">=</span> <span class="k">not</span> <span class="n">model</span><span class="p">.</span><span class="nc">MenuBurgerExpanded</span> <span class="o">},</span>
        <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
    <span class="p">|</span> <span class="nc">UserInformationRequired</span> <span class="o">,_</span> <span class="p">-&gt;</span>
        <span class="n">model</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="nn">OfAsync</span><span class="p">.</span><span class="n">perform</span> <span class="n">publicAccountApi</span><span class="p">.</span><span class="n">getCurrentUser</span> <span class="bp">()</span> <span class="nc">UserInformationFetched</span>
    <span class="p">|</span> <span class="nc">UserInformationFetched</span> <span class="n">u</span><span class="p">,</span> <span class="p">_</span> <span class="p">-&gt;</span>
        <span class="p">{</span> <span class="n">model</span> <span class="k">with</span>
              <span class="nc">CurrentUser</span> <span class="p">=</span> <span class="n">u</span> <span class="o">},</span>
        <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
    <span class="p">|</span> <span class="nc">ReceivedLocationDetail</span> <span class="n">d</span><span class="p">,</span> <span class="p">_</span> <span class="p">-&gt;</span>
        <span class="n">modelWithNewPageModel</span>
        <span class="o">...</span></code></pre></figure>

<p>I then registered a timer like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">userInformationUpdateRequired</span> <span class="n">initial</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">sub</span> <span class="n">dispatch</span><span class="p">=</span>
        <span class="n">window</span><span class="p">.</span><span class="n">setInterval</span><span class="o">((</span><span class="k">fun</span> <span class="p">_</span> <span class="p">-&gt;</span>
            <span class="n">dispatch</span> <span class="p">(</span><span class="nc">UserInformationRequired</span><span class="o">)),</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="n">ignore</span>
    <span class="nn">Cmd</span><span class="p">.</span><span class="n">ofSub</span> <span class="n">sub</span>

<span class="nn">Program</span><span class="p">.</span><span class="n">mkProgram</span> <span class="nn">Index</span><span class="p">.</span><span class="n">init</span> <span class="nn">Index</span><span class="p">.</span><span class="n">update</span> <span class="nn">Index</span><span class="p">.</span><span class="n">view</span>
<span class="p">|&gt;</span> <span class="nn">Program</span><span class="p">.</span><span class="n">withSubscription</span> <span class="n">userInformationUpdateRequired</span>
<span class="p">|&gt;</span> <span class="nn">Program</span><span class="p">.</span><span class="n">toNavigable</span> <span class="p">(</span><span class="n">parseHash</span> <span class="n">clientRouter</span><span class="p">)</span> <span class="n">urlUpdate</span>
<span class="p">#</span><span class="k">if</span> <span class="nc">DEBUG</span>
<span class="p">|&gt;</span> <span class="nn">Program</span><span class="p">.</span><span class="n">withConsoleTrace</span>
<span class="p">#</span><span class="n">endif</span>
<span class="p">|&gt;</span> <span class="nn">Program</span><span class="p">.</span><span class="n">withReactSynchronous</span> <span class="s2">"elmish-app"</span>
<span class="p">#</span><span class="k">if</span> <span class="nc">DEBUG</span>
<span class="p">|&gt;</span> <span class="nn">Program</span><span class="p">.</span><span class="n">withDebugger</span>
<span class="p">#</span><span class="n">endif</span>
<span class="p">|&gt;</span> <span class="nn">Program</span><span class="p">.</span><span class="n">run</span></code></pre></figure>

<p>Note this had to go above the Program.toNavigable. If the subscription is added after hte <code class="language-plaintext highlighter-rouge">toNavigatable</code> the type passed to the dispatch is incorrect.</p>

<p>This now loads and runs but the Api requests fail with: <code class="language-plaintext highlighter-rouge">"Protocol definition must be encoded as a record type. The input type 'FSharpFunc</code><code class="language-plaintext highlighter-rouge">2'</code> was not a record.”<code class="language-plaintext highlighter-rouge"> This is because the Api need to return a fully defined type and not an </code>option string`.</p>

<p>The shared <code class="language-plaintext highlighter-rouge">DataTransferFormats</code> I added <code class="language-plaintext highlighter-rouge">CurrentUserLoginStatusResponse</code>:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">CurrentUserLoginStatusResponse</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="nc">CurrentlyLoggedIn</span><span class="p">:</span> <span class="kt">bool</span>
        <span class="nc">CurrentUserId</span><span class="p">:</span> <span class="kt">string</span> <span class="n">option</span>
        <span class="nc">CurrentUserName</span><span class="p">:</span> <span class="kt">string</span> <span class="n">option</span>
    <span class="p">}</span></code></pre></figure>

<p>In authorization I updated the function to pull information from the context:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">userInformationFromContext</span> <span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">nameClaim</span> <span class="p">=</span>
        <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Security</span><span class="p">.</span><span class="nn">Claims</span><span class="p">.</span><span class="nc">Claim</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">Type</span> <span class="p">=</span> <span class="s2">"playerName"</span><span class="p">)</span> <span class="n">ctx</span><span class="p">.</span><span class="nn">User</span><span class="p">.</span><span class="nc">Claims</span>
        <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">toList</span>

    <span class="k">let</span> <span class="n">idClaim</span> <span class="p">=</span>
        <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Security</span><span class="p">.</span><span class="nn">Claims</span><span class="p">.</span><span class="nc">Claim</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">Type</span> <span class="p">=</span> <span class="s2">"playerId"</span><span class="p">)</span> <span class="n">ctx</span><span class="p">.</span><span class="nn">User</span><span class="p">.</span><span class="nc">Claims</span>
        <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">toList</span>

    <span class="k">match</span> <span class="n">nameClaim</span><span class="p">,</span> <span class="n">idClaim</span> <span class="k">with</span>
    <span class="p">|</span> <span class="p">[</span> <span class="n">x</span> <span class="o">],</span> <span class="p">[</span> <span class="n">y</span> <span class="p">]</span> <span class="p">-&gt;</span>
        <span class="p">{</span> <span class="nc">CurrentlyLoggedIn</span> <span class="p">=</span> <span class="bp">true</span>
          <span class="nc">CurrentUserId</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">y</span><span class="p">.</span><span class="nc">Value</span>
          <span class="nc">CurrentUserName</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">x</span><span class="p">.</span><span class="nc">Value</span> <span class="p">}</span>
    <span class="p">|</span> <span class="bp">[]</span><span class="p">,</span> <span class="p">[</span> <span class="n">y</span> <span class="p">]</span> <span class="p">-&gt;</span>
        <span class="p">{</span> <span class="nc">CurrentlyLoggedIn</span> <span class="p">=</span> <span class="bp">true</span>
          <span class="nc">CurrentUserId</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">y</span><span class="p">.</span><span class="nc">Value</span>
          <span class="nc">CurrentUserName</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">y</span><span class="p">.</span><span class="nc">Value</span> <span class="p">}</span>
    <span class="p">|</span> <span class="o">_,</span> <span class="p">_</span> <span class="p">-&gt;</span>
        <span class="p">{</span> <span class="nc">CurrentlyLoggedIn</span> <span class="p">=</span> <span class="bp">false</span>
          <span class="nc">CurrentUserId</span> <span class="p">=</span> <span class="nc">None</span>
          <span class="nc">CurrentUserName</span> <span class="p">=</span> <span class="nc">None</span> <span class="p">}</span></code></pre></figure>

<p>I updated the apis to return this type.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">IPublicAccountApi</span> <span class="p">=</span>
    <span class="p">{</span> <span class="n">getCurrentUser</span><span class="p">:</span> <span class="kt">unit</span> <span class="p">-&gt;</span> <span class="nc">Async</span><span class="p">&lt;</span><span class="nc">CurrentUserLoginStatusResponse</span><span class="p">&gt;</span> <span class="p">}</span>

<span class="k">type</span> <span class="nc">ISecureAccountApi</span> <span class="p">=</span>
    <span class="p">{</span> <span class="n">login</span><span class="p">:</span> <span class="kt">unit</span> <span class="p">-&gt;</span> <span class="nc">Async</span><span class="p">&lt;</span><span class="nc">CurrentUserLoginStatusResponse</span><span class="p">&gt;</span> <span class="p">}</span></code></pre></figure>

<p>And implemented it with:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">generalPurposeApi</span> <span class="n">ctx</span> <span class="p">=</span>
    <span class="p">{</span> <span class="n">getCurrentUser</span> <span class="p">=</span> <span class="k">fun</span> <span class="kt">unit</span> <span class="p">-&gt;</span> <span class="n">async</span> <span class="p">{</span> <span class="k">return</span> <span class="n">userInformationFromContext</span> <span class="n">ctx</span> <span class="p">}</span> <span class="p">}</span>

<span class="k">let</span> <span class="n">accountInformationApi</span> <span class="n">ctx</span> <span class="p">=</span>
    <span class="p">{</span> <span class="n">login</span> <span class="p">=</span> <span class="k">fun</span> <span class="kt">unit</span> <span class="p">-&gt;</span> <span class="n">async</span> <span class="p">{</span> <span class="k">return</span> <span class="n">userInformationFromContext</span> <span class="n">ctx</span> <span class="p">}</span> <span class="p">}</span></code></pre></figure>

<p>This now loads and runs but the Api requests fails with the same error: <code class="language-plaintext highlighter-rouge">"Protocol definition must be encoded as a record type. The input type 'FSharpFunc</code><code class="language-plaintext highlighter-rouge">2'</code> was not a record.”`</p>

<p>It turns out I was mistaken about hte reason for the error. I just had a typo in my buildApi methods. I needed to change them to:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="n">s</span>
<span class="k">let</span> <span class="n">buildSecureAccountApi</span> <span class="n">next</span> <span class="n">ctx</span> <span class="p">=</span>
    <span class="n">task</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">handler</span> <span class="p">=</span>
            <span class="nn">Remoting</span><span class="p">.</span><span class="n">createApi</span> <span class="bp">()</span>
            <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">withRouteBuilder</span> <span class="nn">Route</span><span class="p">.</span><span class="n">builderWithoutApiPrefix</span>
            <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">fromValue</span> <span class="p">(</span><span class="n">accountInformationApi</span> <span class="n">ctx</span><span class="p">)</span>
            <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">buildHttpHandler</span>

        <span class="k">return</span><span class="o">!</span> <span class="n">handler</span> <span class="n">next</span> <span class="n">ctx</span>
    <span class="p">}</span>

<span class="k">let</span> <span class="n">buildPublicAccountApi</span> <span class="n">next</span> <span class="n">ctx</span> <span class="p">=</span>
    <span class="n">task</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">handler</span> <span class="p">=</span>
            <span class="nn">Remoting</span><span class="p">.</span><span class="n">createApi</span> <span class="bp">()</span>
            <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">withRouteBuilder</span> <span class="nn">Route</span><span class="p">.</span><span class="n">builderWithoutApiPrefix</span>
            <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">fromValue</span> <span class="p">(</span><span class="n">accountPublishApi</span> <span class="n">ctx</span><span class="p">)</span>
            <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">buildHttpHandler</span>

        <span class="k">return</span><span class="o">!</span> <span class="n">handler</span> <span class="n">next</span> <span class="n">ctx</span>
    <span class="p">}</span></code></pre></figure>

<p>Now it is running correctly.</p>

<p>I then had to add the logic to actually login and logout of the site as normal paths on the server</p>

<p>In the <code class="language-plaintext highlighter-rouge">Server</code> I updated:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">routes</span> <span class="p">:</span> <span class="nc">HttpFunc</span> <span class="p">-&gt;</span> <span class="nc">HttpContext</span> <span class="p">-&gt;</span> <span class="nc">HttpFuncResult</span> <span class="p">=</span>
    <span class="n">choose</span> <span class="p">[</span> <span class="n">route</span> <span class="s2">"/login"</span>  <span class="o">&gt;=&gt;</span> <span class="p">(</span><span class="n">authChallenge</span> <span class="o">&gt;=&gt;</span> <span class="n">redirectTo</span> <span class="bp">false</span> <span class="s2">"/"</span><span class="p">)</span>
             <span class="n">route</span> <span class="s2">"/signout"</span> <span class="o">&gt;=&gt;</span> <span class="n">signOut</span> <span class="o">&gt;=&gt;</span>   <span class="n">htmlString</span> <span class="s2">"Logged Out."</span>
             <span class="n">subRoute</span> <span class="s2">"/api"</span> <span class="p">(</span><span class="n">buildLocationApi</span><span class="p">)</span>
             <span class="o">...</span></code></pre></figure>

<p>Under authentication I added</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">signOut</span> <span class="p">(</span><span class="n">next</span> <span class="p">:</span> <span class="nc">HttpFunc</span><span class="p">)</span> <span class="p">(</span><span class="n">ctx</span> <span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span> <span class="p">=</span>
  <span class="n">task</span> <span class="p">{</span>
    <span class="k">do</span><span class="o">!</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">SignOutAsync</span><span class="bp">()</span>
    <span class="k">return</span><span class="o">!</span> <span class="n">next</span> <span class="n">ctx</span>
  <span class="p">}</span></code></pre></figure>

<p>I then added the <code class="language-plaintext highlighter-rouge">login</code>, <code class="language-plaintext highlighter-rouge">logout</code> and <code class="language-plaintext highlighter-rouge">signin-oidc</code> paths to the webpack proxy for the dev server.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var CONFIG = {
    // The tags to include the generated JS and CSS will be automatically injected in the HTML template
    // See https://github.com/jantimon/html-webpack-plugin
    indexHtmlTemplate: './src/Client/index.html',
    fsharpEntry: './src/Client/App.fs.js',
    outputDir: './deploy/public',
    assetsDir: './src/Client/public',
    devServerPort: 8080,
    // When using webpack-dev-server, you may need to redirect some calls
    // to a external API server. See https://webpack.js.org/configuration/dev-server/#devserver-proxy
    devServerProxy: {
        // redirect requests that start with /api/ to the server on port 8085
        '/api/**': {
            target: 'http://localhost:' + (process.env.SERVER_PROXY_PORT || "8085"),
            changeOrigin: true
        },
        // redirect websocket requests that start with /socket/ to the server on the port 8085
        '/socket/**': {
            target: 'http://localhost:' + (process.env.SERVER_PROXY_PORT || "8085"),
            ws: true
        },
        // redirect websocket requests that start with /socket/ to the server on the port 8085
        '/login**': {
            target: 'http://localhost:' + (process.env.SERVER_PROXY_PORT || "8085"),
            changeOrigin: true
        },
        // redirect websocket requests that start with /socket/ to the server on the port 8085
        '/logout**': {
            target: 'http://localhost:' + (process.env.SERVER_PROXY_PORT || "8085"),
            changeOrigin: true
        },
        // redirect websocket requests that start with /socket/ to the server on the port 8085
        '/signin-oidc**': {
            target: 'http://localhost:' + (process.env.SERVER_PROXY_PORT || "8085"),
            changeOrigin: true
        }
    }
}
</code></pre></div></div>

<p>I then added the html to render the login/register or logout.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">    <span class="k">let</span> <span class="n">navBarLoginContent</span> <span class="p">=</span>
        <span class="k">match</span> <span class="n">model</span><span class="p">.</span><span class="nc">CurrentUser</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span>
            <span class="p">[</span> <span class="nn">Bulma</span><span class="p">.</span><span class="n">navbarItem</span><span class="p">.</span><span class="n">div</span> <span class="p">[</span> <span class="nn">Bulma</span><span class="p">.</span><span class="n">buttons</span> <span class="p">[</span> <span class="nn">Bulma</span><span class="p">.</span><span class="n">button</span><span class="p">.</span><span class="n">a</span> <span class="p">[</span> <span class="n">prop</span><span class="p">.</span><span class="n">text</span> <span class="s2">"Login or Register"</span><span class="p">;</span> <span class="n">prop</span><span class="p">.</span><span class="n">href</span> <span class="s2">"/login"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
        <span class="p">|</span> <span class="nc">Some</span> <span class="n">s</span> <span class="p">-&gt;</span>  <span class="p">[</span> <span class="nn">Bulma</span><span class="p">.</span><span class="n">navbarItem</span><span class="p">.</span><span class="n">div</span> <span class="p">[</span> <span class="nn">Bulma</span><span class="p">.</span><span class="n">buttons</span> <span class="p">[</span> <span class="nn">Bulma</span><span class="p">.</span><span class="n">button</span><span class="p">.</span><span class="n">a</span> <span class="p">[</span> <span class="n">prop</span><span class="p">.</span><span class="n">text</span> <span class="s2">"Logout"</span><span class="p">;</span> <span class="n">prop</span><span class="p">.</span><span class="n">href</span> <span class="s2">"/logout"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span></code></pre></figure>

<p>I am now brought to Okta to login but when it completes the redirect page is broken.</p>

<p>` The cookie ‘.AspNetCore.OpenIdConnect.Nonce… has set ‘SameSite=None’ and must also set ‘Secure’.`</p>

<p>I was able to update the cookie settings like so</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nn">Saturn</span><span class="p">.</span><span class="nn">Application</span><span class="p">.</span><span class="nc">ApplicationBuilder</span> <span class="k">with</span>
    <span class="p">[&lt;</span><span class="nc">CustomOperation</span><span class="p">(</span><span class="s2">"use_open_id_auth_with_config_from_service_collection"</span><span class="o">)&gt;]</span>
    <span class="k">member</span> <span class="o">__.</span><span class="nc">UseOpenIdAuthWithConfigFromServiceCollection</span>
        <span class="p">(</span>
            <span class="n">state</span><span class="p">:</span> <span class="nc">ApplicationState</span><span class="p">,</span>
            <span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nc">IServiceCollection</span> <span class="p">-&gt;</span> <span class="nc">Action</span><span class="p">&lt;</span><span class="nn">OpenIdConnect</span><span class="p">.</span><span class="nc">OpenIdConnectOptions</span><span class="o">&gt;)</span>
        <span class="p">)</span> <span class="p">=</span>
        <span class="k">let</span> <span class="n">middleware</span> <span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="nc">IApplicationBuilder</span><span class="p">)</span> <span class="p">=</span> <span class="n">app</span><span class="p">.</span><span class="nc">UseAuthentication</span><span class="bp">()</span>

        <span class="k">let</span> <span class="n">service</span> <span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nc">IServiceCollection</span><span class="p">)</span> <span class="p">=</span>
            <span class="k">let</span> <span class="n">authBuilder</span> <span class="p">=</span>
                <span class="n">s</span><span class="p">.</span><span class="nc">AddAuthentication</span>
                    <span class="p">(</span><span class="k">fun</span> <span class="n">authConfig</span> <span class="p">-&gt;</span>
                        <span class="n">authConfig</span><span class="p">.</span><span class="nc">DefaultScheme</span> <span class="p">&lt;-</span> <span class="nn">CookieAuthenticationDefaults</span><span class="p">.</span><span class="nc">AuthenticationScheme</span>
                        <span class="n">authConfig</span><span class="p">.</span><span class="nc">DefaultChallengeScheme</span> <span class="p">&lt;-</span> <span class="nn">OpenIdConnectDefaults</span><span class="p">.</span><span class="nc">AuthenticationScheme</span>
                        <span class="n">authConfig</span><span class="p">.</span><span class="nc">DefaultSignInScheme</span> <span class="p">&lt;-</span> <span class="nn">CookieAuthenticationDefaults</span><span class="p">.</span><span class="nc">AuthenticationScheme</span>
                        <span class="p">)</span>

            <span class="k">if</span> <span class="k">not</span> <span class="n">state</span><span class="p">.</span><span class="nc">CookiesAlreadyAdded</span> <span class="k">then</span>
                <span class="n">authBuilder</span><span class="p">.</span><span class="nc">AddCookie</span><span class="o">((</span><span class="k">fun</span> <span class="n">opt</span> <span class="p">-&gt;</span>
                                                  <span class="n">opt</span><span class="p">.</span><span class="nn">Cookie</span><span class="p">.</span><span class="nc">SameSite</span> <span class="p">&lt;-</span> <span class="nn">SameSiteMode</span><span class="p">.</span><span class="nc">Lax</span>
                                                  <span class="n">opt</span><span class="p">.</span><span class="nn">Cookie</span><span class="p">.</span><span class="nc">SecurePolicy</span> <span class="p">&lt;-</span> <span class="nn">CookieSecurePolicy</span><span class="p">.</span><span class="nc">None</span>
                                                  <span class="n">opt</span><span class="p">.</span><span class="nn">Cookie</span><span class="p">.</span><span class="nc">IsEssential</span> <span class="p">&lt;-</span> <span class="bp">true</span> <span class="o">))</span> <span class="p">|&gt;</span> <span class="n">ignore</span>

            <span class="n">authBuilder</span><span class="p">.</span><span class="nc">AddOpenIdConnect</span><span class="p">(</span><span class="nn">OpenIdConnectDefaults</span><span class="p">.</span><span class="nc">AuthenticationScheme</span><span class="p">,</span> <span class="p">(</span><span class="n">config</span> <span class="n">s</span><span class="o">))</span>
            <span class="p">|&gt;</span> <span class="n">ignore</span>

            <span class="n">s</span>

        <span class="p">{</span> <span class="n">state</span> <span class="k">with</span>
              <span class="nc">ServicesConfig</span> <span class="p">=</span> <span class="n">service</span> <span class="p">::</span> <span class="n">state</span><span class="p">.</span><span class="nc">ServicesConfig</span>
              <span class="nc">AppConfigs</span> <span class="p">=</span> <span class="n">middleware</span> <span class="p">::</span> <span class="n">state</span><span class="p">.</span><span class="nc">AppConfigs</span>
              <span class="nc">CookiesAlreadyAdded</span> <span class="p">=</span> <span class="bp">true</span> <span class="p">}</span></code></pre></figure>

<p>I am still getting an error ` cookie not found.`. I am thinking this is because the url/ ip generated for the redirect is at port 8085 while the client is being served by webpack at 8080. i.e. Webpack is proxying the request to the server @ 8085 which uses the cookie info from 8080 and the port from the server instance to create the request to Okta. Okta is then redirecting back to 8085 which is unable to find the cookie from the client port.</p>

<p>I tried enabling forwarded headers in asp.net:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">        <span class="k">let</span> <span class="n">service</span> <span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nc">IServiceCollection</span><span class="p">)</span> <span class="p">=</span>
            <span class="n">s</span><span class="p">.</span><span class="nc">Configure</span><span class="p">&lt;</span><span class="nc">ForwardedHeadersOptions</span><span class="o">&gt;(</span><span class="k">fun</span> <span class="p">(</span><span class="n">options</span><span class="p">:</span><span class="nc">ForwardedHeadersOptions</span><span class="p">)</span> <span class="p">-&gt;</span>
                <span class="n">options</span><span class="p">.</span><span class="nc">ForwardedHeaders</span> <span class="p">&lt;-</span> <span class="nn">ForwardedHeaders</span><span class="p">.</span><span class="nc">All</span>
                <span class="n">options</span><span class="p">.</span><span class="nn">KnownNetworks</span><span class="p">.</span><span class="nc">Clear</span><span class="bp">()</span> <span class="p">|&gt;</span> <span class="n">ignore</span>
                <span class="n">options</span><span class="p">.</span><span class="nn">KnownProxies</span><span class="p">.</span><span class="nc">Clear</span><span class="bp">()</span> <span class="p">|&gt;</span> <span class="n">ignore</span>
            <span class="p">)</span> <span class="p">|&gt;</span> <span class="n">ignore</span>
            
            <span class="k">let</span> <span class="n">authBuilder</span> <span class="p">=</span>
            <span class="o">...</span></code></pre></figure>

<p>This did not do what was needed. I am assuming I also need to configure WebPack to set forward headers.</p>

<p>After updating Webpack to forward headers it still was not working. After reading a lot of blog posts I found that that issue was</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">addAuth</span> <span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="nc">IApplicationBuilder</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">app</span><span class="p">.</span><span class="nc">UseCookiePolicy</span><span class="p">(</span><span class="k">new</span> <span class="nc">CookiePolicyOptions</span><span class="p">(</span><span class="nc">MinimumSameSitePolicy</span><span class="p">=</span><span class="nn">SameSiteMode</span><span class="p">.</span><span class="nc">Lax</span><span class="p">,</span><span class="nc">Secure</span><span class="p">=</span><span class="nn">CookieSecurePolicy</span><span class="p">.</span><span class="nc">None</span><span class="o">)).</span><span class="nc">UseAuthentication</span><span class="bp">()</span></code></pre></figure>

<p>which was being called last in the ApplicationBuilder, this was wiping out the cookies. I removed the line and it started to work in firefox but not in Chrome.</p>

<h2 id="results">Results</h2>

<p><a href="https://github.com/jamesclancy/WilkensAvenue/tree/step-19">Git branch for this step</a></p>

</div>


<div class="related">
  <h2>Related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/bookreviews/2022/09/16/Redshirts/">
            Redshirts by John-Scalzi
            <small>16 Sep 2022</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/bookreviews/2022/09/02/ThomasJeffersonTripoliPirates/">
            Thomas Jefferson and the Tripoli Pirates by Brian Kilmeade
            <small>02 Sep 2022</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/bookreviews/2022/08/24/DestinyDisrupted/">
            Destiny Disrupted - A History of the World Through Islamic Eyes by Tamim Ansary
            <small>24 Aug 2022</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
