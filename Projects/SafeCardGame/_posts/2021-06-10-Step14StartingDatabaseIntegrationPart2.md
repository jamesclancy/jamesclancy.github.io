---
layout: post
title: SafeCardGame - Step 14 - More Persistance and an API
author: James Clancy
tags: fsharp dotnet
---

## More Persistance and an API

I am going to try to save my data in Postgresq which I will hopefully be running a docker container.

First I installed [DBeaver|https://dbeaver.io/download/] to administer/ access the new Postgres instance.

I then ran

```
docker pull postgres
mkdir c:/data/safecardgamepostgresqldata
docker run -d --name dev-postgres -e POSTGRES_PASSWORD=trident1814 -v c:/data/safecardgamepostgresqldata/:/var/lib/postgresql/data -p 5432:5432 postgres

```


I was then able to connect to this Postgres instance via DBever and create two tables with the definitions:

```
CREATE TABLE public.card (
	card_id varchar(256) NOT NULL,
	card_name varchar(256) NOT NULL,
	card_description varchar(500) NULL,
	card_image_url varchar(500) NOT NULL,
	card_thumbnail_image_url varchar(500) NOT NULL,
	card_primary_resource varchar(256) NOT NULL,
    card_type varchar(256) NOT NULL,
    card_enter_special_effects varchar NULL,
    card_exit_special_effects varchar NULL,
    card_creature_health int NULL,
    card_creature_weaknesses varchar NULL,
    card_creature_attacks varchar NULL,
    card_resources_available_on_first_turn bit NULL,
    card_resources_added  varchar NULL,
	CONSTRAINT card_pk PRIMARY KEY (card_id),
	CONSTRAINT card_unique_name UNIQUE (card_name)
);

CREATE TABLE public.player (
	player_id varchar(256) NOT NULL,
	player_name varchar(256) NOT NULL,
	player_playmat_url varchar(500) NULL,
	CONSTRAINT player_pk PRIMARY KEY (player_id),
	CONSTRAINT player_unique_name UNIQUE (player_name)
);
```

After this, I added `Npgsql.FSharp` to the Server project by running `dotnet add package Npgsql.FSharp`.

using this library I was able to add a module to my Server project named: `DatabaseRepositories`.

In this module, I defined two repositories, a `CardRepository` and a `PlayerRepository` each includes methods to map DTOs to the database table row, a select all, and a select by id.

I then pulled some other TCG card data in JSON and transformed that into a CSV file that matched the database and imported it (not included in the repo but you can find similar on google/github).

I also added a deck_card_association and deck SQL tables.

```
CREATE TABLE public.deck_card_association (
    deck_card_association int GENERATED BY DEFAULT AS IDENTITY,
	deck_id varchar(256) NOT NULL,
	card_id varchar(256) NOT NULL,
    CONSTRAINT deck_card_association_fk_deck FOREIGN KEY(deck_id) REFERENCES deck(deck_id),
    CONSTRAINT deck_card_association_fk_card FOREIGN KEY(card_id) REFERENCES card(card_id)
);

CREATE TABLE public.deck (
	deck_id varchar(256) NOT NULL,
	deck_name varchar(256) NOT NULL,
	deck_description varchar(500) NULL,
	deck_image_url varchar(500) NULL,
	deck_thumbnail_image_url varchar(500) NULL,
	deck_primary_resource varchar(256) NOT NULL,
    deck_owner varchar(256) NULL,
    deck_private boolean NOT NULL,
	CONSTRAINT deck_pk PRIMARY KEY (deck_id),
	CONSTRAINT deck_unique_name UNIQUE (deck_name),
    CONSTRAINT deck_fk_owner FOREIGN KEY(deck_owner) REFERENCES player(player_id)
);


```

I then similarly bulk pulled some JSON info for an existing TCG game and added it to the database.

I now will have to implement a deck repository and APIs.

These I will implement in the next part.

I am leaving this as the final commit in branch `step-14-continue-working-on-saving-to-db`.

[Git branch for this step](https://github.com/jamesclancy/SafeCardGame/tree/step-14-continue-working-on-saving-to-db)