<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      James Clancy &middot; This needs to be reorganized in the future.
    
  </title>

  
  <link rel="canonical" href="/page12/">
  

  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6FZ90LRCT8"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-6FZ90LRCT8');
    </script>
  
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Largely a mess of content. The idea is to generate content then refine sometime in the future.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item active" href="/">Home</a>
    








  
  
  

  
    

    

    
    

        

        
        <a class="sidebar-nav-item" href="/categories/bookreviews/">
          BookReviews
          (<span class="text-muted small font-weight-light">
              77
              
          </span>)
        </a>

        <!-- content count -->


    


    

  

  
  
  

  
    

    

    
    

        

        
        <a class="sidebar-nav-item" href="/categories/general/">
          General
          (<span class="text-muted small font-weight-light">
              2
              
          </span>)
        </a>

        <!-- content count -->


    


    

  

  
  
  

  

  
  
  

  
    

    

    
    

        

        
        <a class="sidebar-nav-item" href="/categories/projects/">
          Projects
          (<span class="text-muted small font-weight-light">
              38
              
          </span>)
        </a>

        <!-- content count -->


    
        
          
          
          <a class="sidebar-nav-item" 
              href="/categories/kafkaui/" style="padding-left:60px;">KafkaUI (<span class="text-muted small font-weight-light">
                1
                
              </span>)</a>

          
        
          
          
          <a class="sidebar-nav-item" 
              href="/categories/safecardgame/" style="padding-left:60px;">SafeCardGame (<span class="text-muted small font-weight-light">
                17
                
              </span>)</a>

          
        
          
          
          <a class="sidebar-nav-item" 
              href="/categories/wilkensavenue/" style="padding-left:60px;">WilkensAvenue (<span class="text-muted small font-weight-light">
                20
                
              </span>)</a>

          
        
    


    

  

  
  
  

  
    

    

    
    

        

        
        <a class="sidebar-nav-item" href="/categories/recipes/">
          Recipes
          (<span class="text-muted small font-weight-light">
              16
              
          </span>)
        </a>

        <!-- content count -->


    


    

  

  
  
  

  

  
  
  

  




  </nav>


<div class="sidebar-item">
  <p>
<a href="/about">About</a> | 
<a href="https://github.com/jamesclancy" aria-label="github" target="_blank" rel="noopener"> 
  <i class="fab fa-github-alt"></i> Github </a> | 
<a href="/feed.xml" aria-label="rss"> <i class="fas fa-rss"></i> RSS </a>
    </p>
    <p>
      &copy; 2022. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">James Clancy</a>
            <small>This needs to be reorganized in the future.</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/projects/safecardgame/2021/06/10/Step14StartingDatabaseIntegrationPart2/">
        SafeCardGame - Step 14 - More Persistance and an API
      </a>
    </h1>

    <span class="post-date">10 Jun 2021</span>

    <h2 id="more-persistance-and-an-api">More Persistance and an API</h2>

<p>I am going to try to save my data in Postgresq which I will hopefully be running a docker container.</p>

<table>
  <tbody>
    <tr>
      <td>First I installed [DBeaver</td>
      <td>https://dbeaver.io/download/] to administer/ access the new Postgres instance.</td>
    </tr>
  </tbody>
</table>

<p>I then ran</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull postgres
mkdir c:/data/safecardgamepostgresqldata
docker run -d --name dev-postgres -e POSTGRES_PASSWORD=WHATEVERPASSWORDYOUWANT -v c:/data/safecardgamepostgresqldata/:/var/lib/postgresql/data -p 5432:5432 postgres
</code></pre></div></div>

<p>I was then able to connect to this Postgres instance via DBever and create two tables with the definitions:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">public</span><span class="p">.</span><span class="n">card</span> <span class="p">(</span>
	<span class="n">card_id</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">card_name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">card_description</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">card_image_url</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">card_thumbnail_image_url</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">card_primary_resource</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">card_type</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">card_enter_special_effects</span> <span class="nb">varchar</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">card_exit_special_effects</span> <span class="nb">varchar</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">card_creature_health</span> <span class="nb">int</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">card_creature_weaknesses</span> <span class="nb">varchar</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">card_creature_attacks</span> <span class="nb">varchar</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">card_resources_available_on_first_turn</span> <span class="nb">bit</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">card_resources_added</span>  <span class="nb">varchar</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="k">CONSTRAINT</span> <span class="n">card_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">card_id</span><span class="p">),</span>
	<span class="k">CONSTRAINT</span> <span class="n">card_unique_name</span> <span class="k">UNIQUE</span> <span class="p">(</span><span class="n">card_name</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">public</span><span class="p">.</span><span class="n">player</span> <span class="p">(</span>
	<span class="n">player_id</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">player_name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">player_playmat_url</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="k">CONSTRAINT</span> <span class="n">player_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">player_id</span><span class="p">),</span>
	<span class="k">CONSTRAINT</span> <span class="n">player_unique_name</span> <span class="k">UNIQUE</span> <span class="p">(</span><span class="n">player_name</span><span class="p">)</span>
<span class="p">);</span></code></pre></figure>

<p>After this, I added <code class="language-plaintext highlighter-rouge">Npgsql.FSharp</code> to the Server project by running <code class="language-plaintext highlighter-rouge">dotnet add package Npgsql.FSharp</code>.</p>

<p>using this library I was able to add a module to my Server project named: <code class="language-plaintext highlighter-rouge">DatabaseRepositories</code>.</p>

<p>In this module, I defined two repositories, a <code class="language-plaintext highlighter-rouge">CardRepository</code> and a <code class="language-plaintext highlighter-rouge">PlayerRepository</code> each includes methods to map DTOs to the database table row, a select all, and a select by id.</p>

<p>I then pulled some other TCG card data in JSON and transformed that into a CSV file that matched the database and imported it (not included in the repo but you can find similar on google/github).</p>

<p>I also added a deck_card_association and deck SQL tables.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">public</span><span class="p">.</span><span class="n">deck_card_association</span> <span class="p">(</span>
    <span class="n">deck_card_association</span> <span class="nb">int</span> <span class="k">GENERATED</span> <span class="k">BY</span> <span class="k">DEFAULT</span> <span class="k">AS</span> <span class="k">IDENTITY</span><span class="p">,</span>
	<span class="n">deck_id</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">card_id</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">deck_card_association_fk_deck</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">deck_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">deck</span><span class="p">(</span><span class="n">deck_id</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">deck_card_association_fk_card</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">card_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">card</span><span class="p">(</span><span class="n">card_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">public</span><span class="p">.</span><span class="n">deck</span> <span class="p">(</span>
	<span class="n">deck_id</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">deck_name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">deck_description</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">deck_image_url</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">deck_thumbnail_image_url</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">deck_primary_resource</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">deck_owner</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">deck_private</span> <span class="nb">boolean</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="k">CONSTRAINT</span> <span class="n">deck_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">deck_id</span><span class="p">),</span>
	<span class="k">CONSTRAINT</span> <span class="n">deck_unique_name</span> <span class="k">UNIQUE</span> <span class="p">(</span><span class="n">deck_name</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">deck_fk_owner</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">deck_owner</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">player</span><span class="p">(</span><span class="n">player_id</span><span class="p">)</span>
<span class="p">);</span></code></pre></figure>

<p>I then similarly bulk pulled some JSON info for an existing TCG game and added it to the database.</p>

<p>I now will have to implement a deck repository and APIs.</p>

<p>These I will implement in the next part.</p>

<p>I am leaving this as the final commit in branch <code class="language-plaintext highlighter-rouge">step-14-continue-working-on-saving-to-db</code>.</p>

<p><a href="https://github.com/jamesclancy/SafeCardGame/tree/step-14-continue-working-on-saving-to-db">Git branch for this step</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/projects/safecardgame/2021/06/05/Step13StartingDatabaseIntegration/">
        SafeCardGame - Step 13 - Pushing Decks, Players, and Cards into a Database Part 1
      </a>
    </h1>

    <span class="post-date">05 Jun 2021</span>

    <p>Next, I would like a better way to come up with more complicated and complete sets of decks, players, and cards.</p>

<h2 id="pushing-decks-players-and-cards-into-a-database">Pushing Decks, Players, and Cards into a Database</h2>

<p>I am not going to try to start pulling the decks, player info, and cards from a database.</p>

<p>The first thing I am going to do for this is moving the <code class="language-plaintext highlighter-rouge">SampleCardDatabase</code> to the Shared project from the Client project.</p>

<p>Now I am researching ways to store the information on the server-side.</p>

<p>The first step appears to be mapping to and from a DTO. To start this I added a Dto module to the Shared project.</p>

<p>I am going to be creating DTOs for each of the domain types and writing functions to map from the DTOs to the Domain models.</p>

<p>I started doing this with the idea of documenting the process I was going through. This turned into quite a bit of code but generally, I was creating Dtos for each domain type and adding a module for that class with <code class="language-plaintext highlighter-rouge">fromDomain</code> and <code class="language-plaintext highlighter-rouge">toDomain</code> functions which map to the DTO and to a Result&lt;the domain type, string&gt; type. I implemented them like</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">module</span> <span class="nc">Player</span> <span class="p">=</span>

    <span class="k">let</span> <span class="n">fromDomain</span> <span class="p">(</span><span class="n">person</span><span class="p">:</span><span class="nn">Domain</span><span class="p">.</span><span class="nc">Player</span><span class="p">)</span> <span class="p">:</span> <span class="nc">PlayerDto</span> <span class="p">=</span>
       <span class="p">{</span>
           <span class="nc">PlayerId</span> <span class="p">=</span> <span class="n">person</span><span class="p">.</span><span class="nn">PlayerId</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>
           <span class="nc">Name</span> <span class="p">=</span> <span class="n">person</span><span class="p">.</span><span class="nc">Name</span>
           <span class="nc">PlaymatUrl</span> <span class="p">=</span> <span class="n">person</span><span class="p">.</span><span class="nn">PlaymatUrl</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>
           <span class="nc">LifePoints</span> <span class="p">=</span> <span class="n">person</span><span class="p">.</span><span class="nc">RemainingLifePoints</span>
       <span class="o">}:</span> <span class="nc">PlayerDto</span>

    <span class="k">let</span> <span class="n">toDomain</span> <span class="p">(</span><span class="n">dto</span><span class="p">:</span> <span class="nc">PlayerDto</span><span class="p">)</span> <span class="p">:</span><span class="nc">Result</span><span class="p">&lt;</span><span class="nn">Domain</span><span class="p">.</span><span class="nc">Player</span><span class="p">,</span><span class="kt">string</span><span class="p">&gt;</span> <span class="p">=</span>
        <span class="nn">CollectionManipulation</span><span class="p">.</span><span class="n">result</span> <span class="p">{</span>
            <span class="k">let</span><span class="o">!</span> <span class="n">playerId</span> <span class="p">=</span> <span class="n">dto</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">|&gt;</span> <span class="nn">NonEmptyString</span><span class="p">.</span><span class="n">build</span>
            <span class="k">let</span><span class="o">!</span> <span class="n">name</span> <span class="p">=</span> <span class="n">dto</span><span class="p">.</span><span class="nc">Name</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>
            <span class="k">let</span><span class="o">!</span> <span class="n">playmatUrl</span> <span class="p">=</span> <span class="n">dto</span><span class="p">.</span><span class="nc">PlaymatUrl</span> <span class="p">|&gt;</span> <span class="nn">ImageUrlString</span><span class="p">.</span><span class="n">build</span>
            <span class="k">let</span><span class="o">!</span> <span class="n">lifePoints</span> <span class="p">=</span> <span class="n">dto</span><span class="p">.</span><span class="nc">LifePoints</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>

            <span class="k">return</span> <span class="p">{</span>
               <span class="nc">PlayerId</span> <span class="p">=</span> <span class="n">playerId</span> <span class="p">|&gt;</span> <span class="nc">PlayerId</span>
               <span class="nc">Name</span> <span class="p">=</span> <span class="n">name</span>
               <span class="nc">PlaymatUrl</span> <span class="p">=</span> <span class="n">playmatUrl</span>
               <span class="nc">RemainingLifePoints</span> <span class="p">=</span> <span class="n">lifePoints</span>
            <span class="p">}</span>
        <span class="p">}</span></code></pre></figure>

<p>You can note that the <code class="language-plaintext highlighter-rouge">toDomain</code> function utilizes a computational expression I had to added.</p>

<p>the computational expression is defined like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">ResultBuilder</span><span class="bp">()</span> <span class="p">=</span>
    <span class="k">member</span> <span class="o">__.</span><span class="nc">Return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">=</span> <span class="nc">Ok</span> <span class="n">x</span>
    <span class="k">member</span> <span class="o">__.</span><span class="nc">ReturnFrom</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="nc">Result</span><span class="o">&lt;_,</span> <span class="o">_&gt;)</span> <span class="p">=</span> <span class="n">m</span>
    <span class="k">member</span> <span class="o">__.</span><span class="nc">Bind</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="p">=</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="n">f</span> <span class="n">m</span>


<span class="k">let</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="nc">ResultBuilder</span><span class="bp">()</span></code></pre></figure>

<p>This <code class="language-plaintext highlighter-rouge">ResultBuilder</code> allows multiple result checks to chained together using a series of <code class="language-plaintext highlighter-rouge">let!</code> bind operations.</p>

<p>I was able to test serializing these DTOs using System.Text.Json by adding code to the Server project</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="nn">SampleCardDatabase</span><span class="p">.</span><span class="n">creatureCardDb</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">c</span><span class="p">-&gt;</span> <span class="nc">CharacterCard</span> <span class="n">c</span><span class="p">)</span>
<span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">Card</span><span class="p">.</span><span class="n">fromDomain</span>
<span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">c</span> <span class="p">-&gt;</span>
                    <span class="nn">System</span><span class="p">.</span><span class="nn">Console</span><span class="p">.</span><span class="nc">Write</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">c</span>
<span class="p">)</span>
<span class="p">|&gt;</span> <span class="nn">JsonSerializer</span><span class="p">.</span><span class="nc">Serialize</span>
<span class="p">|&gt;</span> <span class="p">(</span><span class="k">fun</span> <span class="n">c</span><span class="p">-&gt;</span> <span class="nn">System</span><span class="p">.</span><span class="nn">IO</span><span class="p">.</span><span class="nn">File</span><span class="p">.</span><span class="nc">WriteAllText</span><span class="p">(</span><span class="s2">"test.json"</span><span class="p">,</span> <span class="n">c</span><span class="o">))</span>
<span class="p">|&gt;</span> <span class="n">ignore</span></code></pre></figure>

<p>It did serialize but I noticed the CardId and other Domain Ids needed to have their <code class="language-plaintext highlighter-rouge">ToString()</code> methods overloaded like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">module</span> <span class="nc">Domain</span> <span class="p">=</span>

    <span class="k">type</span> <span class="nc">PlayerId</span> <span class="p">=</span> <span class="nc">PlayerId</span> <span class="k">of</span> <span class="nc">NonEmptyString</span>
        <span class="k">with</span> <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="p">=</span> <span class="k">match</span> <span class="n">this</span> <span class="k">with</span> <span class="nc">PlayerId</span> <span class="n">s</span> <span class="p">-&gt;</span> <span class="n">s</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>
    <span class="k">type</span> <span class="nc">CardInstanceId</span> <span class="p">=</span> <span class="nc">CardInstanceId</span> <span class="k">of</span> <span class="nc">NonEmptyString</span>
        <span class="k">with</span> <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="p">=</span> <span class="k">match</span> <span class="n">this</span> <span class="k">with</span> <span class="nc">CardInstanceId</span> <span class="n">s</span> <span class="p">-&gt;</span> <span class="n">s</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>
    <span class="k">type</span> <span class="nc">CardId</span> <span class="p">=</span> <span class="nc">CardId</span> <span class="k">of</span> <span class="nc">NonEmptyString</span>
        <span class="k">with</span> <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="p">=</span> <span class="k">match</span> <span class="n">this</span> <span class="k">with</span> <span class="nc">CardId</span> <span class="n">s</span> <span class="p">-&gt;</span> <span class="n">s</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>
    <span class="k">type</span> <span class="nc">InPlayCreatureId</span> <span class="p">=</span> <span class="nc">InPlayCreatureId</span> <span class="k">of</span> <span class="nc">NonEmptyString</span>
        <span class="k">with</span> <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="p">=</span> <span class="k">match</span> <span class="n">this</span> <span class="k">with</span> <span class="nc">InPlayCreatureId</span> <span class="n">s</span> <span class="p">-&gt;</span> <span class="n">s</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>
    <span class="k">type</span> <span class="nc">GameId</span> <span class="p">=</span> <span class="nc">GameId</span> <span class="k">of</span> <span class="nc">NonEmptyString</span>
        <span class="k">with</span> <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="p">=</span> <span class="k">match</span> <span class="n">this</span> <span class="k">with</span> <span class="nc">GameId</span> <span class="n">s</span> <span class="p">-&gt;</span> <span class="n">s</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>
        <span class="o">...</span></code></pre></figure>

<p>I am leaving this as the final commit in the branch <code class="language-plaintext highlighter-rouge">step-13-decks-to-database</code>. We were unable to actually write to a database but are able to serialize a list of cards to JSON now. This actually took an inordinate amount of time (like a week of share time) so I will continue on with this in step 14.</p>

<p><a href="https://github.com/jamesclancy/SafeCardGame/tree/step-13-decks-to-database">Git branch for this step</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/projects/safecardgame/2021/06/01/Step12ImplementingAttack/">
        SafeCardGame - Step 12 - Implementing Attack
      </a>
    </h1>

    <span class="post-date">01 Jun 2021</span>

    <h2 id="implementing-attack">Implementing Attack</h2>

<p>The next step will be to implement the attack functionality.</p>

<p>To do this I implemented several new functions:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">getPlayBoardToTargetAttack</span> <span class="p">(</span><span class="n">playerId</span> <span class="p">:</span> <span class="nc">PlayerId</span><span class="p">)</span> <span class="n">gs</span> <span class="p">=</span>
    <span class="n">playerId</span>
    <span class="p">|&gt;</span> <span class="n">gs</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">TryGetValue</span>
    <span class="p">|&gt;</span> <span class="k">function</span>
        <span class="p">|</span> <span class="bp">true</span><span class="p">,</span> <span class="n">pb</span> <span class="p">-&gt;</span> <span class="n">pb</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>
        <span class="p">|</span> <span class="o">_,</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="s2">"Unable to locate target for attack"</span> <span class="p">|&gt;</span> <span class="nc">Error</span>

<span class="k">let</span> <span class="n">activeCreatureKilledFromPlayerBoard</span> <span class="n">playBoard</span> <span class="p">:</span><span class="nc">PlayerBoard</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">playBoard</span><span class="p">.</span><span class="nc">Bench</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">None</span> <span class="p">|</span> <span class="nc">Some</span> <span class="bp">[]</span> <span class="p">-&gt;</span> <span class="p">{</span> <span class="n">playBoard</span> <span class="k">with</span> <span class="nc">ActiveCreature</span> <span class="p">=</span> <span class="nc">None</span><span class="p">}</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="p">[</span> <span class="n">x</span> <span class="p">]</span> <span class="p">-&gt;</span>  <span class="p">{</span> <span class="n">playBoard</span> <span class="k">with</span> <span class="nc">ActiveCreature</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">x</span><span class="p">;</span> <span class="nc">Bench</span> <span class="p">=</span> <span class="nc">None</span><span class="p">}</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="p">(</span><span class="n">x</span> <span class="p">::</span> <span class="n">xs</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">{</span> <span class="n">playBoard</span> <span class="k">with</span> <span class="nc">ActiveCreature</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">x</span><span class="p">;</span> <span class="nc">Bench</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">xs</span><span class="p">}</span>

<span class="k">let</span> <span class="n">applyBasicAttackToPlayBoard</span> <span class="p">(</span><span class="n">attack</span> <span class="p">:</span> <span class="nc">Attack</span><span class="p">)</span> <span class="p">(</span><span class="n">playBoard</span><span class="p">)</span> <span class="n">gs</span> <span class="p">=</span>
        <span class="k">match</span> <span class="n">playBoard</span><span class="p">.</span><span class="nc">ActiveCreature</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">Some</span> <span class="n">cre</span> <span class="k">when</span> <span class="p">(</span><span class="n">cre</span><span class="p">.</span><span class="nc">CurrentDamage</span> <span class="o">+</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Damage</span><span class="p">)</span> <span class="p">&lt;</span> <span class="n">cre</span><span class="p">.</span><span class="nc">TotalHealth</span> <span class="p">-&gt;</span>
              <span class="o">({</span>
                <span class="n">playBoard</span> <span class="k">with</span> <span class="nc">ActiveCreature</span> <span class="p">=</span>
                                    <span class="nc">Some</span> <span class="p">{</span> <span class="n">cre</span> <span class="k">with</span> <span class="nc">CurrentDamage</span> <span class="p">=</span> <span class="n">cre</span><span class="p">.</span><span class="nc">CurrentDamage</span>  <span class="o">+</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Damage</span> <span class="p">}</span>
              <span class="o">},</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sprintf</span> <span class="s2">"%i damage dealt to %s"</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Damage</span> <span class="n">cre</span><span class="p">.</span><span class="nc">Name</span><span class="p">)</span>
        <span class="p">|</span> <span class="nc">Some</span> <span class="n">cre</span> <span class="p">-&gt;</span>
            <span class="o">((</span><span class="n">activeCreatureKilledFromPlayerBoard</span> <span class="n">playBoard</span><span class="o">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sprintf</span> <span class="s2">"%i damage dealt to %s. It died."</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Damage</span> <span class="n">cre</span><span class="p">.</span><span class="nc">Name</span><span class="p">)</span>
        <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span>
            <span class="p">(</span><span class="n">playBoard</span><span class="p">,</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Damage</span><span class="p">,</span> <span class="n">sprintf</span> <span class="s2">"%i damage dealt to player"</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Damage</span><span class="p">)</span>


<span class="k">let</span> <span class="n">applyPlayerDamageToPlayer</span> <span class="p">(</span><span class="n">playerId</span> <span class="p">:</span> <span class="nc">PlayerId</span><span class="p">)</span> <span class="n">damage</span> <span class="p">(</span><span class="n">gs</span><span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">player</span> <span class="p">=</span> <span class="n">gs</span><span class="p">.</span><span class="nn">Players</span><span class="p">.</span><span class="nc">TryGetValue</span> <span class="n">playerId</span>
    <span class="k">match</span> <span class="n">player</span> <span class="k">with</span>
    <span class="p">|</span> <span class="bp">true</span><span class="p">,</span> <span class="n">p</span> <span class="p">-&gt;</span> <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">Players</span> <span class="p">=</span> <span class="n">gs</span><span class="p">.</span><span class="nn">Players</span><span class="p">.</span><span class="nc">Add</span><span class="p">(</span><span class="n">playerId</span><span class="p">,</span> <span class="p">{</span><span class="n">p</span> <span class="k">with</span> <span class="nc">RemainingLifePoints</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="nc">RemainingLifePoints</span> <span class="p">-</span> <span class="n">damage</span><span class="o">})}</span>
    <span class="p">|</span> <span class="o">_,_</span> <span class="p">-&gt;</span> <span class="n">gs</span>


<span class="k">let</span> <span class="n">playAttackFromBoard</span> <span class="p">(</span><span class="n">attack</span> <span class="p">:</span> <span class="nc">Attack</span><span class="p">)</span> <span class="p">(</span><span class="n">playerId</span> <span class="p">:</span> <span class="nc">PlayerId</span><span class="p">)</span> <span class="p">(</span><span class="n">gs</span><span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">(</span><span class="n">playerBoard</span> <span class="p">:</span> <span class="nc">PlayerBoard</span><span class="p">)</span> <span class="p">=</span>

    <span class="k">let</span> <span class="n">target</span> <span class="p">=</span> <span class="n">getTheOtherPlayer</span> <span class="n">gs</span> <span class="n">playerId</span>
    <span class="k">let</span> <span class="n">otherBoard</span> <span class="p">=</span> <span class="n">getPlayBoardToTargetAttack</span> <span class="n">target</span> <span class="n">gs</span>

    <span class="k">match</span> <span class="n">otherBoard</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Ok</span> <span class="n">playBoard</span> <span class="p">-&gt;</span>

        <span class="k">let</span> <span class="p">(</span><span class="n">newPb</span><span class="p">,</span> <span class="n">playerDamage</span><span class="p">,</span> <span class="n">messages</span><span class="p">)</span> <span class="p">=</span>  <span class="p">(</span><span class="n">applyBasicAttackToPlayBoard</span> <span class="n">attack</span> <span class="n">playBoard</span> <span class="n">gs</span><span class="p">)</span>

        <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">Boards</span> <span class="p">=</span> <span class="p">(</span><span class="n">gs</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">Add</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">newPb</span><span class="p">)</span>  <span class="p">)</span> <span class="p">}</span>
        <span class="p">|&gt;</span> <span class="n">applyPlayerDamageToPlayer</span> <span class="n">target</span> <span class="n">playerDamage</span>
        <span class="p">|&gt;</span> <span class="n">appendMessagesToGameState</span> <span class="n">messages</span> <span class="p">|&gt;</span><span class="nc">Ok</span>
    <span class="p">|</span> <span class="nc">Error</span> <span class="n">e</span> <span class="p">-&gt;</span>
        <span class="nc">Error</span> <span class="n">e</span>



<span class="k">let</span> <span class="n">modifyGameStateFromPerformAttackEvent</span> <span class="p">(</span><span class="n">ev</span><span class="p">:</span> <span class="nc">PerformAttackEvent</span><span class="p">)</span> <span class="p">(</span><span class="n">gs</span><span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">=</span>
        <span class="n">getExistingPlayerBoardFromGameState</span> <span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="n">gs</span>
        <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="n">playAttackFromBoard</span> <span class="n">ev</span><span class="p">.</span><span class="nc">Attack</span> <span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="n">gs</span><span class="p">)</span>
        <span class="o">&gt;&gt;=</span> <span class="n">migrateGameStateToNewStep</span> <span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">|&gt;</span> <span class="nc">Reconcile</span> <span class="p">)</span>
        <span class="p">|&gt;</span> <span class="n">applyErrorResultToGamesState</span> <span class="n">gs</span></code></pre></figure>

<p>I then reference this <code class="language-plaintext highlighter-rouge">modifyGameStateFromPerformAttackEvent</code> in the update function.</p>

<p>This builds. I will now have to make sure my sample data has attacks and that the UI is wired up to trigger these events.</p>

<p>To wire up the UI I am able to modify the <code class="language-plaintext highlighter-rouge">renderAttackRow</code> to also include a button to exec an attack if it is available like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">renderDamageInformationForAttack</span> <span class="p">(</span><span class="n">attack</span><span class="p">:</span> <span class="nc">Attack</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">attack</span><span class="p">.</span><span class="nc">SpecialEffect</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="n">se</span> <span class="p">-&gt;</span>
        <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                <span class="p">[</span>
                    <span class="n">p</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"%i"</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Damage</span><span class="p">)</span> <span class="p">]</span>
                    <span class="n">p</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="n">se</span><span class="p">.</span><span class="nc">Description</span> <span class="p">]</span>
                <span class="p">]</span>
    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span>
        <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                <span class="p">[</span>
                    <span class="n">p</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"%i"</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Damage</span><span class="p">)</span> <span class="p">]</span>
                <span class="p">]</span>


<span class="k">let</span> <span class="n">renderAttackRowWithoutActions</span> <span class="p">(</span><span class="n">attack</span><span class="p">:</span> <span class="nc">Attack</span><span class="p">)</span> <span class="p">=</span>
        <span class="n">tr</span> <span class="p">[</span> <span class="p">]</span>
            <span class="p">[</span> <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">textDescriptionForResourcePool</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Cost</span><span class="p">)</span> <span class="p">]</span>
              <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">str</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Name</span> <span class="p">]</span>
              <span class="n">renderDamageInformationForAttack</span> <span class="n">attack</span> <span class="p">]</span>

<span class="k">let</span> <span class="n">renderAttackRow</span> <span class="n">displayAttackButton</span> <span class="n">canAttack</span> <span class="n">availableResources</span> <span class="n">gameId</span> <span class="n">playerId</span> <span class="n">inPlayCreatureId</span> <span class="p">(</span><span class="n">attack</span><span class="p">:</span> <span class="nc">Attack</span><span class="p">)</span> <span class="n">dispatch</span> <span class="p">=</span> <span class="c1">// Lol this needs to be refactored</span>
    <span class="k">let</span> <span class="n">execAttack</span> <span class="p">=</span>  <span class="p">(</span><span class="k">fun</span> <span class="p">_</span> <span class="p">-&gt;</span>
                                                    <span class="o">({</span>
                                                        <span class="nc">GameId</span> <span class="p">=</span> <span class="n">gameId</span>
                                                        <span class="nc">PlayerId</span> <span class="p">=</span> <span class="n">playerId</span>
                                                        <span class="nc">InPlayCreatureId</span> <span class="p">=</span> <span class="n">inPlayCreatureId</span>
                                                        <span class="nc">Attack</span> <span class="p">=</span> <span class="n">attack</span>
                                                    <span class="p">}</span> <span class="p">:</span>  <span class="nc">PerformAttackEvent</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nc">PerformAttack</span> <span class="p">|&gt;</span>  <span class="n">dispatch</span><span class="p">)</span>

    <span class="k">let</span> <span class="n">displayAttackButton</span> <span class="p">=</span> <span class="n">displayAttackButton</span> <span class="p">&amp;&amp;</span> <span class="n">canAttack</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">hasEnoughResources</span> <span class="n">availableResources</span> <span class="p">(</span><span class="nn">Map</span><span class="p">.</span><span class="n">toList</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Cost</span><span class="o">))</span>

    <span class="n">tr</span> <span class="p">[</span> <span class="p">]</span>
            <span class="p">[</span>
              <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">textDescriptionForResourcePool</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Cost</span><span class="p">)</span> <span class="p">]</span>
              <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">str</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Name</span> <span class="p">]</span>
              <span class="n">renderDamageInformationForAttack</span> <span class="n">attack</span>
              <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                <span class="p">[</span>
                    <span class="k">if</span> <span class="n">displayAttackButton</span> <span class="k">then</span>
                        <span class="n">button</span> <span class="p">[</span>
                            <span class="nc">Class</span> <span class="s2">"is-danger"</span>
                            <span class="nc">OnClick</span> <span class="n">execAttack</span>
                        <span class="p">]</span>
                            <span class="p">[</span>
                                <span class="n">str</span> <span class="s2">"Exec"</span>
                            <span class="p">]</span>
                    <span class="k">else</span>
                        <span class="n">str</span> <span class="s2">""</span>
                <span class="p">]</span> <span class="p">]</span></code></pre></figure>

<p>To populate the test database I am adding a “tackle” attack to all generated creatures in the <code class="language-plaintext highlighter-rouge">SampleCardDatabase</code></p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">creatureCreatureConstructor</span> <span class="n">creatureId</span> <span class="n">name</span> <span class="n">description</span> <span class="n">primaryResource</span> <span class="n">resourceCost</span> <span class="n">health</span> <span class="n">weaknesses</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">cardId</span> <span class="p">=</span> <span class="nn">NonEmptyString</span><span class="p">.</span><span class="n">build</span> <span class="n">creatureId</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">map</span> <span class="nc">CardId</span>
    <span class="k">let</span> <span class="n">cardImageUrl</span> <span class="p">=</span> <span class="nn">ImageUrlString</span><span class="p">.</span><span class="n">build</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"/images/full/%s.png"</span> <span class="n">creatureId</span><span class="p">)</span>

    <span class="k">match</span>  <span class="n">cardId</span><span class="p">,</span> <span class="n">cardImageUrl</span> <span class="k">with</span>
    <span class="p">|</span>  <span class="nc">Ok</span> <span class="n">cid</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">imgUrl</span> <span class="p">-&gt;</span>
        <span class="nc">Ok</span> <span class="p">{</span>
                <span class="nc">CardId</span> <span class="p">=</span> <span class="n">cid</span>
                <span class="nc">ResourceCost</span> <span class="p">=</span>  <span class="n">resourceCost</span>
                <span class="nc">Name</span> <span class="p">=</span> <span class="n">name</span>
                <span class="nc">EnterSpecialEffects</span> <span class="p">=</span> <span class="nc">None</span>
                <span class="nc">ExitSpecialEffects</span> <span class="p">=</span> <span class="nc">None</span>
                <span class="nc">PrimaryResource</span> <span class="p">=</span> <span class="n">primaryResource</span>
                <span class="nc">Creature</span> <span class="p">=</span>
                      <span class="p">{</span>
                        <span class="nc">Health</span><span class="p">=</span> <span class="n">health</span>
                        <span class="nc">Weaknesses</span><span class="p">=</span>  <span class="n">weaknesses</span>
                        <span class="nc">Attack</span> <span class="p">=</span> <span class="p">[</span>
                                    <span class="p">{</span>
                                        <span class="nc">Damage</span> <span class="p">=</span> <span class="mi">5</span>
                                        <span class="nc">Name</span> <span class="p">=</span> <span class="s2">"Tackle"</span>
                                        <span class="nc">Cost</span> <span class="p">=</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span> <span class="p">|&gt;</span> <span class="nc">ResourcePool</span>
                                        <span class="nc">SpecialEffect</span> <span class="p">=</span> <span class="nc">None</span>
                                    <span class="p">}</span>
                                 <span class="p">]</span>
                      <span class="p">}</span>
                <span class="nc">ImageUrl</span> <span class="p">=</span> <span class="n">imgUrl</span>
                <span class="nc">Description</span> <span class="p">=</span><span class="n">description</span>
            <span class="p">}</span>
    <span class="p">|</span> <span class="o">_,_</span> <span class="p">-&gt;</span> <span class="nc">Error</span> <span class="s2">"No"</span></code></pre></figure>

<p>I am now able to test the game. I can deal damage to creatures and players. It works in terms of basic functionality.</p>

<p>I am leaving this as the last commit in the branch <code class="language-plaintext highlighter-rouge">step-12-implement-attack</code>.</p>

<p><a href="https://github.com/jamesclancy/SafeCardGame/tree/step-12-implement-attack">Git branch for this step</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/projects/safecardgame/2021/05/31/Step11SwitchingThePlayerForTheGameState/">
        SafeCardGame - Step 11 - Switching the player for the GameState
      </a>
    </h1>

    <span class="post-date">31 May 2021</span>

    <h2 id="switching-the-player-for-the-gamestate">Switching the player for the GameState</h2>

<p>To facilitate testing, I am not going to add logic to swap Player 1 and Player 2. This should allow us to step through an entire game.</p>

<p>To do this I will add a Msg of type SwapPlayer.</p>

<p>i.e.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">Msg</span> <span class="p">=</span>
    <span class="p">|</span> <span class="nc">StartGame</span> <span class="k">of</span> <span class="nc">StartGameEvent</span>
    <span class="p">|</span> <span class="nc">DrawCard</span> <span class="k">of</span> <span class="nc">DrawCardEvent</span>
    <span class="p">|</span> <span class="nc">DiscardCard</span> <span class="k">of</span> <span class="nc">DiscardCardEvent</span>
    <span class="p">|</span> <span class="nc">PlayCard</span> <span class="k">of</span> <span class="nc">PlayCardEvent</span>
    <span class="p">|</span> <span class="nc">EndPlayStep</span> <span class="k">of</span> <span class="nc">EndPlayStepEvent</span>
    <span class="p">|</span> <span class="nc">PerformAttack</span> <span class="k">of</span> <span class="nc">PerformAttackEvent</span>
    <span class="p">|</span> <span class="nc">SkipAttack</span> <span class="k">of</span> <span class="nc">SkipAttackEvent</span>
    <span class="p">|</span> <span class="nc">EndTurn</span> <span class="k">of</span> <span class="nc">EndTurnEvent</span>
    <span class="p">|</span> <span class="nc">DeleteNotification</span> <span class="k">of</span> <span class="nc">Guid</span>
    <span class="p">|</span> <span class="nc">GameWon</span> <span class="k">of</span> <span class="nc">GameWonEvent</span>
    <span class="p">|</span> <span class="nc">SwapPlayer</span></code></pre></figure>

<p>I will then handle the message in the update like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">update</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nc">Msg</span><span class="p">)</span> <span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nc">GameState</span><span class="o">):</span> <span class="nc">GameState</span> <span class="p">*</span> <span class="nc">Cmd</span><span class="p">&lt;</span><span class="nc">Msg</span><span class="p">&gt;</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
    <span class="o">...</span>
    <span class="p">|</span> <span class="nc">SwapPlayer</span> <span class="p">-&gt;</span>
        <span class="p">{</span> <span class="n">model</span> <span class="k">with</span> <span class="nc">PlayerOne</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="nc">PlayerTwo</span><span class="p">;</span> <span class="nc">PlayerTwo</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="nc">PlayerOne</span> <span class="o">},</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span></code></pre></figure>

<p>Now I can add a button to switch players on the top nav bar like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">topNavigation</span> <span class="n">dispatch</span> <span class="p">=</span>
             <span class="o">...</span>
              <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-end"</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"buttons"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">a</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"button is-light"</span>
                              <span class="nc">OnClick</span> <span class="p">(</span><span class="k">fun</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="nc">SwapPlayer</span> <span class="p">|&gt;</span> <span class="n">dispatch</span><span class="p">)</span>
                              <span class="nc">Href</span> <span class="s2">"#"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">str</span> <span class="s2">"Switch Player"</span> <span class="p">]</span>
                          <span class="n">a</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"button is-light"</span>
                              <span class="nc">Href</span> <span class="s2">"#"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">str</span> <span class="s2">"Log in"</span> <span class="p">]</span>
             <span class="o">...</span></code></pre></figure>

<p>While doing this I found a bug in the, it should have been written like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">currentStepInformation</span> <span class="p">(</span><span class="n">player</span><span class="p">:</span> <span class="nc">Player</span><span class="p">)</span> <span class="p">(</span><span class="n">gameState</span> <span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span>  <span class="p">=</span>
    <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"field is-grouped has-addons is-grouped-right"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"control"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">button</span> <span class="p">[</span> <span class="nc">Class</span> <span class="p">(</span><span class="n">yourCurrentStepClasses</span> <span class="n">gameState</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">|&gt;</span> <span class="nn">GameStep</span><span class="p">.</span><span class="nc">Draw</span><span class="o">))</span>
                                       <span class="nc">Disabled</span> <span class="bp">true</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">span</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"Draw"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"control"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">button</span> <span class="p">[</span> <span class="nc">Class</span> <span class="p">(</span><span class="n">yourCurrentStepClasses</span> <span class="n">gameState</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">|&gt;</span> <span class="nn">GameStep</span><span class="p">.</span><span class="nc">Play</span><span class="o">))</span>
                                       <span class="nc">Disabled</span> <span class="bp">true</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">span</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"Play"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"control"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">button</span> <span class="p">[</span> <span class="nc">Class</span> <span class="p">(</span><span class="n">yourCurrentStepClasses</span> <span class="n">gameState</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">|&gt;</span> <span class="nn">GameStep</span><span class="p">.</span><span class="nc">Attack</span><span class="o">))</span>
                                       <span class="nc">Disabled</span> <span class="bp">true</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">span</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"Attack"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"control"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">button</span> <span class="p">[</span> <span class="nc">Class</span> <span class="p">(</span><span class="n">yourCurrentStepClasses</span> <span class="n">gameState</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">|&gt;</span> <span class="nn">GameStep</span><span class="p">.</span><span class="nc">Reconcile</span><span class="o">))</span>
                                       <span class="nc">Disabled</span> <span class="bp">true</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">span</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"Reconcile"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span></code></pre></figure>

<p>Also, I just noticed that the Draw is moving to the Attack step instead of the play step.</p>

<p>To fix this I changed the event that was being dispatched like</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">modifyGameStateFromDrawCardEvent</span> <span class="p">(</span><span class="n">ev</span><span class="p">:</span> <span class="nc">DrawCardEvent</span><span class="p">)</span> <span class="p">(</span><span class="n">gs</span><span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">getExistingPlayerBoardFromGameState</span> <span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="n">gs</span>
    <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">moveCardsFromDeckToHand</span> <span class="n">gs</span> <span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">migrateGameStateToNewStep</span> <span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">|&gt;</span> <span class="nc">Play</span><span class="o">))</span>
    <span class="p">|&gt;</span> <span class="k">function</span>
        <span class="p">|</span> <span class="nc">Ok</span> <span class="n">g</span> <span class="p">-&gt;</span> <span class="n">g</span>
        <span class="p">|</span> <span class="nc">Error</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">NotificationMessages</span> <span class="p">=</span> <span class="n">appendNotificationMessageToListOrCreateList</span> <span class="n">gs</span><span class="p">.</span><span class="nc">NotificationMessages</span> <span class="n">e</span> <span class="p">}</span></code></pre></figure>

<p>Also, in this branch, it was recommended to me that you can zoom cards. I am attempting to add a model that displays card details to the hand.</p>

<p>To try this I am trying to add a modal on click for the hand.</p>

<p>Meanwhile, I am noticing I really need to refactor out operators for stuff like :</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">    <span class="p">|</span>        <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">applyUpdatedPlayerBoardResultToGamesState</span> <span class="n">playerId</span> <span class="n">gs</span> <span class="n">x</span><span class="p">)</span></code></pre></figure>

<p>and</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">        <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="p">(</span><span class="n">applyUpdatedPlayerBoardResultToGamesState</span> <span class="n">playerId</span> <span class="n">gs</span> <span class="n">x</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nc">Ok</span><span class="p">)</span></code></pre></figure>

<p>i did this by implementing infix operators like</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="o">(&gt;&gt;=)</span> <span class="n">twoTrackInput</span> <span class="n">switchFunction</span> <span class="p">=</span>
    <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="n">switchFunction</span> <span class="n">twoTrackInput</span>

<span class="k">let</span> <span class="o">(&gt;=&gt;)</span> <span class="n">switch1</span> <span class="n">switch2</span> <span class="n">x</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">switch1</span> <span class="n">x</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Ok</span> <span class="n">s</span> <span class="p">-&gt;</span> <span class="n">switch2</span> <span class="n">s</span>
    <span class="p">|</span> <span class="nc">Error</span> <span class="n">f</span> <span class="p">-&gt;</span> <span class="nc">Error</span> <span class="n">f</span></code></pre></figure>

<p>Additionally, I moved many of the constructors for domain objects to the Shared Domain and deleted unused test generator functions.</p>

<p>Eventually, I was able to get the modal to work by adding a property to the game board: <code class="language-plaintext highlighter-rouge">ZoomedInCard</code> this is an optional CardInstanceId. I then added functions to check if the zoomed-in card was set to the current card. If it is the view displays the modal, if not it is hidden. I also added a Msg ZoomedInCardToggled and wired that up to the update function and the click of the thumbnail image in the hand.</p>

<p>This all builds and is the final commit in the <code class="language-plaintext highlighter-rouge">step-11-allow-the-user-to-switch-to-being-the-other-player</code> branch.</p>

<p><a href="https://github.com/jamesclancy/SafeCardGame/tree/step-11-allow-the-user-to-switch-to-being-the-other-player">Git branch for this step</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/projects/safecardgame/2021/05/30/Step9MoreRealisticCardDataAndWiringUIToEvents/">
        SafeCardGame - Step 9 - Adding more realistic cards data and wiring up the UI to send some events
      </a>
    </h1>

    <span class="post-date">30 May 2021</span>

    <h2 id="adding-more-realistic-cards-data-and-wiring-up-the-ui-to-send-some-events">Adding more realistic cards data and wiring up the UI to send some events</h2>

<p>In order to create better test data I am going to be creating a temporary SampleCardDatabase in the Client. This SampleCardDatabase will also require several generic list methods I am putting in a CollectionManipulation module also in the client.</p>

<p>I am going to create a creatureCardDb which creates a list of sample creature cards and a resourceCardDb which contains a list of sample resource cards. I am ignoring the effect cards for now.</p>

<p>Both of these “Db”s are generated by piping lists of tuples through a constructor function and taking all the valid “Ok” results.</p>

<p>I implemented them like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">creatureCreatureConstructor</span> <span class="n">creatureId</span> <span class="n">name</span> <span class="n">description</span> <span class="n">primaryResource</span> <span class="n">resourceCost</span> <span class="n">health</span> <span class="n">weaknesses</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">cardId</span> <span class="p">=</span> <span class="nn">NonEmptyString</span><span class="p">.</span><span class="n">build</span> <span class="n">creatureId</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">map</span> <span class="nc">CardId</span>
    <span class="k">let</span> <span class="n">cardImageUrl</span> <span class="p">=</span> <span class="nn">ImageUrlString</span><span class="p">.</span><span class="n">build</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"/images/full/%s.png"</span> <span class="n">creatureId</span><span class="p">)</span>

    <span class="k">match</span>  <span class="n">cardId</span><span class="p">,</span> <span class="n">cardImageUrl</span> <span class="k">with</span>
    <span class="p">|</span>  <span class="nc">Ok</span> <span class="n">cid</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">imgUrl</span> <span class="p">-&gt;</span>
        <span class="nc">Ok</span> <span class="p">{</span>
                <span class="nc">CardId</span> <span class="p">=</span> <span class="n">cid</span>
                <span class="nc">ResourceCost</span> <span class="p">=</span>  <span class="n">resourceCost</span>
                <span class="nc">Name</span> <span class="p">=</span> <span class="n">name</span>
                <span class="nc">EnterSpecialEffects</span> <span class="p">=</span> <span class="nc">None</span>
                <span class="nc">ExitSpecialEffects</span> <span class="p">=</span> <span class="nc">None</span>
                <span class="nc">PrimaryResource</span> <span class="p">=</span> <span class="n">primaryResource</span>
                <span class="nc">Creature</span> <span class="p">=</span>
                      <span class="p">{</span>
                        <span class="nc">Health</span><span class="p">=</span> <span class="n">health</span>
                        <span class="nc">Weaknesses</span><span class="p">=</span>  <span class="n">weaknesses</span>
                        <span class="nc">Attack</span> <span class="p">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">empty</span>
                      <span class="p">}</span>
                <span class="nc">ImageUrl</span> <span class="p">=</span> <span class="n">imgUrl</span>
                <span class="nc">Description</span> <span class="p">=</span><span class="n">description</span>
            <span class="p">}</span>
    <span class="p">|</span> <span class="o">_,</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="nc">Error</span> <span class="s2">"No"</span>

<span class="k">let</span> <span class="n">resourceCardConstructor</span> <span class="n">resourceCardId</span> <span class="n">resource</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">cardId</span> <span class="p">=</span> <span class="nn">NonEmptyString</span><span class="p">.</span><span class="n">build</span> <span class="n">resourceCardId</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">map</span> <span class="nc">CardId</span>
    <span class="k">let</span> <span class="n">cardImageUrl</span> <span class="p">=</span> <span class="nn">ImageUrlString</span><span class="p">.</span><span class="n">build</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"/images/resource/%s.png"</span> <span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="o">))</span>

    <span class="k">match</span>  <span class="n">cardId</span><span class="p">,</span> <span class="n">cardImageUrl</span> <span class="k">with</span>
    <span class="p">|</span>  <span class="nc">Ok</span> <span class="n">cid</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">imgUrl</span> <span class="p">-&gt;</span>
        <span class="nc">Ok</span> <span class="p">{</span>
                <span class="nc">CardId</span> <span class="p">=</span> <span class="n">cid</span>
                <span class="nc">ResourceCost</span> <span class="p">=</span>  <span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span> <span class="p">|&gt;</span> <span class="nc">ResourcePool</span>
                <span class="nc">Name</span> <span class="p">=</span> <span class="n">resource</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>
                <span class="nc">EnterSpecialEffects</span> <span class="p">=</span> <span class="nc">None</span>
                <span class="nc">ExitSpecialEffects</span> <span class="p">=</span> <span class="nc">None</span>
                <span class="nc">PrimaryResource</span> <span class="p">=</span> <span class="n">resource</span>
                <span class="nc">ResourceAvailableOnFirstTurn</span> <span class="p">=</span> <span class="bp">true</span>
                <span class="nc">ResourcesAdded</span> <span class="p">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">]</span> <span class="p">|&gt;</span> <span class="nc">ResourcePool</span>
                <span class="nc">ImageUrl</span> <span class="p">=</span> <span class="n">imgUrl</span>
                <span class="nc">Description</span> <span class="p">=</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Add 1 %s to your available resource pool."</span> <span class="p">(</span><span class="n">getSymbolForResource</span> <span class="n">resource</span><span class="o">))</span>
            <span class="p">}</span>
    <span class="p">|</span> <span class="o">_,</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="nc">Error</span> <span class="s2">"No"</span>

<span class="k">let</span> <span class="n">resourceCardDb</span> <span class="p">=</span>
    <span class="p">[</span>
      <span class="s2">"GrassEnergy"</span><span class="p">,</span> <span class="nn">Resource</span><span class="p">.</span> <span class="nc">Grass</span><span class="p">;</span>
      <span class="s2">"FireEnergy"</span><span class="p">,</span> <span class="nn">Resource</span><span class="p">.</span><span class="nc">Fire</span><span class="p">;</span>
      <span class="s2">"WaterEnergy"</span><span class="p">,</span> <span class="nn">Resource</span><span class="p">.</span> <span class="nc">Water</span><span class="p">;</span>
      <span class="s2">"LightningEnergy"</span><span class="p">,</span> <span class="nn">Resource</span><span class="p">.</span><span class="nc">Lightning</span><span class="p">;</span>
      <span class="s2">"PsychicEnergy"</span><span class="p">,</span> <span class="nn">Resource</span><span class="p">.</span><span class="nc">Psychic</span><span class="p">;</span>
      <span class="s2">"FightingEnergy"</span><span class="p">,</span> <span class="nn">Resource</span><span class="p">.</span><span class="nc">Fighting</span><span class="p">;</span>
      <span class="s2">"ColorlessEnergy"</span><span class="p">,</span> <span class="nn">Resource</span><span class="p">.</span><span class="nc">Colorless</span>
    <span class="p">]</span> <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">resourceCardConstructor</span>  <span class="n">x</span> <span class="n">y</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="n">selectAllOkayResults</span>

<span class="k">let</span> <span class="n">creatureCardDb</span> <span class="p">=</span>
    <span class="p">[</span>
      <span class="p">(</span><span class="s2">"001"</span><span class="p">,</span> <span class="s2">"BulbMon"</span><span class="p">,</span> <span class="s2">"It has a bulb on it bro"</span><span class="p">,</span><span class="nn">Resource</span><span class="p">.</span><span class="nc">Grass</span><span class="p">,</span> <span class="p">[</span> <span class="nn">Resource</span><span class="p">.</span><span class="nc">Grass</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span> <span class="p">]</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">ofList</span> <span class="p">|&gt;</span> <span class="nc">ResourcePool</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="p">[</span><span class="nn">Resource</span><span class="p">.</span><span class="nc">Fire</span><span class="p">]</span> <span class="p">)</span>
      <span class="p">(</span><span class="s2">"050"</span><span class="p">,</span> <span class="s2">"DigMon"</span><span class="p">,</span> <span class="s2">"Mole Monster"</span><span class="p">,</span> <span class="nn">Resource</span><span class="p">.</span><span class="nc">Fighting</span><span class="o">,[</span> <span class="nn">Resource</span><span class="p">.</span><span class="nc">Fighting</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span> <span class="p">]</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">ofList</span> <span class="p">|&gt;</span> <span class="nc">ResourcePool</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="p">[</span> <span class="nn">Resource</span><span class="p">.</span><span class="nc">Lightning</span> <span class="p">]</span> <span class="p">)</span>
      <span class="p">(</span><span class="s2">"086"</span><span class="p">,</span> <span class="s2">"SeelMon"</span><span class="p">,</span> <span class="s2">"See Lion Monster"</span><span class="p">,</span> <span class="nn">Resource</span><span class="p">.</span><span class="nc">Water</span><span class="p">,</span> <span class="p">[</span> <span class="nn">Resource</span><span class="p">.</span><span class="nc">Water</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span> <span class="p">]</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">ofList</span> <span class="p">|&gt;</span> <span class="nc">ResourcePool</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="p">[</span> <span class="nn">Resource</span><span class="p">.</span><span class="nc">Lightning</span> <span class="p">]</span> <span class="p">)</span>
    <span class="p">]</span>
   <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">q3</span><span class="p">,</span> <span class="n">q4</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">creatureCreatureConstructor</span>  <span class="n">x</span> <span class="n">y</span> <span class="n">z</span> <span class="n">q</span> <span class="n">q2</span> <span class="n">q3</span> <span class="n">q4</span><span class="p">)</span>
   <span class="p">|&gt;</span> <span class="n">selectAllOkayResults</span></code></pre></figure>

<p>with selectAllOkayResults defined in the CollectionManipulation as</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">predicateForOkayResults</span> <span class="n">z</span> <span class="p">=</span>
                        <span class="k">match</span> <span class="n">z</span> <span class="k">with</span>
                        <span class="p">|</span> <span class="nc">Ok</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="bp">true</span>
                        <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="bp">false</span>

<span class="k">let</span> <span class="n">selectorForOkayResults</span> <span class="n">z</span> <span class="p">=</span>
                        <span class="k">match</span> <span class="n">z</span> <span class="k">with</span>
                        <span class="p">|</span> <span class="nc">Ok</span> <span class="n">x</span> <span class="p">-&gt;</span>  <span class="p">[</span> <span class="n">x</span> <span class="p">]</span>
                        <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="bp">[]</span>

<span class="k">let</span> <span class="n">selectAllOkayResults</span> <span class="p">(</span><span class="n">z</span> <span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Result</span><span class="p">&lt;</span><span class="k">'</span><span class="n">a</span><span class="p">,</span><span class="k">'</span><span class="n">b</span><span class="o">&gt;&gt;)</span> <span class="p">=</span>
    <span class="n">z</span>
    <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="n">predicateForOkayResults</span>
    <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">selectorForOkayResults</span>
    <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">fold</span> <span class="o">(@)</span> <span class="bp">[]</span>

<span class="k">let</span> <span class="n">shuffleG</span> <span class="n">xs</span> <span class="p">=</span> <span class="n">xs</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">sortBy</span> <span class="p">(</span><span class="k">fun</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Guid</span><span class="p">.</span><span class="nc">NewGuid</span><span class="bp">()</span><span class="p">)</span></code></pre></figure>

<p>I now need to utilize these functions when setting up teh game. I want to add a mixture of resource cards and creature cards. For now I can alternate decks between creature and resource cards.</p>

<p>First I renamed <code class="language-plaintext highlighter-rouge">testCardGenerator</code> to <code class="language-plaintext highlighter-rouge">testCeatureCardGenerator</code> and change the function to pull information  from the sample database:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">testCreatureCardGenerator</span> <span class="n">cardInstanceIdStr</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">cardInstanceId</span> <span class="p">=</span> <span class="nn">NonEmptyString</span><span class="p">.</span><span class="n">build</span> <span class="n">cardInstanceIdStr</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">map</span> <span class="nc">CardInstanceId</span>

    <span class="k">match</span> <span class="n">cardInstanceId</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Ok</span> <span class="n">id</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">card</span> <span class="p">=</span> <span class="nn">SampleCardDatabase</span><span class="p">.</span><span class="n">creatureCardDb</span> <span class="p">|&gt;</span> <span class="nn">CollectionManipulation</span><span class="p">.</span><span class="n">shuffleG</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">head</span>
        <span class="nc">Ok</span>  <span class="p">{</span>
                <span class="nc">CardInstanceId</span>  <span class="p">=</span>  <span class="n">id</span>
                <span class="nc">Card</span> <span class="p">=</span>  <span class="n">card</span> <span class="p">|&gt;</span> <span class="nc">CharacterCard</span>
            <span class="p">}</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span>
        <span class="n">sprintf</span> <span class="s2">"Unable to create card instance for %s"</span> <span class="n">cardInstanceIdStr</span>
        <span class="p">|&gt;</span> <span class="nc">Error</span></code></pre></figure>

<p>I can then create a similar function <code class="language-plaintext highlighter-rouge">testResourceCardGenerator</code>:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">testResourceCardGenerator</span> <span class="n">cardInstanceIdStr</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">cardInstanceId</span> <span class="p">=</span> <span class="nn">NonEmptyString</span><span class="p">.</span><span class="n">build</span> <span class="n">cardInstanceIdStr</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">map</span> <span class="nc">CardInstanceId</span>

    <span class="k">match</span> <span class="n">cardInstanceId</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Ok</span> <span class="n">id</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">card</span> <span class="p">=</span> <span class="nn">SampleCardDatabase</span><span class="p">.</span><span class="n">resourceCardDb</span> <span class="p">|&gt;</span> <span class="nn">CollectionManipulation</span><span class="p">.</span><span class="n">shuffleG</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">head</span>
        <span class="nc">Ok</span>  <span class="p">{</span>
                <span class="nc">CardInstanceId</span>  <span class="p">=</span>  <span class="n">id</span>
                <span class="nc">Card</span> <span class="p">=</span>  <span class="n">card</span> <span class="p">|&gt;</span> <span class="nc">ResourceCard</span>
            <span class="p">}</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span>
        <span class="n">sprintf</span> <span class="s2">"Unable to create card instance for %s"</span> <span class="n">cardInstanceIdStr</span>
        <span class="p">|&gt;</span> <span class="nc">Error</span></code></pre></figure>

<p>I can then combine these two functions into <code class="language-plaintext highlighter-rouge">testDeckSeqGenerator</code>:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">testDeckSeqGenerator</span> <span class="p">(</span><span class="n">numberOfCards</span> <span class="p">:</span><span class="kt">int</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">seq</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">..</span> <span class="p">(</span><span class="n">numberOfCards</span> <span class="p">-</span> <span class="mi">1</span><span class="o">)}</span>
    <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="p">=</span> <span class="mi">1</span> <span class="k">then</span>
                        <span class="n">testCreatureCardGenerator</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"cardInstance-%i"</span> <span class="n">x</span><span class="p">)</span>
                    <span class="k">else</span>
                        <span class="n">testResourceCardGenerator</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"cardInstance-%i"</span> <span class="n">x</span><span class="p">)</span>
                    <span class="p">)</span>
    <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">ofSeq</span>
    <span class="p">|&gt;</span> <span class="nn">CollectionManipulation</span><span class="p">.</span><span class="n">selectAllOkayResults</span></code></pre></figure>

<p>I can then rewrite the init to reference the new Dbs like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">init</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">player1</span> <span class="p">=</span> <span class="n">createPlayer</span> <span class="s2">"Player1"</span> <span class="s2">"Player1"</span> <span class="mi">10</span> <span class="s2">"https://picsum.photos/id/1000/2500/1667?blur=5"</span>
    <span class="k">let</span> <span class="n">player2</span> <span class="p">=</span> <span class="n">createPlayer</span> <span class="s2">"Player2"</span> <span class="s2">"Player2"</span> <span class="mi">10</span> <span class="s2">"https://picsum.photos/id/10/2500/1667?blur=5"</span>
    <span class="k">let</span> <span class="n">gameId</span> <span class="p">=</span>  <span class="nn">NonEmptyString</span><span class="p">.</span><span class="n">build</span> <span class="s2">"GameIDHere"</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">map</span> <span class="nc">GameId</span>

    <span class="k">match</span> <span class="n">player1</span><span class="p">,</span> <span class="n">player2</span><span class="p">,</span> <span class="n">gameId</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Ok</span> <span class="n">p1</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">p2</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">g</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">playerBoard1</span> <span class="p">=</span> <span class="n">playerBoard</span> <span class="n">p1</span>
        <span class="k">let</span> <span class="n">playerBoard2</span> <span class="p">=</span> <span class="n">playerBoard</span> <span class="n">p2</span>
        <span class="k">match</span> <span class="n">playerBoard1</span><span class="p">,</span> <span class="n">playerBoard2</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">Ok</span> <span class="n">pb1</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">pb2</span> <span class="p">-&gt;</span>
          <span class="k">let</span> <span class="n">model</span> <span class="p">:</span> <span class="nc">GameState</span> <span class="p">=</span>
            <span class="p">{</span>
                <span class="nc">GameId</span> <span class="p">=</span> <span class="n">g</span>
                <span class="nc">Players</span> <span class="p">=</span>  <span class="nn">Map</span><span class="p">.</span><span class="n">empty</span>
                <span class="nc">Boards</span> <span class="p">=</span>   <span class="nn">Map</span><span class="p">.</span><span class="n">empty</span>
                <span class="nc">NotificationMessages</span> <span class="p">=</span> <span class="nc">None</span>
                <span class="nc">CurrentStep</span> <span class="p">=</span>  <span class="nc">NotCurrentlyPlaying</span>
                <span class="nc">TurnNumber</span> <span class="p">=</span> <span class="mi">0</span>
                <span class="nc">PlayerOne</span> <span class="p">=</span> <span class="n">p1</span><span class="p">.</span><span class="nc">PlayerId</span>
                <span class="nc">PlayerTwo</span> <span class="p">=</span> <span class="n">p2</span><span class="p">.</span><span class="nc">PlayerId</span>
            <span class="p">}</span>

          <span class="k">let</span> <span class="n">startGameEvent</span> <span class="p">=</span>
            <span class="p">{</span>
                <span class="nc">GameId</span> <span class="p">=</span> <span class="n">g</span>
                <span class="nc">Players</span> <span class="p">=</span>  <span class="p">[</span>
                            <span class="n">p1</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">,</span> <span class="n">p1</span><span class="p">;</span>
                            <span class="n">p2</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">,</span> <span class="n">p2</span>
                           <span class="p">]</span> <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">ofList</span>
                <span class="nc">PlayerOne</span> <span class="p">=</span> <span class="n">p1</span><span class="p">.</span><span class="nc">PlayerId</span>
                <span class="nc">PlayerTwo</span> <span class="p">=</span> <span class="n">p2</span><span class="p">.</span><span class="nc">PlayerId</span>
                <span class="nc">Decks</span> <span class="p">=</span> <span class="p">[</span>   <span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">,</span> <span class="p">{</span> <span class="nc">TopCardsExposed</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nc">Cards</span> <span class="p">=</span> <span class="n">testDeckSeqGenerator</span> <span class="mi">60</span> <span class="o">});</span>
                            <span class="p">(</span><span class="n">p2</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">,</span> <span class="p">{</span> <span class="nc">TopCardsExposed</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nc">Cards</span> <span class="p">=</span> <span class="n">testDeckSeqGenerator</span> <span class="mi">60</span> <span class="o">})]</span>
                         <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">ofSeq</span>
            <span class="p">}</span> <span class="p">|&gt;</span> <span class="nc">StartGame</span>
          <span class="k">let</span> <span class="n">cmd</span> <span class="p">=</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">ofMsg</span> <span class="n">startGameEvent</span>
          <span class="nc">Ok</span> <span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="s2">"Failed to create player boards"</span> <span class="p">|&gt;</span> <span class="nc">Error</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="s2">"Failed to create players"</span> <span class="p">|&gt;</span> <span class="nc">Error</span></code></pre></figure>

<p>I am able to see that the application does in fact now compile and renders the correct more realistic hands.</p>

<p>I am now able to try to wire up some functionality.</p>

<p>The first action I will try to implement is the “discard card” functionality on the discard button.</p>

<p>To do this I will need to wire up the OnClick functionality on the button.</p>

<p>I will wire it up by having this OnClick be a lambda sending a discard Msg like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">renderCardInstanceForHand</span>  <span class="p">(</span><span class="n">dispatch</span> <span class="p">:</span> <span class="nc">Msg</span> <span class="p">-&gt;</span> <span class="kt">unit</span><span class="p">)</span>  <span class="n">gameId</span> <span class="n">playerId</span> <span class="p">(</span><span class="n">card</span><span class="p">:</span> <span class="nc">CardInstance</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"column is-4"</span> <span class="p">]</span>
          <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card"</span> <span class="p">]</span>
             <span class="p">[</span>   <span class="k">yield</span><span class="o">!</span> <span class="p">(</span><span class="n">renderCardForHand</span> <span class="n">card</span><span class="p">.</span><span class="nc">Card</span><span class="p">)</span>
                 <span class="k">yield</span>   <span class="n">footer</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-footer"</span> <span class="p">]</span>
                      <span class="p">[</span> <span class="n">a</span> <span class="p">[</span> <span class="nc">Href</span> <span class="s2">"#"</span>
                            <span class="nc">Class</span> <span class="s2">"card-footer-item"</span> <span class="p">]</span>
                          <span class="p">[</span> <span class="n">str</span> <span class="s2">"Play"</span> <span class="p">]</span>
                        <span class="n">a</span> <span class="p">[</span> <span class="nc">Href</span> <span class="s2">"#"</span>
                            <span class="nc">OnClick</span> <span class="p">(</span><span class="k">fun</span> <span class="o">_-&gt;</span>
                                            <span class="o">({</span>
                                                <span class="nc">GameId</span> <span class="p">=</span> <span class="n">gameId</span>
                                                <span class="nc">PlayerId</span> <span class="p">=</span> <span class="n">playerId</span>
                                                <span class="nc">CardInstanceId</span> <span class="p">=</span> <span class="n">card</span><span class="p">.</span><span class="nc">CardInstanceId</span>
                                            <span class="p">}</span> <span class="p">:</span> <span class="nc">DiscardCardEvent</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nc">DiscardCard</span> <span class="p">|&gt;</span>  <span class="n">dispatch</span><span class="p">)</span>
                            <span class="nc">Class</span> <span class="s2">"card-footer-item"</span> <span class="p">]</span>
                          <span class="p">[</span> <span class="n">str</span> <span class="s2">"Discard"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span></code></pre></figure>

<p>To modify the renderCardInstance like this I had to alter the function to render the card frame and card footer as opposed to the renderCardForHand.</p>

<p>I did this by changing the renderCardForHand like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">renderCharacterCard</span> <span class="p">(</span><span class="n">card</span><span class="p">:</span> <span class="nc">CharacterCard</span><span class="p">)</span> <span class="p">=</span>
     <span class="p">[</span>
             <span class="n">header</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header-title"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">str</span> <span class="n">card</span><span class="p">.</span><span class="nc">Name</span> <span class="p">]</span>
                          <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header-icon"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">textDescriptionForResourcePool</span> <span class="n">card</span><span class="p">.</span><span class="nc">ResourceCost</span><span class="p">)</span> <span class="p">]</span> <span class="p">]</span>
             <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-image"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">figure</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"image is-4by3"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">img</span> <span class="p">[</span> <span class="nc">Src</span> <span class="p">(</span><span class="n">card</span><span class="p">.</span><span class="nn">ImageUrl</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="p">)</span>
                                    <span class="nc">Alt</span> <span class="n">card</span><span class="p">.</span><span class="nc">Name</span>
                                    <span class="nc">Class</span> <span class="s2">"is-fullwidth"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
             <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-content"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"content"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"is-italic"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="n">card</span><span class="p">.</span><span class="nc">Description</span> <span class="p">]</span>
                              <span class="n">displayCardSpecialEffectDetailIfPresent</span> <span class="s2">"On Enter Playing Field"</span> <span class="n">card</span><span class="p">.</span><span class="nc">EnterSpecialEffects</span>
                              <span class="n">displayCardSpecialEffectDetailIfPresent</span> <span class="s2">"On Exit Playing Field"</span> <span class="n">card</span><span class="p">.</span><span class="nc">ExitSpecialEffects</span>
                              <span class="n">h5</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"IsTitle is5"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="s2">"Attacks"</span> <span class="p">]</span>
                              <span class="n">table</span> <span class="p">[</span> <span class="p">]</span>
                                <span class="p">[</span>
                                  <span class="k">yield</span><span class="o">!</span> <span class="n">seq</span> <span class="p">{</span>
                                    <span class="k">for</span> <span class="n">a</span> <span class="k">in</span> <span class="n">card</span><span class="p">.</span><span class="nn">Creature</span><span class="p">.</span><span class="nc">Attack</span> <span class="k">do</span>
                                      <span class="p">(</span><span class="n">renderAttackRow</span> <span class="n">a</span><span class="p">)</span>
                                  <span class="p">}</span>
                                <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                                <span class="p">]</span>

<span class="k">let</span> <span class="n">renderCardForHand</span> <span class="p">(</span><span class="n">card</span><span class="p">:</span> <span class="nc">Card</span><span class="p">)</span> <span class="p">:</span> <span class="nc">ReactElement</span> <span class="kt">list</span><span class="p">=</span>
    <span class="k">match</span> <span class="n">card</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">CharacterCard</span> <span class="n">c</span> <span class="p">-&gt;</span> <span class="n">renderCharacterCard</span> <span class="n">c</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span>
         <span class="p">[</span>
            <span class="n">strong</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"IDK"</span> <span class="p">]</span>
         <span class="p">]</span></code></pre></figure>

<p>I am not able to click the discard button but it doesn’t function as expected! It is discarding all the cards other than the desired card!</p>

<p>I now have to fix the behavior of the <code class="language-plaintext highlighter-rouge">discardCardFromBoard</code> function. I have found that the bug lies in the filter on the Hand being ` (List.filter (fun x -&gt; x.CardInstanceId = cardInstanceId) playerBoard.Hand.Cards)<code class="language-plaintext highlighter-rouge"> and not </code> (List.filter (fun x -&gt; x.CardInstanceId &lt;&gt; cardInstanceId) playerBoard.Hand.Cards)<code class="language-plaintext highlighter-rouge">. Scanning through the code I will also have to update the similar funcationality in </code>addCreatureToGameState<code class="language-plaintext highlighter-rouge"> and </code>playCardFromBoard`. (the fact that I had to update this logic is a real sign I need to refactor but I am ignoring this for now).</p>

<p>I reload the webpage and discard appears to be correctly functioning.</p>

<p>Now I can similarly implement the play card functionality by altering the</p>

<p>Refreshing the browser, nothing happens when I click play.</p>

<p>The first thing I did was add a notification area to the page to see if there was an error message like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">notificationArea</span> <span class="p">(</span><span class="n">messages</span> <span class="p">:</span><span class="nc">Option</span><span class="p">&lt;</span><span class="nc">Notification</span> <span class="kt">list</span><span class="o">&gt;)</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">messages</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="n">s</span> <span class="p">-&gt;</span>
        <span class="n">div</span> <span class="bp">[]</span>
            <span class="p">[</span>
               <span class="k">yield</span><span class="o">!</span>  <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">div</span> <span class="p">[</span><span class="nc">Class</span> <span class="s2">"notification is-danger"</span><span class="p">]</span> <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="p">)</span> <span class="o">])</span> <span class="n">s</span>
            <span class="p">]</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span>
        <span class="n">div</span> <span class="bp">[]</span> <span class="bp">[]</span>

<span class="k">let</span> <span class="n">mainLayout</span>  <span class="n">model</span> <span class="n">dispatch</span> <span class="p">=</span>
  <span class="k">match</span> <span class="n">extractNeededModelsFromState</span> <span class="n">model</span> <span class="k">with</span>
  <span class="p">|</span> <span class="nc">Ok</span> <span class="n">op</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">opb</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">cp</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">cpb</span> <span class="p">-&gt;</span>
      <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"container is-fluid"</span> <span class="p">]</span>
        <span class="p">[</span> <span class="n">topNavigation</span>
          <span class="n">br</span> <span class="p">[</span> <span class="p">]</span>
          <span class="n">br</span> <span class="p">[</span> <span class="p">]</span>
          <span class="n">enemyStats</span> <span class="n">op</span> <span class="n">opb</span>
          <span class="n">enemyCreatures</span> <span class="n">op</span> <span class="n">opb</span>
          <span class="n">playerControlCenter</span> <span class="n">cp</span> <span class="n">cpb</span> <span class="n">model</span>
          <span class="n">notificationArea</span> <span class="n">model</span><span class="p">.</span><span class="nc">NotificationMessages</span>
          <span class="n">playerCreatures</span> <span class="n">cp</span> <span class="n">cpb</span>
          <span class="n">playerHand</span> <span class="n">model</span><span class="p">.</span><span class="nc">GameId</span> <span class="n">cp</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="n">cpb</span><span class="p">.</span><span class="nc">Hand</span> <span class="n">dispatch</span>
          <span class="n">footerBand</span>
        <span class="p">]</span>
  <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">strong</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"Error in GameState encountered."</span> <span class="p">]</span></code></pre></figure>

<p>After poking around for a while I realized this was never wired up at all. In the update function, I updated the</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">    <span class="p">|</span> <span class="nc">PlayCard</span> <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="n">model</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span></code></pre></figure>

<p>to</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">    <span class="p">|</span> <span class="nc">PlayCard</span> <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="n">modifyGameStateFromPlayCardEvent</span> <span class="n">ev</span> <span class="n">model</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span></code></pre></figure>

<p>Now it appears to be adding the creatures to the playfield. One thing that needs to be added to the UI is the total and available resources.</p>

<p>To do this I modified the <code class="language-plaintext highlighter-rouge">playerStats</code> function on the PageLayoutElements to include the resources like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">playerStats</span>  <span class="p">(</span><span class="n">player</span><span class="p">:</span> <span class="nc">Player</span><span class="p">)</span> <span class="p">(</span><span class="n">playerBoard</span><span class="p">:</span> <span class="nc">PlayerBoard</span><span class="p">)</span> <span class="p">=</span>
    <span class="p">[</span>             <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">a</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"button is-primary"</span>
                          <span class="nc">Href</span> <span class="s2">"#"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"💓 %i/10"</span> <span class="n">player</span><span class="p">.</span><span class="nc">RemainingLifePoints</span><span class="p">)</span> <span class="p">]</span> <span class="p">]</span>
                  <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">a</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"button is-primary"</span>
                          <span class="nc">Href</span> <span class="s2">"#"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"🤚 %i"</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">Hand</span><span class="p">.</span><span class="nn">Cards</span><span class="p">.</span><span class="nc">Length</span><span class="p">)</span> <span class="p">]</span> <span class="p">]</span>
                  <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">a</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"button is-primary"</span>
                          <span class="nc">Href</span> <span class="s2">"#"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"🂠 %i"</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">Deck</span><span class="p">.</span><span class="nn">Cards</span><span class="p">.</span><span class="nc">Length</span><span class="p">)</span> <span class="p">]</span> <span class="p">]</span>
                  <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">a</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"button is-primary"</span>
                          <span class="nc">Href</span> <span class="s2">"#"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"🗑️ %i"</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">DiscardPile</span><span class="p">.</span><span class="nn">Cards</span><span class="p">.</span><span class="nc">Length</span><span class="o">)]</span> <span class="p">]</span>
                  <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">a</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"button is-primary"</span>
                          <span class="nc">Href</span> <span class="s2">"#"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Total Res: %s"</span> <span class="p">(</span><span class="n">textDescriptionForResourcePool</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">TotalResourcePool</span><span class="o">))]</span> <span class="p">]</span>
                  <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">a</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"button is-primary"</span>
                          <span class="nc">Href</span> <span class="s2">"#"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Avail Res: %s"</span> <span class="p">(</span><span class="n">textDescriptionForResourcePool</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">AvailableResourcePool</span><span class="o">))]</span> <span class="p">]</span> <span class="p">]</span></code></pre></figure>

<p>I can now see the resources and see that the total resources are modifying but not available so I will need to update the <code class="language-plaintext highlighter-rouge">playCardFromBoard</code> function on index like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">playCardFromBoard</span> <span class="p">(</span><span class="n">cardInstanceId</span> <span class="p">:</span> <span class="nc">CardInstanceId</span><span class="p">)</span> <span class="p">(</span><span class="n">playerId</span> <span class="p">:</span> <span class="nc">PlayerId</span><span class="p">)</span> <span class="p">(</span><span class="n">gs</span><span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">(</span><span class="n">playerBoard</span> <span class="p">:</span> <span class="nc">PlayerBoard</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">cardToDiscard</span> <span class="p">:</span> <span class="nc">CardInstance</span> <span class="kt">list</span> <span class="p">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">CardInstanceId</span> <span class="p">=</span> <span class="n">cardInstanceId</span><span class="p">)</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">Hand</span><span class="p">.</span><span class="nc">Cards</span>

    <span class="k">match</span> <span class="n">cardToDiscard</span> <span class="k">with</span>
    <span class="p">|</span> <span class="bp">[]</span> <span class="p">-&gt;</span>
        <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Unable to locate card in hand with card instance id %s"</span> <span class="p">(</span><span class="n">cardInstanceId</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="o">))</span> <span class="p">|&gt;</span> <span class="nc">Error</span>
    <span class="p">|</span> <span class="p">[</span> <span class="n">x</span> <span class="p">]</span> <span class="p">-&gt;</span>
            <span class="k">match</span> <span class="n">x</span><span class="p">.</span><span class="nc">Card</span> <span class="k">with</span>
            <span class="p">|</span> <span class="nc">CharacterCard</span> <span class="n">cc</span> <span class="p">-&gt;</span>

              <span class="nn">System</span><span class="p">.</span><span class="nn">Guid</span><span class="p">.</span><span class="nc">NewGuid</span><span class="bp">()</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>
              <span class="p">|&gt;</span> <span class="n">buildInPlayCreatureId</span>
              <span class="p">|&gt;</span> <span class="p">(</span><span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">createInPlayCreatureFromCardInstance</span> <span class="n">x</span><span class="p">.</span><span class="nc">Card</span><span class="o">))</span>
              <span class="p">|&gt;</span> <span class="p">(</span><span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">addCreatureToGameState</span> <span class="n">cardInstanceId</span> <span class="n">x</span> <span class="n">playerId</span> <span class="n">gs</span> <span class="n">playerBoard</span><span class="o">))</span>
              <span class="p">|&gt;</span> <span class="p">(</span><span class="nn">Result</span><span class="p">.</span><span class="n">bind</span>  <span class="p">(</span><span class="n">applyEffectIfDefinied</span> <span class="n">cc</span><span class="p">.</span><span class="nc">EnterSpecialEffects</span><span class="o">))</span>

            <span class="p">|</span> <span class="nc">ResourceCard</span> <span class="n">rc</span> <span class="p">-&gt;</span>
              <span class="k">let</span> <span class="n">newPb</span> <span class="p">=</span> <span class="p">{</span>
                  <span class="n">playerBoard</span>
                    <span class="k">with</span> <span class="nc">Hand</span> <span class="p">=</span>
                          <span class="p">{</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">Hand</span> <span class="k">with</span>

                                <span class="nc">Cards</span> <span class="p">=</span> <span class="p">(</span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">CardInstanceId</span> <span class="p">&lt;&gt;</span> <span class="n">cardInstanceId</span><span class="p">)</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">Hand</span><span class="p">.</span><span class="nc">Cards</span><span class="p">)</span>
                          <span class="o">};</span>
                         <span class="nc">TotalResourcePool</span> <span class="p">=</span> <span class="n">addResourcesToPool</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">TotalResourcePool</span> <span class="p">(</span><span class="nn">Map</span><span class="p">.</span><span class="n">toList</span> <span class="n">rc</span><span class="p">.</span><span class="nc">ResourcesAdded</span><span class="p">)</span>
                         <span class="nc">AvailableResourcePool</span> <span class="p">=</span>
                            <span class="k">if</span> <span class="n">rc</span><span class="p">.</span><span class="nc">ResourceAvailableOnFirstTurn</span> <span class="k">then</span>
                                <span class="n">addResourcesToPool</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">AvailableResourcePool</span> <span class="p">(</span><span class="nn">Map</span><span class="p">.</span><span class="n">toList</span> <span class="n">rc</span><span class="p">.</span><span class="nc">ResourcesAdded</span><span class="p">)</span>
                            <span class="k">else</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">AvailableResourcePool</span>
                         <span class="nc">DiscardPile</span> <span class="o">={</span><span class="n">playerBoard</span><span class="p">.</span><span class="nc">DiscardPile</span> <span class="k">with</span> <span class="nc">Cards</span> <span class="p">=</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">DiscardPile</span><span class="p">.</span><span class="nc">Cards</span> <span class="o">@</span> <span class="p">[</span> <span class="n">x</span> <span class="p">]</span> <span class="p">}</span>
                <span class="p">}</span>
              <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">Boards</span> <span class="p">=</span> <span class="p">(</span><span class="n">gs</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">Add</span> <span class="p">(</span><span class="n">playerId</span><span class="p">,</span> <span class="n">newPb</span><span class="o">))</span> <span class="p">}</span> <span class="p">|&gt;</span> <span class="p">(</span><span class="n">applyEffectIfDefinied</span> <span class="n">rc</span><span class="p">.</span><span class="nc">EnterSpecialEffects</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">applyEffectIfDefinied</span> <span class="n">rc</span><span class="p">.</span><span class="nc">ExitSpecialEffects</span><span class="p">)</span>
            <span class="p">|</span> <span class="nc">EffectCard</span> <span class="n">ec</span> <span class="p">-&gt;</span>
              <span class="k">let</span> <span class="n">newPb</span> <span class="p">=</span>  <span class="p">{</span>
                  <span class="n">playerBoard</span>
                    <span class="k">with</span> <span class="nc">Hand</span> <span class="p">=</span>
                          <span class="p">{</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">Hand</span> <span class="k">with</span>

                                <span class="nc">Cards</span> <span class="p">=</span> <span class="p">(</span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">CardInstanceId</span> <span class="p">&lt;&gt;</span> <span class="n">cardInstanceId</span><span class="p">)</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">Hand</span><span class="p">.</span><span class="nc">Cards</span><span class="p">)</span>
                          <span class="o">};</span>
                         <span class="nc">DiscardPile</span> <span class="p">=</span> <span class="p">{</span><span class="n">playerBoard</span><span class="p">.</span><span class="nc">DiscardPile</span> <span class="k">with</span> <span class="nc">Cards</span> <span class="p">=</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">DiscardPile</span><span class="p">.</span><span class="nc">Cards</span> <span class="o">@</span> <span class="p">[</span> <span class="n">x</span> <span class="p">]</span> <span class="p">}</span>
                <span class="p">}</span>
              <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">Boards</span> <span class="p">=</span> <span class="p">(</span><span class="n">gs</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">Add</span> <span class="p">(</span><span class="n">playerId</span><span class="p">,</span> <span class="n">newPb</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span> <span class="p">|&gt;</span> <span class="p">(</span><span class="n">applyEffectIfDefinied</span> <span class="n">ec</span><span class="p">.</span><span class="nc">EnterSpecialEffects</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">applyEffectIfDefinied</span> <span class="n">ec</span><span class="p">.</span><span class="nc">ExitSpecialEffects</span><span class="p">)</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span>
        <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"ERROR: located multiple cards in hand with card instance id %s. This shouldn't happen"</span> <span class="p">(</span><span class="n">cardInstanceId</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="o">))</span> <span class="p">|&gt;</span> <span class="nc">Error</span></code></pre></figure>

<p>With both the total and available populating the layout completely breaks so I put these two values on top of each other. This looks bad but is functional for the moment:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="o">...</span>
                  <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">a</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"button is-primary"</span>
                          <span class="nc">Href</span> <span class="s2">"#"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Tot %s"</span> <span class="p">(</span><span class="n">textDescriptionForResourcePool</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">TotalResourcePool</span><span class="o">))</span>
                          <span class="n">br</span> <span class="bp">[]</span>
                          <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Ava %s"</span> <span class="p">(</span><span class="n">textDescriptionForResourcePool</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">AvailableResourcePool</span><span class="o">))]</span> <span class="p">]</span> <span class="p">]</span>
<span class="o">...</span></code></pre></figure>

<p>I now notice that I am able to play cards for which I don’t have the resources, as well as my available resources, are not being decremented.</p>

<p>To implement this I had to create a number of functions and rewrite the play logic to take this into account like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">getNeededResourcesForCard</span> <span class="n">card</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">card</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">CharacterCard</span> <span class="n">cc</span> <span class="p">-&gt;</span> <span class="n">cc</span><span class="p">.</span><span class="nc">ResourceCost</span>
    <span class="p">|</span> <span class="nc">ResourceCard</span> <span class="n">rc</span> <span class="p">-&gt;</span> <span class="n">rc</span><span class="p">.</span><span class="nc">ResourceCost</span>
    <span class="p">|</span> <span class="nc">EffectCard</span> <span class="n">ec</span> <span class="p">-&gt;</span> <span class="n">ec</span><span class="p">.</span><span class="nc">ResourceCost</span>

<span class="k">let</span> <span class="n">tryRemoveResourceFromPlayerBoard</span> <span class="p">(</span><span class="n">playerBoard</span><span class="p">:</span><span class="nc">PlayerBoard</span><span class="p">)</span> <span class="n">x</span> <span class="n">y</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">AvailableResourcePool</span><span class="p">.</span><span class="nc">TryGetValue</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">with</span>
    <span class="p">|</span> <span class="bp">true</span><span class="p">,</span> <span class="n">z</span> <span class="k">when</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="n">y</span> <span class="p">-&gt;</span> <span class="nc">Ok</span> <span class="p">{</span><span class="n">playerBoard</span> <span class="k">with</span> <span class="nc">AvailableResourcePool</span> <span class="p">=</span> <span class="p">(</span><span class="n">addResourcesToPool</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">AvailableResourcePool</span>  <span class="p">[</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span>  <span class="n">y</span><span class="p">)</span> <span class="o">])</span>  <span class="p">}</span>
    <span class="p">|</span> <span class="o">_,</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Not enough %s"</span> <span class="p">(</span><span class="n">getSymbolForResource</span> <span class="n">x</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nc">Error</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">decrementResourcesFromPlayerBoard</span> <span class="n">playerBoard</span> <span class="n">resourcePool</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">resourcePool</span> <span class="k">with</span>
    <span class="p">|</span> <span class="bp">[]</span> <span class="p">-&gt;</span> <span class="nc">Ok</span> <span class="n">playerBoard</span>
    <span class="p">|</span> <span class="p">[</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="p">]</span> <span class="p">-&gt;</span> <span class="n">tryRemoveResourceFromPlayerBoard</span> <span class="n">playerBoard</span> <span class="n">x</span> <span class="n">y</span>
    <span class="p">|</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="p">::</span> <span class="n">xs</span> <span class="p">-&gt;</span>
        <span class="k">match</span> <span class="n">tryRemoveResourceFromPlayerBoard</span> <span class="n">playerBoard</span> <span class="n">x</span> <span class="n">y</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">Error</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="n">e</span> <span class="p">|&gt;</span> <span class="nc">Error</span>
        <span class="p">|</span> <span class="nc">Ok</span> <span class="n">pb</span> <span class="p">-&gt;</span> <span class="n">decrementResourcesFromPlayerBoard</span> <span class="n">pb</span> <span class="n">xs</span>


<span class="k">let</span> <span class="n">decrementRequiredResourcesFromModel</span> <span class="n">cardToDiscard</span> <span class="p">(</span><span class="n">playerId</span> <span class="p">:</span> <span class="nc">PlayerId</span><span class="p">)</span> <span class="p">(</span><span class="n">gs</span><span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">(</span><span class="n">playerBoard</span> <span class="p">:</span> <span class="nc">PlayerBoard</span><span class="p">)</span> <span class="p">=</span>
     <span class="n">getNeededResourcesForCard</span> <span class="n">cardToDiscard</span>
     <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">toList</span>
     <span class="p">|&gt;</span> <span class="n">decrementResourcesFromPlayerBoard</span> <span class="n">playerBoard</span>
     <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="k">fun</span> <span class="n">updatedPlayerBoard</span> <span class="p">-&gt;</span> <span class="nc">Ok</span> <span class="p">{</span><span class="n">gs</span> <span class="k">with</span> <span class="nc">Boards</span> <span class="p">=</span> <span class="n">gs</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">Add</span><span class="p">(</span><span class="n">playerId</span><span class="p">,</span> <span class="n">updatedPlayerBoard</span><span class="p">)</span> <span class="o">})</span>


<span class="k">let</span> <span class="n">playCardFromBoardImp</span> <span class="n">cardInstanceId</span> <span class="n">playerId</span> <span class="n">playerBoard</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="nc">CardInstance</span><span class="p">)</span> <span class="n">cardToDiscard</span> <span class="n">gs</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">x</span><span class="p">.</span><span class="nc">Card</span> <span class="k">with</span>
               <span class="p">|</span> <span class="nc">CharacterCard</span> <span class="n">cc</span> <span class="p">-&gt;</span>

                 <span class="nn">System</span><span class="p">.</span><span class="nn">Guid</span><span class="p">.</span><span class="nc">NewGuid</span><span class="bp">()</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>
                 <span class="p">|&gt;</span> <span class="n">buildInPlayCreatureId</span>
                 <span class="p">|&gt;</span> <span class="p">(</span><span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">createInPlayCreatureFromCardInstance</span> <span class="n">x</span><span class="p">.</span><span class="nc">Card</span><span class="o">))</span>
                 <span class="p">|&gt;</span> <span class="p">(</span><span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">addCreatureToGameState</span> <span class="n">cardInstanceId</span> <span class="n">x</span> <span class="n">playerId</span> <span class="n">gs</span> <span class="n">playerBoard</span><span class="o">))</span>
                 <span class="p">|&gt;</span> <span class="p">(</span><span class="nn">Result</span><span class="p">.</span><span class="n">bind</span>  <span class="p">(</span><span class="n">applyEffectIfDefinied</span> <span class="n">cc</span><span class="p">.</span><span class="nc">EnterSpecialEffects</span><span class="o">))</span>

               <span class="p">|</span> <span class="nc">ResourceCard</span> <span class="n">rc</span> <span class="p">-&gt;</span>
                 <span class="k">let</span> <span class="n">newAvailResourcePool</span> <span class="p">=</span>
                               <span class="k">if</span> <span class="n">rc</span><span class="p">.</span><span class="nc">ResourceAvailableOnFirstTurn</span> <span class="k">then</span>
                                   <span class="n">addResourcesToPool</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">AvailableResourcePool</span> <span class="p">(</span><span class="nn">Map</span><span class="p">.</span><span class="n">toList</span> <span class="n">rc</span><span class="p">.</span><span class="nc">ResourcesAdded</span><span class="p">)</span>
                               <span class="k">else</span>
                                   <span class="n">playerBoard</span><span class="p">.</span><span class="nc">AvailableResourcePool</span>
                 <span class="k">let</span> <span class="n">newPb</span> <span class="p">=</span> <span class="p">{</span>
                     <span class="n">playerBoard</span>
                       <span class="k">with</span> <span class="nc">Hand</span> <span class="p">=</span>
                             <span class="p">{</span>
                               <span class="n">playerBoard</span><span class="p">.</span><span class="nc">Hand</span> <span class="k">with</span>
                                   <span class="nc">Cards</span> <span class="p">=</span> <span class="p">(</span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">CardInstanceId</span> <span class="p">&lt;&gt;</span> <span class="n">cardInstanceId</span><span class="p">)</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">Hand</span><span class="p">.</span><span class="nc">Cards</span><span class="p">)</span>
                             <span class="p">}</span>
                            <span class="nc">TotalResourcePool</span> <span class="p">=</span> <span class="n">addResourcesToPool</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">TotalResourcePool</span> <span class="p">(</span><span class="nn">Map</span><span class="p">.</span><span class="n">toList</span> <span class="n">rc</span><span class="p">.</span><span class="nc">ResourcesAdded</span><span class="p">)</span>
                            <span class="nc">AvailableResourcePool</span> <span class="p">=</span> <span class="n">newAvailResourcePool</span>
                            <span class="nc">DiscardPile</span> <span class="o">={</span><span class="n">playerBoard</span><span class="p">.</span><span class="nc">DiscardPile</span> <span class="k">with</span> <span class="nc">Cards</span> <span class="p">=</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">DiscardPile</span><span class="p">.</span><span class="nc">Cards</span> <span class="o">@</span> <span class="p">[</span> <span class="n">x</span> <span class="p">]</span> <span class="p">}</span>
                   <span class="p">}</span>
                 <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">Boards</span> <span class="p">=</span> <span class="p">(</span><span class="n">gs</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">Add</span> <span class="p">(</span><span class="n">playerId</span><span class="p">,</span> <span class="n">newPb</span><span class="o">))</span> <span class="p">}</span> <span class="p">|&gt;</span> <span class="p">(</span><span class="n">applyEffectIfDefinied</span> <span class="n">rc</span><span class="p">.</span><span class="nc">EnterSpecialEffects</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">applyEffectIfDefinied</span> <span class="n">rc</span><span class="p">.</span><span class="nc">ExitSpecialEffects</span><span class="p">)</span>
               <span class="p">|</span> <span class="nc">EffectCard</span> <span class="n">ec</span> <span class="p">-&gt;</span>
                 <span class="k">let</span> <span class="n">newPb</span> <span class="p">=</span>  <span class="p">{</span>
                     <span class="n">playerBoard</span>
                       <span class="k">with</span> <span class="nc">Hand</span> <span class="p">=</span>
                             <span class="p">{</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">Hand</span> <span class="k">with</span>

                                   <span class="nc">Cards</span> <span class="p">=</span> <span class="p">(</span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">CardInstanceId</span> <span class="p">&lt;&gt;</span> <span class="n">cardInstanceId</span><span class="p">)</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">Hand</span><span class="p">.</span><span class="nc">Cards</span><span class="p">)</span>
                             <span class="o">};</span>
                            <span class="nc">DiscardPile</span> <span class="p">=</span> <span class="p">{</span><span class="n">playerBoard</span><span class="p">.</span><span class="nc">DiscardPile</span> <span class="k">with</span> <span class="nc">Cards</span> <span class="p">=</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">DiscardPile</span><span class="p">.</span><span class="nc">Cards</span> <span class="o">@</span> <span class="p">[</span> <span class="n">x</span> <span class="p">]</span> <span class="p">}</span>
                   <span class="p">}</span>
                 <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">Boards</span> <span class="p">=</span> <span class="p">(</span><span class="n">gs</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">Add</span> <span class="p">(</span><span class="n">playerId</span><span class="p">,</span> <span class="n">newPb</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span> <span class="p">|&gt;</span> <span class="p">(</span><span class="n">applyEffectIfDefinied</span> <span class="n">ec</span><span class="p">.</span><span class="nc">EnterSpecialEffects</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">applyEffectIfDefinied</span> <span class="n">ec</span><span class="p">.</span><span class="nc">ExitSpecialEffects</span><span class="p">)</span>


<span class="k">let</span> <span class="n">playCardFromBoard</span> <span class="p">(</span><span class="n">cardInstanceId</span> <span class="p">:</span> <span class="nc">CardInstanceId</span><span class="p">)</span> <span class="p">(</span><span class="n">playerId</span> <span class="p">:</span> <span class="nc">PlayerId</span><span class="p">)</span> <span class="p">(</span><span class="n">gs</span><span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">(</span><span class="n">playerBoard</span> <span class="p">:</span> <span class="nc">PlayerBoard</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">cardToDiscard</span> <span class="p">:</span> <span class="nc">CardInstance</span> <span class="kt">list</span> <span class="p">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">CardInstanceId</span> <span class="p">=</span> <span class="n">cardInstanceId</span><span class="p">)</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">Hand</span><span class="p">.</span><span class="nc">Cards</span>

    <span class="k">match</span> <span class="n">cardToDiscard</span> <span class="k">with</span>
    <span class="p">|</span> <span class="bp">[]</span> <span class="p">-&gt;</span>
        <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Unable to locate card in hand with card instance id %s"</span> <span class="p">(</span><span class="n">cardInstanceId</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="o">))</span> <span class="p">|&gt;</span> <span class="nc">Error</span>
    <span class="p">|</span> <span class="p">[</span> <span class="n">x</span> <span class="p">]</span> <span class="p">-&gt;</span>
        <span class="n">decrementRequiredResourcesFromModel</span> <span class="n">x</span><span class="p">.</span><span class="nc">Card</span> <span class="n">playerId</span> <span class="n">gs</span> <span class="n">playerBoard</span>
        <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">playCardFromBoardImp</span> <span class="n">cardInstanceId</span> <span class="n">playerId</span> <span class="n">playerBoard</span> <span class="n">x</span> <span class="n">cardToDiscard</span><span class="p">)</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span>
        <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"ERROR: located multiple cards in hand with card instance id %s. This shouldn't happen"</span> <span class="p">(</span><span class="n">cardInstanceId</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="o">))</span> <span class="p">|&gt;</span> <span class="nc">Error</span></code></pre></figure>

<p>From a testing standpoint, the lack of rendering the resource cards has become quite difficult to deal with so I have added a simple rendering for the resource cards:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">renderResourceCard</span> <span class="p">(</span><span class="n">card</span><span class="p">:</span> <span class="nc">ResourceCard</span><span class="p">)</span> <span class="p">=</span>
    <span class="p">[</span>
            <span class="n">header</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header"</span> <span class="p">]</span>
                       <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header-title"</span> <span class="p">]</span>
                           <span class="p">[</span> <span class="n">str</span> <span class="n">card</span><span class="p">.</span><span class="nc">Name</span> <span class="p">]</span>
                         <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header-icon"</span> <span class="p">]</span>
                           <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">textDescriptionForResourcePool</span> <span class="n">card</span><span class="p">.</span><span class="nc">ResourceCost</span><span class="p">)</span> <span class="p">]</span> <span class="p">]</span>
            <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-image"</span> <span class="p">]</span>
                       <span class="p">[</span> <span class="n">figure</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"image is-4by3"</span> <span class="p">]</span>
                           <span class="p">[</span> <span class="n">img</span> <span class="p">[</span> <span class="nc">Src</span> <span class="p">(</span><span class="n">card</span><span class="p">.</span><span class="nn">ImageUrl</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="p">)</span>
                                   <span class="nc">Alt</span> <span class="n">card</span><span class="p">.</span><span class="nc">Name</span>
                                   <span class="nc">Class</span> <span class="s2">"is-fullwidth"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
            <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-content"</span> <span class="p">]</span>
                       <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"content"</span> <span class="p">]</span>
                           <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"is-italic"</span> <span class="p">]</span>
                               <span class="p">[</span> <span class="n">str</span> <span class="n">card</span><span class="p">.</span><span class="nc">Description</span> <span class="p">]</span>
                             <span class="n">displayCardSpecialEffectDetailIfPresent</span> <span class="s2">"On Enter Playing Field"</span> <span class="n">card</span><span class="p">.</span><span class="nc">EnterSpecialEffects</span>
                             <span class="n">displayCardSpecialEffectDetailIfPresent</span> <span class="s2">"On Exit Playing Field"</span> <span class="n">card</span><span class="p">.</span><span class="nc">ExitSpecialEffects</span>
                           <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>


<span class="k">let</span> <span class="n">renderCardForHand</span> <span class="p">(</span><span class="n">card</span><span class="p">:</span> <span class="nc">Card</span><span class="p">)</span> <span class="p">:</span> <span class="nc">ReactElement</span> <span class="kt">list</span><span class="p">=</span>
    <span class="k">match</span> <span class="n">card</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">CharacterCard</span> <span class="n">c</span> <span class="p">-&gt;</span> <span class="n">renderCharacterCard</span> <span class="n">c</span>
    <span class="p">|</span> <span class="nc">ResourceCard</span> <span class="n">rc</span> <span class="p">-&gt;</span> <span class="n">renderResourceCard</span> <span class="n">rc</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span>
         <span class="p">[</span>
            <span class="n">strong</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"IDK"</span> <span class="p">]</span>
         <span class="p">]</span></code></pre></figure>

<p>One thing I have realized is that I need to add functionality to remove old notifications. To do this I will need to add an id to the <code class="language-plaintext highlighter-rouge">Notification</code>s, define a Msg <code class="language-plaintext highlighter-rouge">DeleteNotification</code> which removes the notification with a specified id. Then I will add a delete button the to UI which sends a <code class="language-plaintext highlighter-rouge">DeleteNotification</code> message.</p>

<p>The UI update will be:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">notificationArea</span> <span class="p">(</span><span class="n">messages</span> <span class="p">:</span><span class="nc">Option</span><span class="p">&lt;</span><span class="nc">Notification</span> <span class="kt">list</span><span class="o">&gt;)</span> <span class="n">dispatch</span><span class="p">=</span>
    <span class="k">match</span> <span class="n">messages</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="n">s</span> <span class="p">-&gt;</span>
        <span class="n">div</span> <span class="bp">[]</span>
            <span class="p">[</span>
               <span class="k">yield</span><span class="o">!</span>  <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">div</span> <span class="p">[</span><span class="nc">Class</span> <span class="s2">"notification is-danger"</span><span class="p">]</span> <span class="p">[</span>
                                                    <span class="n">button</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"delete"</span>
                                                             <span class="nc">OnClick</span> <span class="p">(</span><span class="k">fun</span> <span class="n">y</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">Id</span> <span class="p">|&gt;</span> <span class="nc">DeleteNotification</span> <span class="p">|&gt;</span> <span class="n">dispatch</span><span class="p">)</span>
                                                            <span class="p">]</span> <span class="bp">[]</span>
                                                    <span class="n">str</span> <span class="n">x</span><span class="p">.</span><span class="nc">Content</span> <span class="o">])</span> <span class="n">s</span>
            <span class="p">]</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span>
        <span class="n">div</span> <span class="bp">[]</span> <span class="bp">[]</span></code></pre></figure>

<p>The domain update to the notification will be:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">    <span class="o">...</span>
    <span class="k">and</span> <span class="nc">Notification</span> <span class="p">=</span>
        <span class="p">{</span>
            <span class="nc">Id</span><span class="p">:</span> <span class="nc">Guid</span>
            <span class="nc">Content</span><span class="p">:</span> <span class="kt">string</span>
        <span class="p">}</span>
    <span class="o">...</span>

    <span class="k">let</span> <span class="n">createNotification</span> <span class="n">message</span> <span class="o">={</span><span class="nc">Id</span> <span class="p">=</span> <span class="nn">Guid</span><span class="p">.</span><span class="nc">NewGuid</span><span class="bp">()</span><span class="p">;</span> <span class="nc">Content</span> <span class="p">=</span> <span class="n">message</span><span class="p">}</span></code></pre></figure>

<p>The Msg type I also updated to remove the outdated GameStarted type:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">Msg</span> <span class="p">=</span>
    <span class="p">|</span> <span class="nc">StartGame</span> <span class="k">of</span> <span class="nc">StartGameEvent</span>
    <span class="p">|</span> <span class="nc">DrawCard</span> <span class="k">of</span> <span class="nc">DrawCardEvent</span>
    <span class="p">|</span> <span class="nc">DiscardCard</span> <span class="k">of</span> <span class="nc">DiscardCardEvent</span>
    <span class="p">|</span> <span class="nc">PlayCard</span> <span class="k">of</span> <span class="nc">PlayCardEvent</span>
    <span class="p">|</span> <span class="nc">EndPlayStep</span> <span class="k">of</span> <span class="nc">EndPlayStepEvent</span>
    <span class="p">|</span> <span class="nc">PerformAttack</span> <span class="k">of</span> <span class="nc">PerformAttackEvent</span>
    <span class="p">|</span> <span class="nc">SkipAttack</span> <span class="k">of</span> <span class="nc">SkipAttackEvent</span>
    <span class="p">|</span> <span class="nc">EndTurn</span> <span class="k">of</span> <span class="nc">EndTurnEvent</span>
    <span class="p">|</span> <span class="nc">DeleteNotification</span> <span class="k">of</span> <span class="nc">Guid</span>
    <span class="p">|</span> <span class="nc">GameWon</span> <span class="k">of</span> <span class="nc">GameWonEvent</span></code></pre></figure>

<p>I can then update <code class="language-plaintext highlighter-rouge">update</code> to include the new event</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">    <span class="p">|</span> <span class="nc">DeleteNotification</span> <span class="n">dn</span> <span class="p">-&gt;</span>
        <span class="n">removeNotification</span> <span class="n">model</span> <span class="n">dn</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span></code></pre></figure>

<p>and define <code class="language-plaintext highlighter-rouge">removeNotification</code> as</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">filterNotificationList</span> <span class="n">notificationId</span> <span class="n">l</span> <span class="p">=</span>
    <span class="n">l</span> <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">Id</span> <span class="p">&lt;&gt;</span> <span class="n">notificationId</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="k">function</span>
        <span class="p">|</span> <span class="bp">[]</span> <span class="p">-&gt;</span> <span class="nc">None</span>
        <span class="p">|</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="nc">Some</span> <span class="n">x</span>

<span class="k">let</span> <span class="n">removeNotification</span> <span class="n">gs</span> <span class="n">notificationId</span> <span class="p">=</span>
   <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">NotificationMessages</span> <span class="p">=</span> <span class="k">match</span> <span class="n">gs</span><span class="p">.</span><span class="nc">NotificationMessages</span> <span class="k">with</span>
                                    <span class="p">|</span> <span class="nc">Some</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">filterNotificationList</span> <span class="n">notificationId</span> <span class="n">x</span>
                                    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="nc">None</span>
   <span class="p">}</span></code></pre></figure>

<p>This all appears to build so I am leave this as the final change in the branch <code class="language-plaintext highlighter-rouge">step-9-better-sample-data-and-wiring-up-ui</code>.</p>

<p><a href="https://github.com/jamesclancy/SafeCardGame/tree/step-9-better-sample-data-and-wiring-up-ui">Git branch for this step</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/projects/safecardgame/2021/05/30/Step10MoreRealisticCardDataAndWiringUIToEventsPart2/">
        SafeCardGame - Step 10 - Adding more realistic cards data and wiring up the Ui to send some events -Continued - the Player Control Center
      </a>
    </h1>

    <span class="post-date">30 May 2021</span>

    <h2 id="adding-more-realistic-cards-data-and-wiring-up-the-ui-to-send-some-events--continued---the-player-control-center">Adding more realistic cards data and wiring up the Ui to send some events -Continued - the Player Control Center</h2>

<p>Now I will try to implement the turn step changes via conditional buttons in the player control center.</p>

<p>Currently, a placeholder for these buttons is located in the <code class="language-plaintext highlighter-rouge">playerControlCenter</code> function. I will pull out a <code class="language-plaintext highlighter-rouge">stepNavigation</code> function and rewrite the <code class="language-plaintext highlighter-rouge">playerControlCenter</code> as</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">playerControlCenter</span>  <span class="p">(</span><span class="n">player</span> <span class="p">:</span> <span class="nc">Player</span><span class="p">)</span> <span class="n">playerBoard</span> <span class="n">gameState</span> <span class="n">dispatch</span> <span class="p">=</span>
  <span class="n">nav</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar is-fullwidth is-primary"</span> <span class="p">]</span>
    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"container"</span> <span class="p">]</span>
        <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-brand"</span> <span class="p">]</span>
            <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item title is-5"</span>
                  <span class="nc">Href</span> <span class="s2">"#"</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">str</span> <span class="n">player</span><span class="p">.</span><span class="nc">Name</span> <span class="p">]</span> <span class="p">]</span>
          <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-menu"</span> <span class="p">]</span>
            <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-start"</span> <span class="p">]</span>
                <span class="p">[</span> <span class="k">yield</span><span class="o">!</span> <span class="n">playerStats</span> <span class="n">player</span> <span class="n">playerBoard</span>
                  <span class="n">currentStepInformation</span> <span class="n">player</span> <span class="n">gameState</span> <span class="p">]</span>
              <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-end"</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">stepNavigation</span> <span class="n">player</span> <span class="n">playerBoard</span> <span class="n">gameState</span> <span class="n">dispatch</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span></code></pre></figure>

<ul>
  <li>note I also added the dispatch to the function</li>
</ul>

<p>This <code class="language-plaintext highlighter-rouge">stepNavigation</code> function is going to rely on switching the current step and player to tell what options &amp; actions are available.</p>

<p>I can implement the changes like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">renderStepOptionButton</span> <span class="n">dispatch</span> <span class="n">buttonText</span> <span class="n">classType</span> <span class="n">message</span> <span class="p">=</span>
                        <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"control"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">button</span> <span class="p">[</span>
                                <span class="nc">Class</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"button %s is-large"</span> <span class="n">classType</span><span class="p">)</span>
                                <span class="nc">OnClick</span>  <span class="p">(</span><span class="k">fun</span> <span class="o">_-&gt;</span> <span class="p">(</span><span class="n">message</span> <span class="p">|&gt;</span>  <span class="n">dispatch</span><span class="o">))</span>
                                <span class="p">]</span>
                                <span class="p">[</span> <span class="n">span</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="n">buttonText</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>

<span class="k">let</span> <span class="n">stepNavigation</span>  <span class="p">(</span><span class="n">player</span><span class="p">:</span> <span class="nc">Player</span><span class="p">)</span> <span class="p">(</span><span class="n">playerBoard</span><span class="p">:</span> <span class="nc">PlayerBoard</span><span class="p">)</span> <span class="p">(</span><span class="n">gameState</span> <span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="n">dispatch</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">gameState</span><span class="p">.</span><span class="nc">CurrentStep</span> <span class="k">with</span>
    <span class="p">|</span>  <span class="nn">GameStep</span><span class="p">.</span><span class="nc">Draw</span> <span class="n">d</span> <span class="k">when</span> <span class="n">d</span> <span class="p">=</span> <span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">-&gt;</span>
            <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"field is-grouped has-addons is-grouped-right"</span> <span class="p">]</span>
                        <span class="p">[</span>
                            <span class="p">(</span><span class="n">renderStepOptionButton</span> <span class="n">dispatch</span> <span class="s2">"Draw"</span> <span class="s2">"is-warning"</span> <span class="o">(({</span> <span class="nc">GameId</span> <span class="p">=</span> <span class="n">gameState</span><span class="p">.</span><span class="nc">GameId</span><span class="p">;</span> <span class="nc">PlayerId</span> <span class="p">=</span> <span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">;</span> <span class="p">}</span> <span class="p">:</span> <span class="nc">DrawCardEvent</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nc">DrawCard</span><span class="p">)</span> <span class="p">)</span>
                            <span class="p">]</span> <span class="p">]</span>
    <span class="p">|</span>  <span class="nn">GameStep</span><span class="p">.</span><span class="nc">Play</span> <span class="n">d</span> <span class="k">when</span> <span class="n">d</span> <span class="p">=</span> <span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">-&gt;</span>
            <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"field is-grouped has-addons is-grouped-right"</span> <span class="p">]</span>
                        <span class="p">[</span>
                            <span class="p">(</span><span class="n">renderStepOptionButton</span> <span class="n">dispatch</span> <span class="s2">"End Play"</span> <span class="s2">"is-danger"</span> <span class="o">(({</span> <span class="nc">GameId</span> <span class="p">=</span> <span class="n">gameState</span><span class="p">.</span><span class="nc">GameId</span><span class="p">;</span> <span class="nc">PlayerId</span> <span class="p">=</span> <span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">;</span> <span class="p">}</span> <span class="p">:</span> <span class="nc">EndPlayStepEvent</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nc">EndPlayStep</span><span class="p">)</span> <span class="p">)</span>
                            <span class="p">]</span> <span class="p">]</span>
    <span class="p">|</span>  <span class="nn">GameStep</span><span class="p">.</span><span class="nc">Attack</span> <span class="n">d</span> <span class="k">when</span> <span class="n">d</span> <span class="p">=</span> <span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">-&gt;</span>
            <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"field is-grouped has-addons is-grouped-right"</span> <span class="p">]</span>
                        <span class="p">[</span>
                            <span class="p">(</span><span class="n">renderStepOptionButton</span> <span class="n">dispatch</span> <span class="s2">"Skip Attack"</span> <span class="s2">"is-danger"</span> <span class="o">(({</span> <span class="nc">GameId</span> <span class="p">=</span> <span class="n">gameState</span><span class="p">.</span><span class="nc">GameId</span><span class="p">;</span> <span class="nc">PlayerId</span> <span class="p">=</span> <span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">;</span> <span class="p">}</span> <span class="p">:</span> <span class="nc">SkipAttackEvent</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nc">SkipAttack</span><span class="p">)</span> <span class="p">)</span>
                        <span class="p">]</span> <span class="p">]</span>
    <span class="p">|</span>  <span class="nn">GameStep</span><span class="p">.</span><span class="nc">Reconcile</span> <span class="n">d</span> <span class="k">when</span> <span class="n">d</span> <span class="p">=</span> <span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">-&gt;</span>
            <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"field is-grouped has-addons is-grouped-right"</span> <span class="p">]</span>
                        <span class="p">[</span>
                            <span class="p">(</span><span class="n">renderStepOptionButton</span> <span class="n">dispatch</span> <span class="s2">"End Turn"</span> <span class="s2">"is-danger"</span> <span class="o">(({</span> <span class="nc">GameId</span> <span class="p">=</span> <span class="n">gameState</span><span class="p">.</span><span class="nc">GameId</span><span class="p">;</span> <span class="nc">PlayerId</span> <span class="p">=</span> <span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">;</span> <span class="p">}</span> <span class="p">:</span> <span class="nc">EndTurnEvent</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nc">EndTurn</span><span class="p">)</span> <span class="p">)</span>
                        <span class="p">]</span> <span class="p">]</span>
    <span class="p">|</span>  <span class="nn">GameStep</span><span class="p">.</span><span class="nc">NotCurrentlyPlaying</span> <span class="p">-&gt;</span>
            <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"field is-grouped has-addons is-grouped-right"</span> <span class="p">]</span>
                        <span class="p">[</span>
                            <span class="p">(</span><span class="n">renderStepOptionButton</span> <span class="n">dispatch</span> <span class="s2">"Start New Game"</span> <span class="s2">"is-danger"</span> <span class="o">(({</span> <span class="nc">GameId</span> <span class="p">=</span> <span class="n">gameState</span><span class="p">.</span><span class="nc">GameId</span><span class="p">;</span> <span class="nc">PlayerId</span> <span class="p">=</span> <span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">;</span> <span class="p">}</span> <span class="p">:</span> <span class="nc">EndTurnEvent</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nc">EndTurn</span><span class="p">)</span> <span class="p">)</span>
                        <span class="p">]</span> <span class="p">]</span>
    <span class="p">|</span>  <span class="nn">GameStep</span><span class="p">.</span><span class="nc">GameOver</span> <span class="n">g</span> <span class="p">-&gt;</span>
            <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"field is-grouped has-addons is-grouped-right"</span> <span class="p">]</span>
                        <span class="p">[</span>
                            <span class="p">(</span><span class="n">renderStepOptionButton</span> <span class="n">dispatch</span> <span class="s2">"Start New Game"</span> <span class="s2">"is-danger"</span> <span class="o">(({</span> <span class="nc">GameId</span> <span class="p">=</span> <span class="n">gameState</span><span class="p">.</span><span class="nc">GameId</span><span class="p">;</span> <span class="nc">PlayerId</span> <span class="p">=</span> <span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">;</span> <span class="p">}</span> <span class="p">:</span> <span class="nc">EndTurnEvent</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nc">EndTurn</span><span class="p">)</span> <span class="p">)</span>
                        <span class="p">]</span> <span class="p">]</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">div</span> <span class="bp">[]</span> <span class="bp">[]</span></code></pre></figure>

<p>Now I can see I start on the draw stage and am able to draw but that is not transitioning me to the next step. I will have to investigate the <code class="language-plaintext highlighter-rouge">modifyGameStateFromDrawCardEvent</code> function.</p>

<p>Investigating this function it appears I forgot to add the state shifting functionality.</p>

<p>I implemented this by changing the <code class="language-plaintext highlighter-rouge">modifyGameStateFromDrawCardEvent</code> function like</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">migrateGameStateToNewStep</span> <span class="n">newStep</span> <span class="p">(</span><span class="n">gs</span><span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">=</span>
    <span class="c1">// maybe some vaidation could go here?</span>
    <span class="nc">Ok</span> <span class="p">{</span>
        <span class="n">gs</span> <span class="k">with</span> <span class="nc">CurrentStep</span> <span class="p">=</span> <span class="n">newStep</span>
    <span class="p">}</span>

<span class="k">let</span> <span class="n">moveCardsFromDeckToHand</span> <span class="n">gs</span> <span class="n">playerId</span> <span class="n">pb</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">newDeck</span><span class="p">,</span> <span class="n">newHand</span> <span class="p">=</span>  <span class="n">drawCardsFromDeck</span> <span class="mi">1</span> <span class="n">pb</span><span class="p">.</span><span class="nc">Deck</span> <span class="n">pb</span><span class="p">.</span><span class="nc">Hand</span>
    <span class="nc">Ok</span> <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">Boards</span> <span class="p">=</span> <span class="p">(</span><span class="n">gs</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">Add</span> <span class="p">(</span><span class="n">playerId</span><span class="p">,</span> <span class="p">{</span> <span class="n">pb</span> <span class="k">with</span> <span class="nc">Deck</span> <span class="p">=</span> <span class="n">newDeck</span><span class="p">;</span> <span class="nc">Hand</span> <span class="p">=</span> <span class="n">newHand</span> <span class="o">})</span>  <span class="p">)</span> <span class="p">}</span>


<span class="k">let</span> <span class="n">modifyGameStateFromDrawCardEvent</span> <span class="p">(</span><span class="n">ev</span><span class="p">:</span> <span class="nc">DrawCardEvent</span><span class="p">)</span> <span class="p">(</span><span class="n">gs</span><span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">getExistingPlayerBoardFromGameState</span> <span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="n">gs</span>
    <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">moveCardsFromDeckToHand</span> <span class="n">gs</span> <span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">migrateGameStateToNewStep</span> <span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">|&gt;</span> <span class="nc">Attack</span><span class="o">))</span>
    <span class="p">|&gt;</span> <span class="k">function</span>
        <span class="p">|</span> <span class="nc">Ok</span> <span class="n">g</span> <span class="p">-&gt;</span> <span class="n">g</span>
        <span class="p">|</span> <span class="nc">Error</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">NotificationMessages</span> <span class="p">=</span> <span class="n">appendNotificationMessageToListOrCreateList</span> <span class="n">gs</span><span class="p">.</span><span class="nc">NotificationMessages</span> <span class="n">e</span> <span class="p">}</span></code></pre></figure>

<p>Refreshing the site I am not able to click through all the steps of my turn!</p>

<p>I am leaving this as the final commit of branch <code class="language-plaintext highlighter-rouge">step-10-better-sample-data-and-wiring-up-ui-cont</code>.</p>

<p><a href="https://github.com/jamesclancy/SafeCardGame/tree/step-10-better-sample-data-and-wiring-up-ui-cont">Git branch for this step</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/projects/safecardgame/2021/05/29/Step8WireUpEventsToModifyGameState/">
        SafeCardGame - Step 8 - Wire up events to modify GameState
      </a>
    </h1>

    <span class="post-date">29 May 2021</span>

    <p>In the next step/section I will be wiring up the events to actually modify the game state. Finally, we will be removing the <code class="language-plaintext highlighter-rouge">GameStarted</code> event and replace the initializing function with a hydrated <code class="language-plaintext highlighter-rouge">StartGame</code> event.</p>

<h3 id="wire-up-events-to-modify-gamestate">Wire up events to modify GameState</h3>
<hr />

<p>These updates to the gamestate will occur in the update function of the client Index.fs</p>

<p>First I scaffolded out the update function like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">update</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nc">Msg</span><span class="p">)</span> <span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nc">GameState</span><span class="o">):</span> <span class="nc">GameState</span> <span class="p">*</span> <span class="nc">Cmd</span><span class="p">&lt;</span><span class="nc">Msg</span><span class="p">&gt;</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">GameStarted</span> <span class="p">-&gt;</span>
        <span class="n">model</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
    <span class="p">|</span> <span class="nc">StartGame</span> <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="n">model</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
    <span class="p">|</span> <span class="nc">DrawCard</span>  <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="n">model</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
    <span class="p">|</span> <span class="nc">DiscardCard</span> <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="n">model</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
    <span class="p">|</span> <span class="nc">PlayCard</span> <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="n">model</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
    <span class="p">|</span> <span class="nc">EndPlayStep</span> <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="n">model</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
    <span class="p">|</span> <span class="nc">PerformAttack</span>  <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="n">model</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
    <span class="p">|</span> <span class="nc">SkipAttack</span> <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="n">model</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
    <span class="p">|</span> <span class="nc">EndTurn</span> <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="n">model</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span>
    <span class="p">|</span> <span class="nc">GameWon</span> <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="n">model</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span></code></pre></figure>

<p>First I will implement to <code class="language-plaintext highlighter-rouge">StartGame</code> handler.</p>

<p>In order to do this I first created a <code class="language-plaintext highlighter-rouge">takeDeckDealFirstHandAndReturnNewPlayerBoard</code> function:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">takeDeckDealFirstHandAndReturnNewPlayerBoard</span> <span class="p">(</span><span class="n">intitalHandSize</span><span class="p">:</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">playerId</span> <span class="p">:</span> <span class="nc">PlayerId</span><span class="p">)</span> <span class="p">(</span><span class="n">deck</span> <span class="p">:</span> <span class="nc">Deck</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">emptyHand</span> <span class="p">=</span>
      <span class="p">{</span>
        <span class="nc">Cards</span> <span class="p">=</span> <span class="kt">list</span><span class="p">.</span><span class="nc">Empty</span>
      <span class="p">}</span>
    <span class="k">let</span> <span class="n">deckAfterDraw</span><span class="p">,</span> <span class="n">hand</span> <span class="p">=</span> <span class="n">drawCardsFromDeck</span> <span class="n">intitalHandSize</span> <span class="n">deck</span> <span class="n">emptyHand</span>

    <span class="p">{</span>
        <span class="nc">PlayerId</span><span class="p">=</span>  <span class="n">playerId</span>
        <span class="nc">Deck</span><span class="p">=</span> <span class="n">deckAfterDraw</span>
        <span class="nc">Hand</span><span class="p">=</span><span class="n">hand</span>
        <span class="nc">ActiveCreature</span><span class="p">=</span> <span class="nc">None</span>
        <span class="nc">Bench</span><span class="p">=</span>  <span class="nc">None</span>
        <span class="nc">DiscardPile</span><span class="p">=</span> <span class="p">{</span>
            <span class="nc">TopCardsExposed</span> <span class="p">=</span> <span class="mi">0</span>
            <span class="nc">Cards</span> <span class="p">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">empty</span>
        <span class="p">}</span>
        <span class="nc">TotalResourcePool</span><span class="p">=</span> <span class="nc">ResourcePool</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span>
        <span class="nc">AvailableResourcePool</span> <span class="p">=</span>  <span class="nc">ResourcePool</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span>
    <span class="p">}</span></code></pre></figure>

<p>This references a new function to draw cards:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">drawCardsFromDeck</span> <span class="p">(</span><span class="n">cardsToDraw</span><span class="p">:</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">deck</span> <span class="p">:</span> <span class="nc">Deck</span><span class="p">)</span> <span class="p">(</span><span class="n">hand</span><span class="p">:</span> <span class="nc">Hand</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">if</span> <span class="n">deck</span><span class="p">.</span><span class="nn">Cards</span><span class="p">.</span><span class="nc">IsEmpty</span> <span class="k">then</span>
        <span class="n">deck</span><span class="p">,</span> <span class="n">hand</span>
    <span class="k">else</span>
        <span class="k">let</span> <span class="n">cardsToTake</span> <span class="p">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">truncate</span> <span class="n">cardsToDraw</span> <span class="n">deck</span><span class="p">.</span><span class="nc">Cards</span>
        <span class="p">{</span> <span class="n">deck</span> <span class="k">with</span> <span class="nc">Cards</span> <span class="p">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">skip</span> <span class="n">cardsToTake</span><span class="p">.</span><span class="nc">Length</span> <span class="n">deck</span><span class="p">.</span><span class="nc">Cards</span><span class="o">},</span> <span class="p">{</span><span class="n">hand</span> <span class="k">with</span> <span class="nc">Cards</span> <span class="p">=</span> <span class="n">hand</span><span class="p">.</span><span class="nc">Cards</span> <span class="o">@</span> <span class="n">cardsToTake</span><span class="p">}</span></code></pre></figure>

<p>Then I was able to initialize the state as:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">intitalizeGameStateFromStartGameEvent</span> <span class="p">(</span><span class="n">ev</span> <span class="p">:</span> <span class="nc">StartGameEvent</span><span class="p">)</span> <span class="p">=</span>
            <span class="p">{</span>
                <span class="nc">GameId</span><span class="p">=</span> <span class="n">ev</span><span class="p">.</span><span class="nc">GameId</span>
                <span class="nc">NotificationMessages</span><span class="p">=</span> <span class="nc">None</span>
                <span class="nc">CurrentPlayer</span><span class="p">=</span> <span class="n">ev</span><span class="p">.</span><span class="nc">CurrentPlayer</span>
                <span class="nc">OpponentPlayer</span><span class="p">=</span> <span class="n">ev</span><span class="p">.</span><span class="nc">OpponentPlayer</span>
                <span class="nc">Players</span><span class="p">=</span> <span class="n">ev</span><span class="p">.</span><span class="nc">Players</span>
                <span class="nc">Boards</span><span class="p">=</span> <span class="n">ev</span><span class="p">.</span><span class="nc">Decks</span>
                        <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">Key</span><span class="p">,</span> <span class="n">takeDeckDealFirstHandAndReturnNewPlayerBoard</span> <span class="mi">7</span> <span class="n">x</span><span class="p">.</span><span class="nc">Key</span> <span class="n">x</span><span class="p">.</span><span class="nc">Value</span> <span class="p">)</span>
                        <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">ofSeq</span>
                <span class="nc">CurrentStep</span><span class="p">=</span> <span class="n">ev</span><span class="p">.</span><span class="nc">CurrentPlayer</span> <span class="p">|&gt;</span> <span class="nc">Draw</span>
                <span class="nc">TurnNumber</span><span class="p">=</span> <span class="mi">1</span>
            <span class="p">}</span></code></pre></figure>

<p>Then I just have to call intitalizeGameStateFromStartGameEvent from my update match statement.</p>

<p>Using the same draw function I can implement the draw event.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">appendNotificationMessageToListOrCreateList</span> <span class="p">(</span><span class="n">existingNotifications</span> <span class="p">:</span> <span class="nc">Option</span><span class="p">&lt;</span><span class="nc">Notification</span> <span class="kt">list</span><span class="p">)</span> <span class="p">(</span><span class="n">newNotification</span> <span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">existingNotifications</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="n">nl</span> <span class="p">-&gt;</span>
        <span class="n">newNotification</span>
        <span class="p">|&gt;</span> <span class="nc">Notification</span>
        <span class="p">|&gt;</span> <span class="p">(</span><span class="k">fun</span> <span class="n">y</span> <span class="p">-&gt;</span> <span class="n">y</span> <span class="p">::</span> <span class="n">nl</span><span class="p">)</span>
        <span class="p">|&gt;</span> <span class="nc">Some</span>
    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span>
        <span class="p">[</span> <span class="p">(</span><span class="n">newNotification</span> <span class="p">|&gt;</span> <span class="nc">Notification</span><span class="p">)</span> <span class="p">]</span>
        <span class="p">|&gt;</span> <span class="nc">Some</span>

<span class="k">let</span> <span class="n">modifyGameStateFromDrawCardEvent</span> <span class="p">(</span><span class="n">ev</span><span class="p">:</span> <span class="nc">DrawCardEvent</span><span class="p">)</span> <span class="p">(</span><span class="n">gs</span><span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">gs</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">TryGetValue</span> <span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="k">with</span>
    <span class="p">|</span> <span class="bp">true</span><span class="p">,</span> <span class="n">pb</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">newDeck</span><span class="p">,</span> <span class="n">newHand</span> <span class="p">=</span>  <span class="n">drawCardsFromDeck</span> <span class="mi">1</span> <span class="n">pb</span><span class="p">.</span><span class="nc">Deck</span> <span class="n">pb</span><span class="p">.</span><span class="nc">Hand</span>
        <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">Boards</span> <span class="p">=</span> <span class="p">(</span><span class="n">gs</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">Add</span> <span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">,</span> <span class="p">{</span> <span class="n">pb</span> <span class="k">with</span> <span class="nc">Deck</span> <span class="p">=</span> <span class="n">newDeck</span><span class="p">;</span> <span class="nc">Hand</span> <span class="p">=</span> <span class="n">newHand</span> <span class="o">})</span>  <span class="p">)</span> <span class="p">}</span>
    <span class="p">|</span> <span class="bp">false</span><span class="p">,</span> <span class="p">_</span> <span class="p">-&gt;</span>
        <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">NotificationMessages</span> <span class="p">=</span> <span class="n">appendNotificationMessageToListOrCreateList</span> <span class="n">gs</span><span class="p">.</span><span class="nc">NotificationMessages</span> <span class="s2">"Unable to lookup player board"</span> <span class="p">}</span></code></pre></figure>

<p>I realize there has to be a better way to pipe into a list than <code class="language-plaintext highlighter-rouge">|&gt; (fun y -&gt; y :: nl)</code> but I am just going to leave that for now.</p>

<p>Discard card is next. I noticed a typo in the name <code class="language-plaintext highlighter-rouge">CardInstanceId</code> so I corrected that. Also, I notice I will similarly have to pull the player board from the state so I should extract that to be a function like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">getExistingPlayerBoardFromGameState</span> <span class="n">playerId</span> <span class="n">gs</span> <span class="p">=</span>
 <span class="k">match</span> <span class="n">gs</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">TryGetValue</span> <span class="n">playerId</span> <span class="k">with</span>
    <span class="p">|</span> <span class="bp">true</span><span class="p">,</span> <span class="n">pb</span> <span class="p">-&gt;</span>
        <span class="n">pb</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>
    <span class="p">|</span> <span class="bp">false</span><span class="p">,</span> <span class="p">_</span> <span class="p">-&gt;</span>
        <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Unable to locate player board for player id %s"</span> <span class="p">(</span><span class="n">playerId</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="o">))</span> <span class="p">|&gt;</span> <span class="nc">Error</span></code></pre></figure>

<p>I am then able to implement a discardCardFromBoard function like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">discardCardFromBoard</span> <span class="p">(</span><span class="n">cardInstanceId</span> <span class="p">:</span> <span class="nc">CardInstanceId</span><span class="p">)</span> <span class="p">(</span><span class="n">playerBoard</span> <span class="p">:</span> <span class="nc">PlayerBoard</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">cardToDiscard</span> <span class="p">:</span> <span class="nc">CardInstance</span> <span class="kt">list</span> <span class="p">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">CardInstanceId</span> <span class="p">=</span> <span class="n">cardInstanceId</span><span class="p">)</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">Hand</span><span class="p">.</span><span class="nc">Cards</span>

    <span class="k">match</span> <span class="n">cardToDiscard</span> <span class="k">with</span>
    <span class="p">|</span> <span class="bp">[]</span> <span class="p">-&gt;</span>
        <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Unable to locate card in hand with card instance id %s"</span> <span class="p">(</span><span class="n">cardInstanceId</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="o">))</span> <span class="p">|&gt;</span> <span class="nc">Error</span>
    <span class="p">|</span> <span class="p">[</span> <span class="n">x</span> <span class="p">]</span> <span class="p">-&gt;</span>
            <span class="p">{</span>
                <span class="n">playerBoard</span>
                    <span class="k">with</span> <span class="nc">Hand</span> <span class="p">=</span>
                          <span class="p">{</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">Hand</span> <span class="k">with</span>

                                <span class="nc">Cards</span> <span class="p">=</span> <span class="p">(</span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">CardInstanceId</span> <span class="p">=</span> <span class="n">cardInstanceId</span><span class="p">)</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">Hand</span><span class="p">.</span><span class="nc">Cards</span><span class="p">)</span>

                          <span class="o">};</span>
                         <span class="nc">DiscardPile</span> <span class="o">={</span><span class="n">playerBoard</span><span class="p">.</span><span class="nc">DiscardPile</span> <span class="k">with</span> <span class="nc">Cards</span> <span class="p">=</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">DiscardPile</span><span class="p">.</span><span class="nc">Cards</span> <span class="o">@</span> <span class="p">[</span> <span class="n">x</span> <span class="p">]</span> <span class="p">}</span>
            <span class="p">}</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span>
        <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"ERROR: located multiple cards in hand with card instance id %s. This shouldn't happen"</span> <span class="p">(</span><span class="n">cardInstanceId</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="o">))</span> <span class="p">|&gt;</span> <span class="nc">Error</span>

<span class="k">let</span> <span class="n">modifyGameStateFromDiscardCardEvent</span> <span class="p">(</span><span class="n">ev</span><span class="p">:</span> <span class="nc">DiscardCardEvent</span><span class="p">)</span> <span class="p">(</span><span class="n">gs</span><span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">newBoard</span> <span class="p">=</span>
        <span class="n">getExistingPlayerBoardFromGameState</span> <span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="n">gs</span>
        <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">discardCardFromBoard</span> <span class="n">ev</span><span class="p">.</span><span class="nc">CardInstanceId</span><span class="p">)</span>

    <span class="k">match</span> <span class="n">newBoard</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Ok</span> <span class="n">pb</span> <span class="p">-&gt;</span>
        <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">Boards</span> <span class="p">=</span> <span class="p">(</span><span class="n">gs</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">Add</span> <span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">,</span> <span class="n">pb</span><span class="p">)</span>  <span class="p">)</span> <span class="p">}</span>
    <span class="p">|</span> <span class="nc">Error</span> <span class="n">e</span> <span class="p">-&gt;</span>
        <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">NotificationMessages</span> <span class="p">=</span> <span class="n">appendNotificationMessageToListOrCreateList</span> <span class="n">gs</span><span class="p">.</span><span class="nc">NotificationMessages</span> <span class="n">e</span> <span class="p">}</span></code></pre></figure>

<p>The end play step should just move the player to the Attack step like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">    <span class="p">|</span> <span class="nc">EndPlayStep</span> <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="p">{</span> <span class="n">model</span> <span class="k">with</span> <span class="nc">CurrentStep</span> <span class="p">=</span> <span class="p">(</span><span class="nc">Attack</span> <span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span><span class="o">)},</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span></code></pre></figure>

<p>Similarly, SkipAttack should just move the player to the Reconcile step.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">    <span class="p">|</span> <span class="nc">SkipAttack</span> <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="p">{</span> <span class="n">model</span> <span class="k">with</span> <span class="nc">CurrentStep</span> <span class="p">=</span> <span class="p">(</span><span class="nc">Reconcile</span> <span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span><span class="o">)},</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span></code></pre></figure>

<p>EndTurn should just move the game to the draw step of the other player.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">    <span class="p">|</span> <span class="nc">EndTurn</span> <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">otherPlayer</span> <span class="p">=</span> <span class="n">getTheOtherPlayer</span> <span class="n">model</span> <span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span>
        <span class="p">{</span> <span class="n">model</span> <span class="k">with</span> <span class="nc">CurrentStep</span> <span class="p">=</span> <span class="p">(</span><span class="nc">Draw</span> <span class="n">otherPlayer</span><span class="o">)},</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span></code></pre></figure>

<p>Game Won should transition to the GameOverState, set a winner and a message but I will first have to define a function to format the GameOverMessage like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">formatGameOverMessage</span> <span class="p">(</span><span class="n">notifications</span> <span class="p">:</span> <span class="nc">Option</span><span class="p">&lt;</span><span class="nc">Notification</span> <span class="kt">list</span><span class="o">&gt;)</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">notifications</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span>
        <span class="s2">"Game Over for unknown reason"</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="bp">[]</span> <span class="p">-&gt;</span>
        <span class="s2">"Game Over for unknown reason"</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="n">x</span> <span class="p">-&gt;</span>
        <span class="n">x</span>
        <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="p">)</span>
        <span class="p">|&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">";"</span></code></pre></figure>

<p>then I can</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">    <span class="p">|</span> <span class="nc">GameWon</span> <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">newStep</span> <span class="p">=</span>  <span class="p">{</span> <span class="nc">WinnerId</span> <span class="p">=</span>  <span class="n">ev</span><span class="p">.</span><span class="nc">Winner</span><span class="p">;</span> <span class="nc">Message</span> <span class="p">=</span> <span class="n">formatGameOverMessage</span> <span class="n">ev</span><span class="p">.</span><span class="nc">Message</span> <span class="p">}</span> <span class="p">|&gt;</span> <span class="nc">GameOver</span>
        <span class="p">{</span> <span class="n">model</span> <span class="k">with</span> <span class="nc">CurrentStep</span> <span class="p">=</span> <span class="n">newStep</span><span class="o">},</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span></code></pre></figure>

<p>This involved some copypasta which could be removed and refactored but I am just going to keep driving on for now.</p>

<p>This now just leaves me to complete the play card and attack events.</p>

<p>For the play card action, I will need to implement a variety of functions. These will require refactoring but just to get something down I added</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">applyEffectIfDefinied</span> <span class="n">effect</span> <span class="n">gs</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">effect</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="n">e</span><span class="p">.</span><span class="nn">Function</span><span class="p">.</span><span class="nc">Invoke</span> <span class="n">gs</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>
    <span class="p">|</span> <span class="nc">None</span>  <span class="p">-&gt;</span> <span class="n">gs</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>

<span class="k">let</span> <span class="n">currentResourceAmountFromPool</span> <span class="p">(</span><span class="n">resourcePool</span> <span class="p">:</span> <span class="nc">ResourcePool</span><span class="p">)</span> <span class="p">(</span><span class="n">resource</span> <span class="p">:</span> <span class="nc">Resource</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">resourcePool</span><span class="p">.</span><span class="nc">TryGetValue</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span> <span class="k">with</span>
    <span class="p">|</span> <span class="bp">true</span><span class="p">,</span> <span class="n">t</span> <span class="p">-&gt;</span> <span class="n">t</span>
    <span class="p">|</span> <span class="bp">false</span><span class="p">,</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="mi">0</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">addResourcesToPool</span> <span class="p">(</span><span class="n">rp1</span> <span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">Resource</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;)</span>  <span class="n">rp2</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">rp2</span> <span class="k">with</span>
    <span class="p">|</span> <span class="bp">[]</span> <span class="p">-&gt;</span>  <span class="n">rp1</span> <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">toSeq</span> <span class="p">|&gt;</span> <span class="nc">ResourcePool</span>
    <span class="p">|</span> <span class="p">[</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="p">]</span> <span class="p">-&gt;</span>
        <span class="n">rp1</span><span class="p">.</span><span class="nc">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">currentResourceAmountFromPool</span> <span class="n">rp1</span> <span class="n">x</span><span class="o">))</span>  <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">toSeq</span> <span class="p">|&gt;</span> <span class="nc">ResourcePool</span>
    <span class="p">|</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="p">::</span> <span class="n">xs</span>  <span class="p">-&gt;</span>
        <span class="n">addResourcesToPool</span> <span class="p">(</span><span class="n">rp1</span><span class="p">.</span><span class="nc">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>  <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">currentResourceAmountFromPool</span> <span class="n">rp1</span> <span class="n">x</span><span class="o">)))</span> <span class="n">xs</span>


<span class="k">let</span> <span class="n">createInPlayCreatureFromCardInstance</span> <span class="n">characterCard</span> <span class="n">inPlayCreatureId</span> <span class="p">=</span>
            <span class="p">{</span>
                <span class="nc">InPlayCharacterId</span><span class="p">=</span>  <span class="n">inPlayCreatureId</span>
                <span class="nc">Card</span> <span class="p">=</span> <span class="n">characterCard</span>
                <span class="nc">CurrentDamage</span><span class="p">=</span>  <span class="mi">0</span>
                <span class="nc">SpecialEffect</span><span class="p">=</span>  <span class="nc">None</span>
                <span class="nc">AttachedEnergy</span> <span class="p">=</span>  <span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span> <span class="p">|&gt;</span> <span class="nc">ResourcePool</span>
                <span class="nc">SpentEnergy</span> <span class="p">=</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span> <span class="p">|&gt;</span> <span class="nc">ResourcePool</span>
            <span class="p">}</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>

<span class="k">let</span> <span class="n">appendCreatureToPlayerBoard</span> <span class="n">inPlayCreature</span> <span class="n">playerBoard</span> <span class="p">=</span>
        <span class="k">match</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">ActiveCreature</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span>
            <span class="p">{</span> <span class="n">playerBoard</span> <span class="k">with</span> <span class="nc">ActiveCreature</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">inPlayCreature</span> <span class="p">}</span>
        <span class="p">|</span> <span class="nc">Some</span> <span class="n">a</span> <span class="p">-&gt;</span>
            <span class="p">{</span> <span class="n">playerBoard</span>
                <span class="k">with</span> <span class="nc">Bench</span>
                    <span class="p">=</span> <span class="nc">Some</span> <span class="p">(</span><span class="nn">Option</span><span class="p">.</span><span class="n">fold</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="p">-&gt;</span> <span class="n">x</span> <span class="o">@</span> <span class="n">y</span><span class="p">)</span>  <span class="p">[</span> <span class="n">inPlayCreature</span> <span class="p">]</span>  <span class="n">playerBoard</span><span class="p">.</span><span class="nc">Bench</span><span class="p">)</span>  <span class="p">}</span>


<span class="k">let</span> <span class="n">addCreatureToGameState</span> <span class="n">cardInstanceId</span> <span class="n">x</span> <span class="n">playerId</span> <span class="n">gs</span> <span class="n">playerBoard</span> <span class="n">inPlayCreature</span><span class="p">=</span>
        <span class="k">let</span> <span class="n">playerBoard</span> <span class="p">=</span>
                        <span class="p">{</span>
                            <span class="n">playerBoard</span>
                                <span class="k">with</span> <span class="nc">Hand</span> <span class="p">=</span>
                                        <span class="p">{</span>
                                          <span class="n">playerBoard</span><span class="p">.</span><span class="nc">Hand</span> <span class="k">with</span>
                                            <span class="nc">Cards</span> <span class="p">=</span> <span class="p">(</span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">CardInstanceId</span> <span class="p">=</span> <span class="n">cardInstanceId</span><span class="p">)</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">Hand</span><span class="p">.</span><span class="nc">Cards</span><span class="p">)</span>
                                        <span class="o">};</span>
                                     <span class="nc">DiscardPile</span> <span class="o">={</span><span class="n">playerBoard</span><span class="p">.</span><span class="nc">DiscardPile</span> <span class="k">with</span> <span class="nc">Cards</span> <span class="p">=</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">DiscardPile</span><span class="p">.</span><span class="nc">Cards</span> <span class="o">@</span> <span class="p">[</span> <span class="n">x</span> <span class="p">]</span> <span class="p">}</span>
                        <span class="p">}</span> <span class="p">|&gt;</span> <span class="p">(</span><span class="n">appendCreatureToPlayerBoard</span> <span class="n">inPlayCreature</span><span class="p">)</span>

        <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">Boards</span> <span class="p">=</span> <span class="n">gs</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">Add</span> <span class="p">(</span> <span class="n">playerId</span><span class="p">,</span> <span class="n">playerBoard</span><span class="p">)</span> <span class="p">}</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>

<span class="k">let</span> <span class="n">buildInPlayCreatureId</span> <span class="n">idStr</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">res</span> <span class="p">=</span> <span class="n">idStr</span> <span class="p">|&gt;</span> <span class="nn">NonEmptyString</span><span class="p">.</span><span class="n">build</span>

    <span class="k">match</span> <span class="n">res</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Ok</span> <span class="n">r</span> <span class="p">-&gt;</span> <span class="nc">InPlayCreatureId</span> <span class="n">r</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>
    <span class="p">|</span> <span class="nc">Error</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="nc">Error</span> <span class="n">e</span>


<span class="k">let</span> <span class="n">playCardFromBoard</span> <span class="p">(</span><span class="n">cardInstanceId</span> <span class="p">:</span> <span class="nc">CardInstanceId</span><span class="p">)</span> <span class="p">(</span><span class="n">playerId</span> <span class="p">:</span> <span class="nc">PlayerId</span><span class="p">)</span> <span class="p">(</span><span class="n">gs</span><span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">(</span><span class="n">playerBoard</span> <span class="p">:</span> <span class="nc">PlayerBoard</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">cardToDiscard</span> <span class="p">:</span> <span class="nc">CardInstance</span> <span class="kt">list</span> <span class="p">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">CardInstanceId</span> <span class="p">=</span> <span class="n">cardInstanceId</span><span class="p">)</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">Hand</span><span class="p">.</span><span class="nc">Cards</span>

    <span class="k">match</span> <span class="n">cardToDiscard</span> <span class="k">with</span>
    <span class="p">|</span> <span class="bp">[]</span> <span class="p">-&gt;</span>
        <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Unable to locate card in hand with card instance id %s"</span> <span class="p">(</span><span class="n">cardInstanceId</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="o">))</span> <span class="p">|&gt;</span> <span class="nc">Error</span>
    <span class="p">|</span> <span class="p">[</span> <span class="n">x</span> <span class="p">]</span> <span class="p">-&gt;</span>
            <span class="k">match</span> <span class="n">x</span><span class="p">.</span><span class="nc">Card</span> <span class="k">with</span>
            <span class="p">|</span> <span class="nc">CharacterCard</span> <span class="n">cc</span> <span class="p">-&gt;</span>

              <span class="nn">System</span><span class="p">.</span><span class="nn">Guid</span><span class="p">.</span><span class="nc">NewGuid</span><span class="bp">()</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>
              <span class="p">|&gt;</span> <span class="n">buildInPlayCreatureId</span>
              <span class="p">|&gt;</span> <span class="p">(</span><span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">createInPlayCreatureFromCardInstance</span> <span class="n">x</span><span class="p">.</span><span class="nc">Card</span><span class="o">))</span>
              <span class="p">|&gt;</span> <span class="p">(</span><span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">addCreatureToGameState</span> <span class="n">cardInstanceId</span> <span class="n">x</span> <span class="n">playerId</span> <span class="n">gs</span> <span class="n">playerBoard</span><span class="o">))</span>
              <span class="p">|&gt;</span> <span class="p">(</span><span class="nn">Result</span><span class="p">.</span><span class="n">bind</span>  <span class="p">(</span><span class="n">applyEffectIfDefinied</span> <span class="n">cc</span><span class="p">.</span><span class="nc">EnterSpecialEffects</span><span class="o">))</span>

            <span class="p">|</span> <span class="nc">ResourceCard</span> <span class="n">rc</span> <span class="p">-&gt;</span>
              <span class="k">let</span> <span class="n">newPb</span> <span class="p">=</span> <span class="p">{</span>
                  <span class="n">playerBoard</span>
                    <span class="k">with</span> <span class="nc">Hand</span> <span class="p">=</span>
                          <span class="p">{</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">Hand</span> <span class="k">with</span>

                                <span class="nc">Cards</span> <span class="p">=</span> <span class="p">(</span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">CardInstanceId</span> <span class="p">=</span> <span class="n">cardInstanceId</span><span class="p">)</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">Hand</span><span class="p">.</span><span class="nc">Cards</span><span class="p">)</span>
                          <span class="o">};</span>
                         <span class="nc">TotalResourcePool</span> <span class="p">=</span> <span class="n">addResourcesToPool</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">TotalResourcePool</span> <span class="p">(</span><span class="nn">Map</span><span class="p">.</span><span class="n">toList</span> <span class="n">rc</span><span class="p">.</span><span class="nc">ResourcesAdded</span><span class="p">)</span>
                         <span class="nc">DiscardPile</span> <span class="o">={</span><span class="n">playerBoard</span><span class="p">.</span><span class="nc">DiscardPile</span> <span class="k">with</span> <span class="nc">Cards</span> <span class="p">=</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">DiscardPile</span><span class="p">.</span><span class="nc">Cards</span> <span class="o">@</span> <span class="p">[</span> <span class="n">x</span> <span class="p">]</span> <span class="p">}</span>
                <span class="p">}</span>
              <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">Boards</span> <span class="p">=</span> <span class="p">(</span><span class="n">gs</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">Add</span> <span class="p">(</span><span class="n">playerId</span><span class="p">,</span> <span class="n">newPb</span><span class="o">))</span> <span class="p">}</span> <span class="p">|&gt;</span> <span class="p">(</span><span class="n">applyEffectIfDefinied</span> <span class="n">rc</span><span class="p">.</span><span class="nc">EnterSpecialEffects</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">applyEffectIfDefinied</span> <span class="n">rc</span><span class="p">.</span><span class="nc">ExitSpecialEffects</span><span class="p">)</span>
            <span class="p">|</span> <span class="nc">EffectCard</span> <span class="n">ec</span> <span class="p">-&gt;</span>
              <span class="k">let</span> <span class="n">newPb</span> <span class="p">=</span>  <span class="p">{</span>
                  <span class="n">playerBoard</span>
                    <span class="k">with</span> <span class="nc">Hand</span> <span class="p">=</span>
                          <span class="p">{</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">Hand</span> <span class="k">with</span>

                                <span class="nc">Cards</span> <span class="p">=</span> <span class="p">(</span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">CardInstanceId</span> <span class="p">=</span> <span class="n">cardInstanceId</span><span class="p">)</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">Hand</span><span class="p">.</span><span class="nc">Cards</span><span class="p">)</span>
                          <span class="o">};</span>
                         <span class="nc">DiscardPile</span> <span class="p">=</span> <span class="p">{</span><span class="n">playerBoard</span><span class="p">.</span><span class="nc">DiscardPile</span> <span class="k">with</span> <span class="nc">Cards</span> <span class="p">=</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">DiscardPile</span><span class="p">.</span><span class="nc">Cards</span> <span class="o">@</span> <span class="p">[</span> <span class="n">x</span> <span class="p">]</span> <span class="p">}</span>
                <span class="p">}</span>
              <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">Boards</span> <span class="p">=</span> <span class="p">(</span><span class="n">gs</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">Add</span> <span class="p">(</span><span class="n">playerId</span><span class="p">,</span> <span class="n">newPb</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span> <span class="p">|&gt;</span> <span class="p">(</span><span class="n">applyEffectIfDefinied</span> <span class="n">ec</span><span class="p">.</span><span class="nc">EnterSpecialEffects</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">applyEffectIfDefinied</span> <span class="n">ec</span><span class="p">.</span><span class="nc">ExitSpecialEffects</span><span class="p">)</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span>
        <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"ERROR: located multiple cards in hand with card instance id %s. This shouldn't happen"</span> <span class="p">(</span><span class="n">cardInstanceId</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="o">))</span> <span class="p">|&gt;</span> <span class="nc">Error</span>


<span class="k">let</span> <span class="n">modifyGameStateFromPlayCardEvent</span> <span class="p">(</span><span class="n">ev</span><span class="p">:</span> <span class="nc">PlayCardEvent</span><span class="p">)</span> <span class="p">(</span><span class="n">gs</span><span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">newBoard</span> <span class="p">=</span>
        <span class="n">getExistingPlayerBoardFromGameState</span> <span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="n">gs</span>
        <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">playCardFromBoard</span>  <span class="n">ev</span><span class="p">.</span><span class="nc">CardInstanceId</span> <span class="n">ev</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="n">gs</span><span class="p">)</span>

    <span class="k">match</span> <span class="n">newBoard</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Ok</span> <span class="n">pb</span> <span class="p">-&gt;</span>
        <span class="n">pb</span>
    <span class="p">|</span> <span class="nc">Error</span> <span class="n">e</span> <span class="p">-&gt;</span>
        <span class="p">{</span> <span class="n">gs</span> <span class="k">with</span> <span class="nc">NotificationMessages</span> <span class="p">=</span> <span class="n">appendNotificationMessageToListOrCreateList</span> <span class="n">gs</span><span class="p">.</span><span class="nc">NotificationMessages</span> <span class="n">e</span> <span class="p">}</span></code></pre></figure>

<p>I am leaving the attack logic for later and am now focuses on testing to verify what I have done so far is working.</p>

<p>I am now interested in building a more realistic gamestate for testing.</p>

<p>This is the final commit in the branch <code class="language-plaintext highlighter-rouge">step-8-wire-up-events-to-update-game-step</code></p>

<p><a href="https://github.com/jamesclancy/SafeCardGame/tree/step-8-wire-up-events-to-update-game-step">Git branch for this step</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/projects/safecardgame/2021/05/26/Step7DefiningEventsToChangeTheGamestate/">
        SafeCardGame - Step 7 - Defining Events To Change the GameState
      </a>
    </h1>

    <span class="post-date">26 May 2021</span>

    <h3 id="defining-events-to-change-the-gamestate">Defining Events To Change the GameState</h3>
<hr />

<p>As players play the game they can perform a number of actions that trigger events that modify the GameState.</p>

<p><em>Note from a technical standpoint:</em> The GameState is actually immutable and never changes but rather a new GameState is generated from an acton and the previous state. This new state replaces the past state.</p>

<p>Initially, I am going to start just writing out some potential events which could happen during the game and the associated event data they would carry.</p>

<ul>
  <li>StartGame - Initializes a new game (Creates a new GameState)
    <ul>
      <li>A unique GameID</li>
      <li>Pair of Players with associated decks</li>
      <li>PlayerID of Player to start game</li>
    </ul>
  </li>
  <li>DrawCard - Moves the top card from the deck to the hand on the playboard referenced by the PlayerId
    <ul>
      <li>GameId</li>
      <li>PlayerId</li>
    </ul>
  </li>
  <li>DiscardCard - Move card with CardInstanceId from the playerboard’s hand to discard pile
    <ul>
      <li>GameId</li>
      <li>PlayerId</li>
      <li>CardInstanceID</li>
    </ul>
  </li>
  <li>PlayCard -
  If resources are available on the player’s board:
      remove the card from the player’s hand
      - if a resource card add to the total resource pool
      - if an effect card trigger the effect
      - if a character card creates an inplay creature and trigger the enter event. If no active create exists place the in-play creature in the active position otherwise place it on the bench.
  If the resources are not available add an error message to the gamestate
    <ul>
      <li>GameId</li>
      <li>PlayerId</li>
      <li>CardInstanceID</li>
    </ul>
  </li>
  <li>EndPlayStep - Move the gamestate to the attack state
    <ul>
      <li>GameId</li>
      <li>PlayerId</li>
    </ul>
  </li>
  <li>PerformAttack -
  If the resources are available on the player’s board:
      if the opponent has an inplay creature deal the damage from the attack to that creature. If the creature has &lt;= 0 heath the creature dies
      if the opponent has no inplay creature deal the damage to the player
  if the resources are not available on the player’s board display a message
    <ul>
      <li>GameId</li>
      <li>PlayerId</li>
      <li>InPlayCreatureId</li>
      <li>Attack</li>
    </ul>
  </li>
  <li>SkipAttack - Move the gamestate to reconcile
    <ul>
      <li>GameId</li>
      <li>PlayerId</li>
    </ul>
  </li>
  <li>EndTurn - Mode the gamestate to the other player’s draw state
    <ul>
      <li>GameId</li>
      <li>PlayerId</li>
    </ul>
  </li>
  <li>GameWon - Move the gamestate to the game over state
    <ul>
      <li>PlayerId of Winner</li>
      <li>Winning Reason (string)</li>
    </ul>
  </li>
</ul>

<p>There will have to be additional events for things like tapping out/retreating active creatures but I think those would best be added after everything else is set up/works.</p>

<p>Going through this process I have identified a few initial things that need to be added.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* need a list of notifications on the GameState
* need a GameStep for GameOver
* need an optional winner on the GameOver Step
* need a game id on the GameState
</code></pre></div></div>

<p>I am not thinking that the CurrentPlayerTurn should actually be on the Game Step so I am refactoring that type.</p>

<p>I modified the domain models with:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">    <span class="k">and</span> <span class="nc">GameOverStep</span> <span class="p">=</span>
        <span class="p">{</span>
            <span class="nc">WinnerId</span><span class="p">:</span> <span class="nc">Option</span><span class="p">&lt;</span><span class="nc">PlayerId</span><span class="p">&gt;</span>
            <span class="nc">Message</span><span class="p">:</span> <span class="kt">string</span>
        <span class="p">}</span>
    <span class="k">and</span> <span class="nc">GameStep</span> <span class="p">=</span>
        <span class="nc">NotCurrentlyPlaying</span>
        <span class="p">|</span> <span class="nc">Draw</span> <span class="k">of</span> <span class="nc">PlayerId</span>
        <span class="p">|</span> <span class="nc">Play</span> <span class="k">of</span> <span class="nc">PlayerId</span>
        <span class="p">|</span> <span class="nc">Attack</span> <span class="k">of</span> <span class="nc">PlayerId</span>
        <span class="p">|</span> <span class="nc">Reconcile</span> <span class="k">of</span> <span class="nc">PlayerId</span>
        <span class="p">|</span> <span class="nc">GameOver</span> <span class="k">of</span> <span class="nc">GameOverStep</span>
    <span class="k">and</span> <span class="nc">Notification</span> <span class="p">=</span> <span class="kt">string</span>
    <span class="k">and</span> <span class="nc">GameState</span> <span class="p">=</span>
        <span class="p">{</span>
            <span class="nc">GameId</span><span class="p">:</span> <span class="nc">GameId</span>
            <span class="nc">NotificationMessages</span><span class="p">:</span> <span class="nc">Option</span><span class="p">&lt;</span><span class="nc">Notification</span> <span class="kt">list</span><span class="p">&gt;</span>
            <span class="nc">CurrentPlayer</span><span class="p">:</span> <span class="nc">PlayerId</span>
            <span class="nc">OpponentPlayer</span><span class="p">:</span> <span class="nc">PlayerId</span>
            <span class="nc">Players</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">PlayerId</span><span class="p">,</span> <span class="nc">Player</span><span class="p">&gt;</span>
            <span class="nc">Boards</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">PlayerId</span><span class="p">,</span> <span class="nc">PlayerBoard</span><span class="p">&gt;</span>
            <span class="nc">CurrentStep</span><span class="p">:</span><span class="nc">GameStep</span>
            <span class="nc">TurnNumber</span><span class="p">:</span> <span class="kt">int</span>
        <span class="p">}</span></code></pre></figure>

<p>I then had to update the init function for the new fields like</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">init</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">player1</span> <span class="p">=</span> <span class="n">createPlayer</span> <span class="s2">"Player1"</span> <span class="s2">"Player1"</span> <span class="mi">10</span> <span class="s2">"https://picsum.photos/id/1000/2500/1667?blur=5"</span>
    <span class="k">let</span> <span class="n">player2</span> <span class="p">=</span> <span class="n">createPlayer</span> <span class="s2">"Player2"</span> <span class="s2">"Player2"</span> <span class="mi">10</span> <span class="s2">"https://picsum.photos/id/10/2500/1667?blur=5"</span>
    <span class="k">let</span> <span class="n">gameId</span> <span class="p">=</span>  <span class="nn">NonEmptyString</span><span class="p">.</span><span class="n">build</span> <span class="s2">"GameIDHere"</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">map</span> <span class="nc">GameId</span>

    <span class="k">match</span> <span class="n">player1</span><span class="p">,</span> <span class="n">player2</span><span class="p">,</span> <span class="n">gameId</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Ok</span> <span class="n">p1</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">p2</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">g</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">playerBoard1</span> <span class="p">=</span> <span class="n">playerBoard</span> <span class="n">p1</span>
        <span class="k">let</span> <span class="n">playerBoard2</span> <span class="p">=</span> <span class="n">playerBoard</span> <span class="n">p2</span>
        <span class="k">match</span> <span class="n">playerBoard1</span><span class="p">,</span> <span class="n">playerBoard2</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">Ok</span> <span class="n">pb1</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">pb2</span> <span class="p">-&gt;</span>
          <span class="k">let</span> <span class="n">model</span> <span class="p">=</span>
            <span class="p">{</span>
                <span class="nc">GameId</span> <span class="p">=</span> <span class="n">g</span>
                <span class="nc">Players</span> <span class="p">=</span>  <span class="p">[</span>
                            <span class="n">p1</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">,</span> <span class="n">p1</span><span class="p">;</span>
                            <span class="n">p2</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">,</span> <span class="n">p2</span>
                           <span class="p">]</span> <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">ofList</span>
                <span class="nc">Boards</span> <span class="p">=</span>   <span class="p">[</span>
                            <span class="n">pb1</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">,</span> <span class="n">pb1</span><span class="p">;</span>
                            <span class="n">pb2</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">,</span> <span class="n">pb2</span>
                           <span class="p">]</span> <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">ofList</span>
                <span class="nc">NotificationMessages</span> <span class="p">=</span> <span class="nc">None</span>
                <span class="nc">CurrentStep</span><span class="p">=</span>  <span class="n">p1</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">|&gt;</span> <span class="nc">Attack</span>
                <span class="nc">TurnNumber</span> <span class="p">=</span> <span class="mi">1</span>
                <span class="nc">CurrentPlayer</span> <span class="p">=</span> <span class="n">p1</span><span class="p">.</span><span class="nc">PlayerId</span>
                <span class="nc">OpponentPlayer</span> <span class="p">=</span> <span class="n">p2</span><span class="p">.</span><span class="nc">PlayerId</span>
            <span class="p">}</span>
          <span class="k">let</span> <span class="n">cmd</span> <span class="p">=</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">ofMsg</span> <span class="nc">GameStarted</span>
          <span class="nc">Ok</span> <span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="s2">"Failed to create player boards"</span> <span class="p">|&gt;</span> <span class="nc">Error</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="s2">"Failed to create players"</span> <span class="p">|&gt;</span> <span class="nc">Error</span></code></pre></figure>

<p>I similarly had to update the currentStepInformation to utilize the updated GameStep type. Using the fact that whose turn it is now embedded in the state I was able to simplify the yourCurrentStepClasses function like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">yourCurrentStepClasses</span> <span class="p">(</span><span class="n">gameState</span> <span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">(</span><span class="n">gamesStep</span><span class="p">:</span> <span class="nc">GameStep</span><span class="p">)</span> <span class="p">=</span>
        <span class="k">if</span> <span class="n">gameState</span><span class="p">.</span><span class="nc">CurrentStep</span> <span class="p">=</span> <span class="n">gamesStep</span> <span class="k">then</span> <span class="s2">"button is-danger"</span>
        <span class="k">else</span> <span class="s2">"button is-primary"</span>

<span class="k">let</span> <span class="n">currentStepInformation</span> <span class="p">(</span><span class="n">player</span><span class="p">:</span> <span class="nc">Player</span><span class="p">)</span> <span class="p">(</span><span class="n">gameState</span> <span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"field is-grouped has-addons is-grouped-right"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"control"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">button</span> <span class="p">[</span> <span class="nc">Class</span> <span class="p">(</span><span class="n">yourCurrentStepClasses</span> <span class="n">gameState</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">|&gt;</span> <span class="nn">GameStep</span><span class="p">.</span><span class="nc">Draw</span><span class="o">))</span>
                                       <span class="nc">Disabled</span> <span class="bp">true</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">span</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"Draw"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"control"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">button</span> <span class="p">[</span> <span class="nc">Class</span> <span class="p">(</span><span class="n">yourCurrentStepClasses</span> <span class="n">gameState</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">|&gt;</span> <span class="nn">GameStep</span><span class="p">.</span><span class="nc">Draw</span><span class="o">))</span>
                                       <span class="nc">Disabled</span> <span class="bp">true</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">span</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"Play"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"control"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">button</span> <span class="p">[</span> <span class="nc">Class</span> <span class="p">(</span><span class="n">yourCurrentStepClasses</span> <span class="n">gameState</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">|&gt;</span> <span class="nn">GameStep</span><span class="p">.</span><span class="nc">Draw</span><span class="o">))</span>
                                       <span class="nc">Disabled</span> <span class="bp">true</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">span</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"Attack"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"control"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">button</span> <span class="p">[</span> <span class="nc">Class</span> <span class="p">(</span><span class="n">yourCurrentStepClasses</span> <span class="n">gameState</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">|&gt;</span> <span class="nn">GameStep</span><span class="p">.</span><span class="nc">Draw</span><span class="o">))</span>
                                       <span class="nc">Disabled</span> <span class="bp">true</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">span</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"Reconcile"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span></code></pre></figure>

<p>At this point everything builds and I am checking it in with a commit message of <code class="language-plaintext highlighter-rouge">Step 7 Updates to GameState</code>.</p>

<p>In the Client/Index.fs I can now modify the Msg type to be a discriminated union of all the above-listed types. First, I am moving the Msg type into its own module/file Events/Events.fs.</p>

<p>Based on the above description I was able to define the events as follows:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">StartGameEvent</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="nc">GameId</span><span class="p">:</span> <span class="nc">GameId</span>
        <span class="nc">Players</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">Player</span><span class="p">,</span> <span class="nc">Deck</span><span class="p">&gt;</span>
        <span class="nc">StartingPlayer</span><span class="p">:</span><span class="nc">PlayerId</span>
    <span class="p">}</span>
<span class="k">type</span> <span class="nc">DrawCardEvent</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="nc">GameId</span><span class="p">:</span> <span class="nc">GameId</span>
        <span class="nc">PlayerId</span><span class="p">:</span> <span class="nc">PlayerId</span>
    <span class="p">}</span>
<span class="k">type</span> <span class="nc">DiscardCardEvent</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="nc">GameId</span><span class="p">:</span> <span class="nc">GameId</span>
        <span class="nc">PlayerId</span><span class="p">:</span> <span class="nc">PlayerId</span>
        <span class="nc">CardInstanceId</span><span class="p">:</span> <span class="nc">CardInstanceId</span>
    <span class="p">}</span>
<span class="k">type</span> <span class="nc">PlayCardEvent</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="nc">GameId</span><span class="p">:</span> <span class="nc">GameId</span>
        <span class="nc">PlayerId</span><span class="p">:</span> <span class="nc">PlayerId</span>
        <span class="nc">CardInstanceId</span><span class="p">:</span> <span class="nc">CardInstanceId</span>
    <span class="p">}</span>
<span class="k">type</span> <span class="nc">EndPlayStepEvent</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="nc">GameId</span><span class="p">:</span> <span class="nc">GameId</span>
        <span class="nc">PlayerId</span><span class="p">:</span> <span class="nc">PlayerId</span>
    <span class="p">}</span>
<span class="k">type</span> <span class="nc">PerformAttackEvent</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="nc">GameId</span><span class="p">:</span> <span class="nc">GameId</span>
        <span class="nc">PlayerId</span><span class="p">:</span> <span class="nc">PlayerId</span>
        <span class="nc">InPlayCreatureId</span><span class="p">:</span> <span class="nc">InPlayCreatureId</span>
        <span class="nc">Attack</span><span class="p">:</span> <span class="nc">Attack</span>
    <span class="p">}</span>
<span class="k">type</span> <span class="nc">SkipAttackEvent</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="nc">GameId</span><span class="p">:</span> <span class="nc">GameId</span>
        <span class="nc">PlayerId</span><span class="p">:</span> <span class="nc">PlayerId</span>
    <span class="p">}</span>
<span class="k">type</span> <span class="nc">EndTurnEvent</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="nc">GameId</span><span class="p">:</span> <span class="nc">GameId</span>
        <span class="nc">PlayerId</span><span class="p">:</span> <span class="nc">PlayerId</span>
    <span class="p">}</span>
<span class="k">type</span> <span class="nc">GameWonEvent</span> <span class="p">=</span>
    <span class="p">{</span>
        <span class="nc">GameId</span><span class="p">:</span> <span class="nc">GameId</span>
        <span class="nc">Winner</span><span class="p">:</span> <span class="nc">Option</span><span class="p">&lt;</span><span class="nc">PlayerId</span><span class="p">&gt;</span>
        <span class="nc">Message</span><span class="p">:</span> <span class="nc">Option</span><span class="p">&lt;</span><span class="nc">Notification</span> <span class="kt">list</span><span class="p">&gt;</span>
    <span class="p">}</span>

<span class="k">type</span> <span class="nc">Msg</span> <span class="p">=</span>
    <span class="p">|</span> <span class="nc">GameStarted</span>
    <span class="p">|</span> <span class="nc">StartGame</span> <span class="k">of</span> <span class="nc">StartGameEvent</span>
    <span class="p">|</span> <span class="nc">DrawCard</span> <span class="k">of</span> <span class="nc">DrawCardEvent</span>
    <span class="p">|</span> <span class="nc">DiscardCard</span> <span class="k">of</span> <span class="nc">DiscardCardEvent</span>
    <span class="p">|</span> <span class="nc">PlayCard</span> <span class="k">of</span> <span class="nc">PlayCardEvent</span>
    <span class="p">|</span> <span class="nc">EndPlayStep</span> <span class="k">of</span> <span class="nc">EndPlayStepEvent</span>
    <span class="p">|</span> <span class="nc">PerformAttack</span> <span class="k">of</span> <span class="nc">PerformAttackEvent</span>
    <span class="p">|</span> <span class="nc">SkipAttack</span> <span class="k">of</span> <span class="nc">SkipAttackEvent</span>
    <span class="p">|</span> <span class="nc">EndTurn</span> <span class="k">of</span> <span class="nc">EndTurnEvent</span>
    <span class="p">|</span> <span class="nc">GameWon</span> <span class="k">of</span> <span class="nc">GameWonEvent</span></code></pre></figure>

<p>I am not receiving compiler errors for incomplete match statements but it builds. At this point, I am committing these changes with the message <code class="language-plaintext highlighter-rouge">Update Msg type to include a variety of events</code>.</p>

<p>I am keeping this as the final commit in the branch <code class="language-plaintext highlighter-rouge">step-7-creating-events-to-update-state</code></p>

<p><a href="https://github.com/jamesclancy/SafeCardGame/tree/step-7-creating-events-to-update-state">Git branch for this step</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/projects/safecardgame/2021/05/25/Step6WireUpGameStatePart2/">
        SafeCardGame - Step 6 - Wiring up the Layout to the GameState Part 2
      </a>
    </h1>

    <span class="post-date">25 May 2021</span>

    <h3 id="wiring-up-the-layout-to-the-gamestate-part-2">Wiring up the Layout to the GameState Part 2</h3>
<hr />

<p>Now I am going to continue to wire up the layout to the GameState. Previously, I was able to generate some cards and decks. Doing that I realize I can pull out a function to map Resources to a symbol.</p>

<p>In order to facilitate this mapping I created a function:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">getSymbolForResource</span> <span class="n">resource</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">resource</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Grass</span> <span class="p">-&gt;</span> <span class="s2">"🍂"</span>
    <span class="p">|</span> <span class="nc">Fire</span> <span class="p">-&gt;</span> <span class="s2">"🔥"</span>
    <span class="p">|</span> <span class="nc">Water</span> <span class="p">-&gt;</span> <span class="s2">"💧"</span>
    <span class="p">|</span> <span class="nc">Lightning</span> <span class="p">-&gt;</span> <span class="s2">"⚡"</span>
    <span class="p">|</span> <span class="nc">Psychic</span> <span class="p">-&gt;</span> <span class="s2">"🧠"</span>
    <span class="p">|</span> <span class="nc">Fighting</span> <span class="p">-&gt;</span> <span class="s2">"👊"</span>
    <span class="p">|</span> <span class="nc">Colorless</span> <span class="p">-&gt;</span> <span class="s2">"□"</span></code></pre></figure>

<p>Using this I can create a function mapping a `ResourcePool’ to a string like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">textDescriptionForResourcePool</span> <span class="p">(</span><span class="n">resourcePool</span> <span class="p">:</span> <span class="nc">ResourcePool</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">resourcePool</span>
    <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"%s x%i"</span> <span class="p">(</span><span class="n">getSymbolForResource</span> <span class="n">x</span><span class="p">.</span><span class="nc">Key</span><span class="p">)</span> <span class="n">x</span><span class="p">.</span><span class="nc">Value</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">";"</span></code></pre></figure>

<p>Using this function I can break out a renderAttackRow function. To do this I had to add a Name property to the <code class="language-plaintext highlighter-rouge">Attack</code> type. After adding the <code class="language-plaintext highlighter-rouge">Name</code> I can create a method like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">renderAttackRow</span> <span class="p">(</span><span class="n">attack</span><span class="p">:</span> <span class="nc">Attack</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">attack</span><span class="p">.</span><span class="nc">SpecialEffect</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="n">se</span> <span class="p">-&gt;</span>
        <span class="n">tr</span> <span class="p">[</span> <span class="p">]</span>
            <span class="p">[</span> <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">textDescriptionForResourcePool</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Cost</span><span class="p">)</span> <span class="p">]</span>
              <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">str</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Name</span> <span class="p">]</span>
              <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                <span class="p">[</span>
                    <span class="n">p</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"%i"</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Damage</span><span class="p">)</span> <span class="p">]</span>
                    <span class="n">p</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="n">se</span><span class="p">.</span><span class="nc">Description</span> <span class="p">]</span>
                <span class="p">]</span> <span class="p">]</span>
    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span>
        <span class="n">tr</span> <span class="p">[</span> <span class="p">]</span>
            <span class="p">[</span> <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">textDescriptionForResourcePool</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Cost</span><span class="p">)</span> <span class="p">]</span>
              <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">str</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Name</span> <span class="p">]</span>
              <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                <span class="p">[</span>
                    <span class="n">p</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"%i"</span> <span class="n">attack</span><span class="p">.</span><span class="nc">Damage</span><span class="p">)</span> <span class="p">]</span>
                <span class="p">]</span> <span class="p">]</span></code></pre></figure>

<p>and reference it like</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">renderCharacterCard</span> <span class="p">(</span><span class="n">card</span><span class="p">:</span> <span class="nc">CharacterCard</span><span class="p">)</span> <span class="p">=</span>
      <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"column is-4"</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">header</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header-title"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">str</span> <span class="n">card</span><span class="p">.</span><span class="nc">Name</span> <span class="p">]</span>
                          <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header-icon"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">textDescriptionForResourcePool</span> <span class="n">card</span><span class="p">.</span><span class="nc">ResourceCost</span><span class="p">)</span> <span class="p">]</span> <span class="p">]</span>
                      <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-image"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">figure</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"image is-4by3"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">img</span> <span class="p">[</span> <span class="nc">Src</span> <span class="p">(</span><span class="n">card</span><span class="p">.</span><span class="nn">ImageUrl</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="p">)</span>
                                    <span class="nc">Alt</span> <span class="n">card</span><span class="p">.</span><span class="nc">Name</span>
                                    <span class="nc">Class</span> <span class="s2">"is-fullwidth"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                      <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-content"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"content"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"is-italic"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="n">card</span><span class="p">.</span><span class="nc">Description</span> <span class="p">]</span>
                              <span class="n">displayCardSpecialEffectDetailIfPresent</span> <span class="s2">"On Enter Playing Field"</span> <span class="n">card</span><span class="p">.</span><span class="nc">EnterSpecialEffects</span>
                              <span class="n">displayCardSpecialEffectDetailIfPresent</span> <span class="s2">"On Exit Playing Field"</span> <span class="n">card</span><span class="p">.</span><span class="nc">ExitSpecialEffects</span>
                              <span class="n">h5</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"IsTitle is5"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="s2">"Attacks"</span> <span class="p">]</span>
                              <span class="n">table</span> <span class="p">[</span> <span class="p">]</span>
                                <span class="p">[</span>
                                  <span class="k">yield</span><span class="o">!</span> <span class="n">seq</span> <span class="p">{</span>
                                    <span class="k">for</span> <span class="n">a</span> <span class="k">in</span> <span class="n">card</span><span class="p">.</span><span class="nn">Creature</span><span class="p">.</span><span class="nc">Attach</span> <span class="k">do</span>
                                      <span class="p">(</span><span class="n">renderAttackRow</span> <span class="n">a</span><span class="p">)</span>
                                  <span class="p">}</span>
                                <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                      <span class="n">footer</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-footer"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">a</span> <span class="p">[</span> <span class="nc">Href</span> <span class="s2">"#"</span>
                              <span class="nc">Class</span> <span class="s2">"card-footer-item"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">str</span> <span class="s2">"Play"</span> <span class="p">]</span>
                          <span class="n">a</span> <span class="p">[</span> <span class="nc">Href</span> <span class="s2">"#"</span>
                              <span class="nc">Class</span> <span class="s2">"card-footer-item"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">str</span> <span class="s2">"Discard"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span></code></pre></figure>

<p>Now I have to plug in the information into the player and enemy creature hopefully reusing much of the previously created functions.</p>

<p>First, I can plug in the playmat backgrounds.</p>

<p>Then, I see I can use a mapping function for the <code class="language-plaintext highlighter-rouge">SpecialCondition</code>s to status symbols similar to what was done for the Resource symbols as well a function which takes an optional list of these conditions and appends them together. <em>These mappings do rely on emojis, this is not a great idea but I am sticking with it for now</em>.</p>

<p>Like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">getSymbolForSpecialCondition</span> <span class="n">status</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">status</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Asleep</span> <span class="p">-&gt;</span> <span class="s2">"💤"</span>
    <span class="p">|</span> <span class="nc">Burned</span> <span class="p">-&gt;</span> <span class="s2">"♨"</span>
    <span class="p">|</span> <span class="nc">Confused</span> <span class="p">-&gt;</span> <span class="s2">"❓"</span>
    <span class="p">|</span> <span class="nc">Paralyzed</span> <span class="p">-&gt;</span> <span class="s2">"🧊"</span>
    <span class="p">|</span> <span class="nc">Poisoned</span> <span class="p">-&gt;</span> <span class="s2">"☠️"</span>

<span class="k">let</span> <span class="n">textDescriptionForListOfSpecialConditions</span> <span class="n">specialConditions</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">specialConditions</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="n">sc</span> <span class="p">-&gt;</span> <span class="n">sc</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="n">getSymbolForSpecialCondition</span> <span class="p">|&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">";"</span>
    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="s2">""</span></code></pre></figure>

<p>I am starting to have a number of UI helper functions so I am going to move them into another file/module <code class="language-plaintext highlighter-rouge">GeneralUIHelpers</code>. I will have to register this file in Client.fsproj making sure it is compiled before the PageLayoutElement.fs.</p>

<p>I can now pull out a <code class="language-plaintext highlighter-rouge">renderEnemyActiveCreature</code> function which takes an optional <code class="language-plaintext highlighter-rouge">InPlayCreature</code> as well as a <code class="language-plaintext highlighter-rouge">renderEnemyBench</code> which takes an optional list of <code class="language-plaintext highlighter-rouge">InPlayCreature</code>s.</p>

<p>I wrote these and modified the enemyCreatures function to be like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">renderEnemyActiveCreature</span> <span class="p">(</span><span class="n">inPlayCreature</span> <span class="p">:</span> <span class="nc">Option</span><span class="p">&lt;</span><span class="nc">InPlayCreature</span><span class="o">&gt;)</span> <span class="p">=</span>
  <span class="k">match</span> <span class="p">(</span><span class="nn">Option</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="nc">Card</span><span class="o">))</span> <span class="n">inPlayCreature</span><span class="p">)</span> <span class="k">with</span>
  <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="n">strong</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"No creature in active play"</span> <span class="p">]</span>
  <span class="p">|</span> <span class="nc">Some</span> <span class="p">(</span><span class="n">creature</span><span class="p">,</span> <span class="nc">EffectCard</span> <span class="n">card</span><span class="p">)</span> <span class="p">-&gt;</span>  <span class="n">strong</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"Active creature is not a character?"</span> <span class="p">]</span>
  <span class="p">|</span> <span class="nc">Some</span> <span class="p">(</span><span class="n">creature</span><span class="p">,</span> <span class="nc">ResourceCard</span> <span class="n">card</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">strong</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"Active creature is not a character?"</span> <span class="p">]</span>
  <span class="p">|</span> <span class="nc">Some</span> <span class="p">(</span><span class="n">creature</span><span class="p">,</span> <span class="nc">CharacterCard</span> <span class="n">card</span><span class="p">)</span> <span class="p">-&gt;</span>
        <span class="n">a</span> <span class="p">[</span> <span class="nc">Href</span> <span class="s2">"#"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">header</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header-title"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"✫ %s"</span> <span class="n">card</span><span class="p">.</span><span class="nc">Name</span><span class="p">)</span> <span class="p">]</span>
                              <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header-icon"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"💓 %i/%i"</span> <span class="p">(</span><span class="n">card</span><span class="p">.</span><span class="nn">Creature</span><span class="p">.</span><span class="nc">Health</span> <span class="p">-</span> <span class="n">creature</span><span class="p">.</span><span class="nc">CurrentDamage</span><span class="p">)</span> <span class="n">card</span><span class="p">.</span><span class="nn">Creature</span><span class="p">.</span><span class="nc">Health</span><span class="p">)</span>
                                  <span class="n">str</span> <span class="p">(</span><span class="n">textDescriptionForListOfSpecialConditions</span> <span class="n">creature</span><span class="p">.</span><span class="nc">SpecialEffect</span><span class="p">)</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-image"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">figure</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"image is-4by3"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">img</span> <span class="p">[</span> <span class="nc">Src</span> <span class="p">(</span><span class="n">card</span><span class="p">.</span><span class="nn">ImageUrl</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="p">)</span>
                                        <span class="nc">Alt</span> <span class="n">card</span><span class="p">.</span><span class="nc">Name</span>
                                        <span class="nc">Class</span> <span class="s2">"is-fullwidth"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-content"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"content"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"is-italic"</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="n">card</span><span class="p">.</span><span class="nc">Description</span> <span class="p">]</span>
                                  <span class="n">h5</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"IsTitle is5"</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"Attacks"</span> <span class="p">]</span>
                                  <span class="n">table</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span>
                                        <span class="k">yield</span><span class="o">!</span> <span class="n">seq</span> <span class="p">{</span>
                                            <span class="k">for</span> <span class="n">a</span> <span class="k">in</span> <span class="n">card</span><span class="p">.</span><span class="nn">Creature</span><span class="p">.</span><span class="nc">Attach</span> <span class="k">do</span>
                                                <span class="p">(</span><span class="n">renderAttackRow</span> <span class="n">a</span><span class="p">)</span>
                                        <span class="p">}</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>

<span class="k">let</span> <span class="n">renderEnemyBenchRow</span> <span class="n">inPlayCreature</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">inPlayCreature</span><span class="p">.</span><span class="nc">Card</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">EffectCard</span> <span class="n">ec</span> <span class="p">-&gt;</span> <span class="n">strong</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"Bench creature is not a character code"</span> <span class="p">]</span>
    <span class="p">|</span> <span class="nc">ResourceCard</span> <span class="n">rc</span> <span class="p">-&gt;</span> <span class="n">strong</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"Bench creature is not a character code"</span> <span class="p">]</span>
    <span class="p">|</span> <span class="nc">CharacterCard</span> <span class="n">card</span> <span class="p">-&gt;</span>
        <span class="n">tr</span> <span class="p">[</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="n">card</span><span class="p">.</span><span class="nc">Name</span> <span class="p">]</span>
                              <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">textDescriptionForListOfSpecialConditions</span> <span class="n">inPlayCreature</span><span class="p">.</span><span class="nc">SpecialEffect</span><span class="p">)</span> <span class="p">]</span>
                              <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"💓 %i/%i"</span> <span class="p">(</span><span class="n">card</span><span class="p">.</span><span class="nn">Creature</span><span class="p">.</span><span class="nc">Health</span> <span class="p">-</span> <span class="n">inPlayCreature</span><span class="p">.</span><span class="nc">CurrentDamage</span><span class="p">)</span> <span class="n">card</span><span class="p">.</span><span class="nn">Creature</span><span class="p">.</span><span class="nc">Health</span><span class="p">)</span>  <span class="p">]</span> <span class="p">]</span>



<span class="k">let</span> <span class="n">renderEnemyBench</span> <span class="n">bench</span>  <span class="p">=</span>
    <span class="k">match</span> <span class="n">bench</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="n">strong</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"No creatures on bench"</span> <span class="p">]</span>
    <span class="p">|</span> <span class="nc">Some</span>  <span class="n">l</span><span class="p">-&gt;</span>
                      <span class="n">table</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"table is-fullwidth"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">tr</span> <span class="p">[</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">th</span> <span class="p">[</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="s2">"Creature Name"</span> <span class="p">]</span>
                              <span class="n">th</span> <span class="p">[</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="s2">"Status"</span> <span class="p">]</span>
                              <span class="n">th</span> <span class="p">[</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="s2">"Health"</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="k">yield</span><span class="o">!</span> <span class="n">seq</span> <span class="p">{</span>
                                <span class="k">for</span> <span class="n">b</span> <span class="k">in</span> <span class="n">l</span> <span class="k">do</span>
                                <span class="n">renderEnemyBenchRow</span> <span class="n">b</span>
                          <span class="p">}</span>
                        <span class="p">]</span>

<span class="k">let</span> <span class="n">enemyCreatures</span>  <span class="p">(</span><span class="n">player</span><span class="p">:</span> <span class="nc">Player</span><span class="p">)</span> <span class="p">(</span><span class="n">playerBoard</span><span class="p">:</span> <span class="nc">PlayerBoard</span><span class="p">)</span> <span class="p">=</span>
  <span class="n">section</span> <span class="p">[</span>
          <span class="nc">Class</span> <span class="s2">"section"</span>
          <span class="nc">Style</span> <span class="p">[</span> <span class="nc">Background</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"url(%s')"</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="nn">PlaymatUrl</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="o">))</span>
                  <span class="nc">BackgroundSize</span> <span class="s2">"cover"</span>
                  <span class="nc">BackgroundRepeat</span> <span class="s2">"no-repeat"</span>
                  <span class="nc">BackgroundPosition</span> <span class="s2">"center center"</span> <span class="p">]</span> <span class="p">]</span>
    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"container py-r"</span> <span class="p">]</span>
        <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"columns"</span> <span class="p">]</span>
            <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"column is-1"</span> <span class="p">]</span>
                <span class="p">[</span> <span class="p">]</span>
              <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"column is-3"</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">renderEnemyActiveCreature</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">ActiveCreature</span> <span class="p">]</span>
              <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"column is-7"</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"columns is-mobile is-multiline"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">h2</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"title is-4"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">str</span> <span class="s2">"Bench"</span> <span class="p">]</span>
                      <span class="n">renderEnemyBench</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">Bench</span>
                    <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span></code></pre></figure>

<p>This now builds (and looks very weird with no content).</p>

<p>I now need to populate some test data for the enemy creatures.</p>

<p>Similar to the cards I am able to generate the data like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">inPlayCreatureGenerator</span> <span class="n">inPlayCreatureIdStr</span> <span class="n">cardInstanceIdStr</span> <span class="n">cardIdStr</span> <span class="n">cardImageUrlStr</span> <span class="p">=</span>
        <span class="k">let</span> <span class="n">inPlayCreatureId</span> <span class="p">=</span> <span class="nn">NonEmptyString</span><span class="p">.</span><span class="n">build</span> <span class="n">inPlayCreatureIdStr</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">map</span> <span class="nc">InPlayCreatureId</span>
        <span class="k">let</span> <span class="n">card</span> <span class="p">=</span> <span class="n">testCardGenerator</span> <span class="n">cardInstanceIdStr</span> <span class="n">cardIdStr</span> <span class="n">cardImageUrlStr</span>

        <span class="k">match</span> <span class="n">inPlayCreatureId</span><span class="p">,</span> <span class="n">card</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">Ok</span> <span class="n">id</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">c</span> <span class="p">-&gt;</span>
            <span class="nc">Ok</span> <span class="p">{</span>
                <span class="nc">InPlayCharacterId</span><span class="p">=</span>  <span class="n">id</span>
                <span class="nc">Card</span> <span class="p">=</span> <span class="n">c</span><span class="p">.</span><span class="nc">Card</span>
                <span class="nc">CurrentDamage</span><span class="p">=</span>  <span class="mi">0</span>
                <span class="nc">SpecialEffect</span><span class="p">=</span>  <span class="nc">None</span>
                <span class="nc">AttachedEnergy</span> <span class="p">=</span> <span class="p">[</span> <span class="nn">Resource</span><span class="p">.</span><span class="nc">Grass</span><span class="p">,</span> <span class="mi">4</span><span class="p">;</span>
                                     <span class="nn">Resource</span><span class="p">.</span><span class="nc">Colorless</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">ofList</span> <span class="p">|&gt;</span> <span class="nc">ResourcePool</span>
                <span class="nc">SpentEnergy</span> <span class="p">=</span> <span class="p">[</span> <span class="nn">Resource</span><span class="p">.</span><span class="nc">Grass</span><span class="p">,</span> <span class="mi">4</span><span class="p">;</span>
                                     <span class="nn">Resource</span><span class="p">.</span><span class="nc">Colorless</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">ofList</span> <span class="p">|&gt;</span> <span class="nc">ResourcePool</span>
            <span class="p">}</span>
        <span class="p">|</span> <span class="o">_,</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="s2">"Unable to create in play creature."</span> <span class="p">|&gt;</span> <span class="nc">Error</span>


<span class="k">let</span> <span class="n">inPlayCreatureSeqGenerator</span> <span class="p">(</span><span class="n">numberOfCards</span> <span class="p">:</span> <span class="kt">int</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">seq</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">..</span> <span class="p">(</span><span class="n">numberOfCards</span> <span class="p">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">inPlayCreatureGenerator</span>
                            <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"ExcitingCharacter%i"</span> <span class="n">x</span><span class="p">)</span>
                            <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"ExcitingCharacter%i"</span> <span class="n">x</span><span class="p">)</span>
                            <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Exciting Character #%i"</span> <span class="n">x</span><span class="p">)</span>
                            <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"https://picsum.photos/320/200?%i"</span> <span class="n">x</span><span class="o">))</span>
    <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span>
                        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                        <span class="p">|</span> <span class="nc">Ok</span> <span class="n">s</span> <span class="p">-&gt;</span> <span class="p">[</span> <span class="n">s</span> <span class="p">]</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>
                        <span class="p">|</span> <span class="nc">Error</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="n">e</span> <span class="p">|&gt;</span> <span class="nc">Error</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">fold</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="p">-&gt;</span>
                    <span class="k">match</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="k">with</span>
                    <span class="p">|</span> <span class="nc">Ok</span> <span class="n">accum</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">curr</span> <span class="p">-&gt;</span> <span class="n">curr</span> <span class="o">@</span> <span class="n">accum</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>
                    <span class="p">|</span> <span class="o">_,_</span> <span class="p">-&gt;</span> <span class="s2">"Eating Errors lol"</span> <span class="p">|&gt;</span> <span class="nc">Error</span>
                <span class="p">)</span> <span class="p">(</span><span class="nc">Ok</span> <span class="nn">List</span><span class="p">.</span><span class="n">empty</span><span class="p">)</span></code></pre></figure>

<p>Next, I need to modify the player creatures to also reference the state.</p>

<p>To do this I created three functions:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">playerActiveCreature</span> <span class="p">(</span><span class="n">inPlayCreature</span> <span class="p">:</span> <span class="nc">Option</span><span class="p">&lt;</span><span class="nc">InPlayCreature</span><span class="o">&gt;)</span> <span class="p">=</span>
  <span class="k">match</span> <span class="p">(</span><span class="nn">Option</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="nc">Card</span><span class="o">))</span> <span class="n">inPlayCreature</span><span class="p">)</span> <span class="k">with</span>
  <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="n">strong</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"No creature in active play"</span> <span class="p">]</span>
  <span class="p">|</span> <span class="nc">Some</span> <span class="p">(</span><span class="n">creature</span><span class="p">,</span> <span class="nc">EffectCard</span> <span class="n">card</span><span class="p">)</span> <span class="p">-&gt;</span>  <span class="n">strong</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"Active creature is not a character?"</span> <span class="p">]</span>
  <span class="p">|</span> <span class="nc">Some</span> <span class="p">(</span><span class="n">creature</span><span class="p">,</span> <span class="nc">ResourceCard</span> <span class="n">card</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">strong</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"Active creature is not a character?"</span> <span class="p">]</span>
  <span class="p">|</span> <span class="nc">Some</span> <span class="p">(</span><span class="n">creature</span><span class="p">,</span> <span class="nc">CharacterCard</span> <span class="n">card</span><span class="p">)</span> <span class="p">-&gt;</span>
        <span class="n">a</span> <span class="p">[</span> <span class="nc">Href</span> <span class="s2">"#"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">header</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header-title"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"✫ %s"</span> <span class="n">card</span><span class="p">.</span><span class="nc">Name</span><span class="p">)</span> <span class="p">]</span>
                              <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header-icon"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"💓 %i/%i"</span> <span class="p">(</span><span class="n">card</span><span class="p">.</span><span class="nn">Creature</span><span class="p">.</span><span class="nc">Health</span> <span class="p">-</span> <span class="n">creature</span><span class="p">.</span><span class="nc">CurrentDamage</span><span class="p">)</span> <span class="n">card</span><span class="p">.</span><span class="nn">Creature</span><span class="p">.</span><span class="nc">Health</span><span class="p">)</span>
                                  <span class="n">str</span> <span class="p">(</span><span class="n">textDescriptionForListOfSpecialConditions</span> <span class="n">creature</span><span class="p">.</span><span class="nc">SpecialEffect</span><span class="p">)</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-image"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">figure</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"image is-4by3"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">img</span> <span class="p">[</span> <span class="nc">Src</span> <span class="p">(</span><span class="n">card</span><span class="p">.</span><span class="nn">ImageUrl</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="p">)</span>
                                        <span class="nc">Alt</span> <span class="n">card</span><span class="p">.</span><span class="nc">Name</span>
                                        <span class="nc">Class</span> <span class="s2">"is-fullwidth"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-content"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"content"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"is-italic"</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="n">card</span><span class="p">.</span><span class="nc">Description</span> <span class="p">]</span>
                                  <span class="n">h5</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"IsTitle is5"</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"Attacks"</span> <span class="p">]</span>
                                  <span class="n">table</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span>
                                        <span class="k">yield</span><span class="o">!</span> <span class="n">seq</span> <span class="p">{</span>
                                            <span class="k">for</span> <span class="n">a</span> <span class="k">in</span> <span class="n">card</span><span class="p">.</span><span class="nn">Creature</span><span class="p">.</span><span class="nc">Attach</span> <span class="k">do</span>
                                                <span class="p">(</span><span class="n">renderAttackRow</span> <span class="n">a</span><span class="p">)</span>
                                        <span class="p">}</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="n">footer</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-footer"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">a</span> <span class="p">[</span> <span class="nc">Href</span> <span class="s2">"#"</span>
                                  <span class="nc">Class</span> <span class="s2">"card-footer-item"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="s2">"Tap Out"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>

<span class="k">let</span> <span class="n">playerBenchCreature</span> <span class="p">(</span><span class="n">inPlayCreature</span> <span class="p">:</span> <span class="nc">InPlayCreature</span><span class="o">)=</span>
  <span class="k">match</span> <span class="p">(</span><span class="n">inPlayCreature</span><span class="p">,</span> <span class="n">inPlayCreature</span><span class="p">.</span><span class="nc">Card</span><span class="p">)</span> <span class="k">with</span>
  <span class="p">|</span> <span class="p">(</span><span class="n">creature</span><span class="p">,</span> <span class="nc">EffectCard</span> <span class="n">card</span><span class="p">)</span> <span class="p">-&gt;</span>  <span class="n">strong</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"Active creature is not a character?"</span> <span class="p">]</span>
  <span class="p">|</span> <span class="p">(</span><span class="n">creature</span><span class="p">,</span> <span class="nc">ResourceCard</span> <span class="n">card</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">strong</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"Active creature is not a character?"</span> <span class="p">]</span>
  <span class="p">|</span> <span class="p">(</span><span class="n">creature</span><span class="p">,</span> <span class="nc">CharacterCard</span> <span class="n">card</span><span class="p">)</span> <span class="p">-&gt;</span>
         <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"column is-4-mobile is-12-tablet"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">header</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header-title"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="n">card</span><span class="p">.</span><span class="nc">Name</span> <span class="p">]</span>
                              <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header-icon"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"💓 %i/%i"</span> <span class="p">(</span><span class="n">card</span><span class="p">.</span><span class="nn">Creature</span><span class="p">.</span><span class="nc">Health</span> <span class="p">-</span> <span class="n">creature</span><span class="p">.</span><span class="nc">CurrentDamage</span><span class="p">)</span> <span class="n">card</span><span class="p">.</span><span class="nn">Creature</span><span class="p">.</span><span class="nc">Health</span><span class="p">)</span>
                                  <span class="n">str</span> <span class="p">(</span><span class="n">textDescriptionForListOfSpecialConditions</span> <span class="n">creature</span><span class="p">.</span><span class="nc">SpecialEffect</span><span class="p">)</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-image"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">figure</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"image is-4by3"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">img</span> <span class="p">[</span> <span class="nc">Src</span> <span class="p">(</span><span class="n">card</span><span class="p">.</span><span class="nn">ImageUrl</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="p">)</span>
                                        <span class="nc">Alt</span> <span class="n">card</span><span class="p">.</span><span class="nc">Name</span>
                                        <span class="nc">Class</span> <span class="s2">"is-fullwidth"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-content"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"content"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"is-italic"</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="n">card</span><span class="p">.</span><span class="nc">Description</span> <span class="p">]</span>
                                  <span class="n">h5</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"IsTitle is5"</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"Attacks"</span> <span class="p">]</span>
                                  <span class="n">table</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span>
                                        <span class="k">yield</span><span class="o">!</span> <span class="n">seq</span> <span class="p">{</span>
                                            <span class="k">for</span> <span class="n">a</span> <span class="k">in</span> <span class="n">card</span><span class="p">.</span><span class="nn">Creature</span><span class="p">.</span><span class="nc">Attach</span> <span class="k">do</span>
                                                <span class="p">(</span><span class="n">renderAttackRow</span> <span class="n">a</span><span class="p">)</span>
                                        <span class="p">}</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>

<span class="k">let</span> <span class="n">playerBench</span> <span class="p">(</span><span class="n">bench</span> <span class="p">:</span> <span class="nc">Option</span><span class="p">&lt;</span><span class="nc">InPlayCreature</span> <span class="kt">list</span><span class="o">&gt;)</span> <span class="n">columnsInBench</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">bench</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="n">strong</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"No creatures on bench."</span><span class="p">]</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="n">l</span> <span class="p">-&gt;</span>
      <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"column is-9"</span><span class="p">]</span> <span class="p">[</span>
        <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"container"</span><span class="p">]</span> <span class="p">[</span>
          <span class="n">h3</span> <span class="p">[</span><span class="nc">Class</span> <span class="s2">"title is-3"</span><span class="p">]</span> <span class="p">[</span><span class="n">str</span> <span class="s2">"Bench"</span><span class="p">]</span>
          <span class="k">yield</span><span class="o">!</span> <span class="n">seq</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">numberOfRows</span> <span class="p">=</span> <span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="nc">Length</span> <span class="o">/</span> <span class="n">columnsInBench</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="k">in</span> <span class="p">{</span><span class="mi">0</span> <span class="p">..</span> <span class="n">numberOfRows</span> <span class="p">}</span>  <span class="k">do</span>
                <span class="k">let</span> <span class="n">innerl</span> <span class="p">=</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">truncate</span> <span class="n">columnsInBench</span> <span class="p">(</span><span class="nn">Seq</span><span class="p">.</span><span class="n">skip</span> <span class="p">(</span><span class="n">row</span> <span class="p">*</span> <span class="n">columnsInBench</span><span class="p">)</span> <span class="n">l</span><span class="p">)</span>

                <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"columns is-mobile is-multiline"</span> <span class="p">]</span>
                    <span class="p">[</span>
                       <span class="k">yield</span><span class="o">!</span> <span class="n">seq</span> <span class="p">{</span>
                           <span class="k">for</span> <span class="n">creature</span> <span class="k">in</span> <span class="n">innerl</span> <span class="k">do</span>
                            <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"column is-%i"</span> <span class="p">(</span><span class="mi">12</span><span class="o">/</span><span class="n">columnsInBench</span><span class="o">))</span> <span class="p">]</span> <span class="p">[</span>
                                <span class="n">playerBenchCreature</span> <span class="n">creature</span>
                            <span class="p">]</span>
                       <span class="p">}</span>
                    <span class="p">]</span>
        <span class="p">}</span> <span class="p">]</span> <span class="p">]</span>


<span class="k">let</span> <span class="n">playerCreatures</span>  <span class="p">(</span><span class="n">player</span><span class="p">:</span> <span class="nc">Player</span><span class="p">)</span> <span class="p">(</span><span class="n">playerBoard</span><span class="p">:</span> <span class="nc">PlayerBoard</span><span class="p">)</span> <span class="p">=</span>
  <span class="n">section</span> <span class="p">[</span>
          <span class="nc">Class</span> <span class="s2">"section"</span>
          <span class="nc">Style</span> <span class="p">[</span> <span class="nc">Background</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"url('%s')"</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="nn">PlaymatUrl</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="o">))</span>
                  <span class="nc">BackgroundSize</span> <span class="s2">"cover"</span>
                  <span class="nc">BackgroundRepeat</span> <span class="s2">"no-repeat"</span>
                  <span class="nc">BackgroundPosition</span> <span class="s2">"center center"</span> <span class="p">]</span> <span class="p">]</span>
    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"container py-r"</span> <span class="p">]</span> <span class="p">[</span>
          <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"columns"</span> <span class="p">]</span>
            <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"column is-3"</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">playerActiveCreature</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">ActiveCreature</span> <span class="p">]</span>
              <span class="n">playerBench</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">Bench</span> <span class="mi">4</span>

               <span class="p">]</span> <span class="p">]</span> <span class="p">]</span></code></pre></figure>

<p>This compiles and displays now. Here note that the playerBench takes an argument for the number of columns to display. I wasn’t sure if it should be 3 or 4 cards per column so I made it a variable.</p>

<p>The playerCreatures can then be changed to</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">playerCreatures</span>  <span class="p">(</span><span class="n">player</span><span class="p">:</span> <span class="nc">Player</span><span class="p">)</span> <span class="p">(</span><span class="n">playerBoard</span><span class="p">:</span> <span class="nc">PlayerBoard</span><span class="p">)</span> <span class="p">=</span>
  <span class="n">section</span> <span class="p">[</span>
          <span class="nc">Class</span> <span class="s2">"section"</span>
          <span class="nc">Style</span> <span class="p">[</span> <span class="nc">Background</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"url('%s')"</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="nn">PlaymatUrl</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="o">))</span>
                  <span class="nc">BackgroundSize</span> <span class="s2">"cover"</span>
                  <span class="nc">BackgroundRepeat</span> <span class="s2">"no-repeat"</span>
                  <span class="nc">BackgroundPosition</span> <span class="s2">"center center"</span> <span class="p">]</span> <span class="p">]</span>
    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"container py-r"</span> <span class="p">]</span> <span class="p">[</span>
          <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"columns"</span> <span class="p">]</span>
            <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"column is-3"</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">playerActiveCreature</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">ActiveCreature</span> <span class="p">]</span>
              <span class="n">playerBench</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nc">Bench</span> <span class="mi">4</span>

               <span class="p">]</span> <span class="p">]</span> <span class="p">]</span></code></pre></figure>

<p>Additionally, at this stage, I noticed that the playmat background on the creatures was missing a <code class="language-plaintext highlighter-rouge">'</code> around the URL so I added that.</p>

<p>Now our layout is largely wired up to the GameState. Next, we will need to define some events which modify the GameState and attach those events to the UI.</p>

<p>This is the final commit in the branch <code class="language-plaintext highlighter-rouge">step-6-wire-up-layout-to-gamestate-part-2</code></p>

<p><a href="https://github.com/jamesclancy/SafeCardGame/tree/step-6-wire-up-layout-to-gamestate-part-2">Git branch for this step</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/projects/safecardgame/2021/05/23/Step5WireGameStateToBoard/">
        SafeCardGame - Step 5 - Wire up board to GameState
      </a>
    </h1>

    <span class="post-date">23 May 2021</span>

    <h3 id="wire-up-layout-to-the-gamestate-and-breaking-it-in-to-smaller-parts">Wire up Layout to the GameState and BReaking it in to Smaller Parts</h3>

<p>The first thing I need to do is alter the init() in the <code class="language-plaintext highlighter-rouge">Index.fs</code> to return a tuple with a GamesState instead of a Model. I am then going to work through the errors until everything compiles.</p>

<p>In order to alter the init() I will have to come up with what the initial state should be. By the end of this  section I am going to manually add some information (i.e. not leave it in a new game state) so that something is happening on the screen to render.</p>

<p>First I set up my type like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">    <span class="k">let</span> <span class="n">model</span> <span class="p">=</span>
        <span class="p">{</span>
            <span class="nc">Players</span> <span class="p">=</span>  <span class="nn">Map</span><span class="p">.</span><span class="n">empty</span>
            <span class="nc">Boards</span> <span class="p">=</span> <span class="nn">Map</span><span class="p">.</span><span class="n">empty</span>
            <span class="nc">CurrentTurn</span> <span class="p">=</span> <span class="nc">None</span>
            <span class="nc">CurrentStep</span><span class="p">=</span>  <span class="nc">GameStep</span>
            <span class="nc">TurnNumber</span> <span class="p">=</span> <span class="mi">1</span>
        <span class="p">}</span></code></pre></figure>

<p>I then also deleted the Model type and updated the <code class="language-plaintext highlighter-rouge">Msg</code> type to consist solely of a GameStarted type.</p>

<p>I then had to update the cmd of the init() like</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"> 
<span class="k">let</span> <span class="n">cmd</span> <span class="p">=</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">ofMsg</span> <span class="nc">GameStarted</span> </code></pre></figure>

<p>so that it returned a valid cmd and update the <code class="language-plaintext highlighter-rouge">update</code> function
to only match on the <code class="language-plaintext highlighter-rouge">GamesStarted</code> type.</p>

<p>i.e.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">update</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nc">Msg</span><span class="p">)</span> <span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nc">GameState</span><span class="o">):</span> <span class="nc">GameState</span> <span class="p">*</span> <span class="nc">Cmd</span><span class="p">&lt;</span><span class="nc">Msg</span><span class="p">&gt;</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">GameStarted</span> <span class="p">-&gt;</span>
        <span class="n">model</span><span class="p">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span></code></pre></figure>

<p>I was not able to save and it compiled</p>

<p>Next I will need to wire in the model part by part into the layout potentially updating the domain with missing items as I go.</p>

<p>The first thing I noticed is that I didn’t have any sort of validation that my Id’s were non empty so I added some by defining a <code class="language-plaintext highlighter-rouge">NonEmptyString</code> type, making the constructor private and adding a NonEmptyString namespace with a build function that creates a NonEmptyString after validating the provided string is not null or whitespace.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">NonEmptyString</span> <span class="p">=</span> <span class="k">private</span> <span class="nc">NonEmptyString</span> <span class="k">of</span> <span class="kt">string</span>
<span class="k">module</span> <span class="nc">NonEmptyString</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">build</span> <span class="n">str</span> <span class="p">=</span>
        <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="nc">IsNullOrWhiteSpace</span> <span class="n">str</span> <span class="k">then</span> <span class="s2">"Value cannot be empty"</span> <span class="p">|&gt;</span> <span class="nc">Error</span>
        <span class="k">else</span> <span class="n">str</span> <span class="p">|&gt;</span> <span class="nc">NonEmptyString</span> <span class="p">|&gt;</span> <span class="nc">Ok</span></code></pre></figure>

<p>I then moved the domain types into a <code class="language-plaintext highlighter-rouge">Domain</code> module and made the various Ids types of NonEmptyStrings.</p>

<p>i.e.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">module</span> <span class="nc">Domain</span> <span class="p">=</span>

    <span class="k">type</span> <span class="nc">PlayerId</span> <span class="p">=</span> <span class="nc">NonEmptyString</span>
    <span class="k">type</span> <span class="nc">CardInstanceId</span> <span class="p">=</span> <span class="nc">NonEmptyString</span>
    <span class="k">type</span> <span class="nc">CardId</span> <span class="p">=</span> <span class="nc">NonEmptyString</span>
    <span class="k">type</span> <span class="nc">InPlayCreatureId</span> <span class="p">=</span> <span class="nc">NonEmptyString</span>

    <span class="k">type</span> <span class="nc">Player</span> <span class="p">=</span>
        <span class="p">{</span> <span class="o">...</span></code></pre></figure>

<p>I then added the arguments <code class="language-plaintext highlighter-rouge">model</code> and <code class="language-plaintext highlighter-rouge">dispatch</code> to pass through from the <code class="language-plaintext highlighter-rouge">view</code> to the <code class="language-plaintext highlighter-rouge">mainLayout</code>.</p>

<p>Inside the mainLayout the enemyStats and enemyCreatures will depend on the opponent <code class="language-plaintext highlighter-rouge">Player</code> and opponent <code class="language-plaintext highlighter-rouge">PlayerBoard</code>
and  <code class="language-plaintext highlighter-rouge">playerCreatures</code> and <code class="language-plaintext highlighter-rouge">playerHand</code> will depend on your <code class="language-plaintext highlighter-rouge">PlayerBoard</code> and the <code class="language-plaintext highlighter-rouge">playerControlCenter</code> will depend on the entire <code class="language-plaintext highlighter-rouge">GameState</code>.</p>

<p>First, we will need to pull out the opponent and player board and player but I have noticed that the GamesState does not define the current player vs the opponent so I am adding a property to the GameState to store this information.</p>

<p>i.e.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">    <span class="k">and</span> <span class="nc">GameState</span> <span class="p">=</span>
        <span class="p">{</span>
            <span class="nc">CurrentPlayer</span><span class="p">:</span> <span class="nc">PlayerId</span>
            <span class="nc">OpponentPlayer</span><span class="p">:</span> <span class="nn">PlayerId</span>
            <span class="p">...</span></code></pre></figure>

<p>I then wrote functions to extract the needed information, wrapped them in results and a single function to extract all the data.</p>

<p>I then wrapped the main layout to verify no errors were encountered in building the models and changed the function to return an error message if any issues are encountered.</p>

<p>i.e.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">opponentPlayer</span> <span class="p">(</span><span class="n">model</span> <span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">model</span><span class="p">.</span><span class="nn">Players</span><span class="p">.</span><span class="nc">TryGetValue</span> <span class="n">model</span><span class="p">.</span><span class="nc">OpponentPlayer</span> <span class="k">with</span>
    <span class="p">|</span> <span class="bp">true</span><span class="p">,</span> <span class="n">p</span> <span class="p">-&gt;</span> <span class="n">p</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>
    <span class="p">|</span> <span class="bp">false</span><span class="p">,</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="s2">"Unable to locate oppponent in player list"</span> <span class="p">|&gt;</span> <span class="nc">Error</span>


<span class="k">let</span> <span class="n">opponentPlayerBoard</span> <span class="p">(</span><span class="n">model</span> <span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">model</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">TryGetValue</span> <span class="n">model</span><span class="p">.</span><span class="nc">OpponentPlayer</span> <span class="k">with</span>
    <span class="p">|</span> <span class="bp">true</span><span class="p">,</span> <span class="n">p</span> <span class="p">-&gt;</span> <span class="n">p</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>
    <span class="p">|</span> <span class="bp">false</span><span class="p">,</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="s2">"Unable to locate oppponent in board list"</span> <span class="p">|&gt;</span> <span class="nc">Error</span>

<span class="k">let</span> <span class="n">currentPlayer</span> <span class="p">(</span><span class="n">model</span> <span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">model</span><span class="p">.</span><span class="nn">Players</span><span class="p">.</span><span class="nc">TryGetValue</span> <span class="n">model</span><span class="p">.</span><span class="nc">CurrentPlayer</span> <span class="k">with</span>
    <span class="p">|</span> <span class="bp">true</span><span class="p">,</span> <span class="n">p</span> <span class="p">-&gt;</span> <span class="n">p</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>
    <span class="p">|</span> <span class="bp">false</span><span class="p">,</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="s2">"Unable to locate current player in player list"</span> <span class="p">|&gt;</span> <span class="nc">Error</span>


<span class="k">let</span> <span class="n">currentPlayerBoard</span> <span class="p">(</span><span class="n">model</span> <span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">model</span><span class="p">.</span><span class="nn">Boards</span><span class="p">.</span><span class="nc">TryGetValue</span> <span class="n">model</span><span class="p">.</span><span class="nc">CurrentPlayer</span> <span class="k">with</span>
    <span class="p">|</span> <span class="bp">true</span><span class="p">,</span> <span class="n">p</span> <span class="p">-&gt;</span> <span class="n">p</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>
    <span class="p">|</span> <span class="bp">false</span><span class="p">,</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="s2">"Unable to locate current player in board list"</span> <span class="p">|&gt;</span> <span class="nc">Error</span>

<span class="k">let</span> <span class="n">extractNeededModelsFromState</span> <span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">opponentPlayer</span> <span class="n">model</span><span class="p">,</span> <span class="n">opponentPlayerBoard</span> <span class="n">model</span><span class="p">,</span> <span class="n">currentPlayer</span> <span class="n">model</span><span class="p">,</span> <span class="n">currentPlayerBoard</span> <span class="n">model</span>


<span class="k">let</span> <span class="n">mainLayout</span>  <span class="n">model</span> <span class="n">dispatch</span> <span class="p">=</span>
  <span class="k">match</span> <span class="n">extractNeededModelsFromState</span> <span class="n">model</span> <span class="k">with</span>
  <span class="p">|</span> <span class="nc">Ok</span> <span class="n">op</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">opb</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">cp</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">cpb</span> <span class="p">-&gt;</span>
      <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"container is-fluid"</span> <span class="p">]</span>
        <span class="p">[</span> <span class="n">topNavigation</span>
          <span class="n">br</span> <span class="p">[</span> <span class="p">]</span>
          <span class="n">br</span> <span class="p">[</span> <span class="p">]</span>
          <span class="n">enemyStats</span>
          <span class="n">enemyCreatures</span>
          <span class="n">playerControlCenter</span>
          <span class="n">playerCreatures</span>
          <span class="n">playerHand</span>
          <span class="n">footerBand</span>
        <span class="p">]</span>
  <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">strong</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">str</span> <span class="s2">"Error in GameState encountered."</span> <span class="p">]</span></code></pre></figure>

<p>Looking further at the <code class="language-plaintext highlighter-rouge">Player</code> definition I see that it is missing a playmat URL for their background graphic. I added that as well as definitions for two new primates domain types which should only hold valid URLs:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">UrlString</span> <span class="p">=</span> <span class="k">private</span> <span class="nc">UrlString</span> <span class="k">of</span> <span class="nc">NonEmptyString</span>
<span class="k">module</span> <span class="nc">UrlString</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">build</span> <span class="n">str</span> <span class="p">=</span>
        <span class="k">if</span> <span class="nn">Uri</span><span class="p">.</span><span class="nc">IsWellFormedUriString</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="nn">UriKind</span><span class="p">.</span><span class="nc">RelativeOrAbsolute</span><span class="p">)</span> <span class="k">then</span> <span class="s2">"Value must be a url."</span> <span class="p">|&gt;</span> <span class="nc">Error</span>
        <span class="k">else</span> <span class="n">str</span> <span class="p">|&gt;</span> <span class="nn">NonEmptyString</span><span class="p">.</span><span class="n">build</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">map</span> <span class="nc">UrlString</span>


<span class="k">type</span> <span class="nc">ImageUrlString</span> <span class="p">=</span> <span class="k">private</span> <span class="nc">ImageUrlString</span> <span class="k">of</span> <span class="nc">UrlString</span>
<span class="k">module</span> <span class="nc">ImageUrlString</span> <span class="p">=</span>

    <span class="k">let</span> <span class="n">isUrlImage</span> <span class="p">(</span><span class="n">str</span> <span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">=</span>
        <span class="k">let</span> <span class="n">ext</span>  <span class="p">=</span> <span class="nn">Path</span><span class="p">.</span><span class="nc">GetExtension</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
        <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="nc">IsNullOrWhiteSpace</span> <span class="n">ext</span> <span class="k">then</span> <span class="bp">false</span>
        <span class="k">else</span>
            <span class="k">match</span> <span class="n">str</span> <span class="k">with</span>
            <span class="p">|</span> <span class="s2">"png"</span> <span class="p">|</span> <span class="s2">"jpg"</span> <span class="p">-&gt;</span>
                <span class="bp">true</span>
            <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="bp">false</span>

    <span class="k">let</span> <span class="n">build</span> <span class="n">str</span> <span class="p">=</span>
        <span class="k">if</span> <span class="n">isUrlImage</span> <span class="n">str</span> <span class="k">then</span> <span class="s2">"Value must be a url pointing to iamge."</span> <span class="p">|&gt;</span> <span class="nc">Error</span>
        <span class="k">else</span> <span class="n">str</span> <span class="p">|&gt;</span> <span class="nn">UrlString</span><span class="p">.</span><span class="n">build</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">map</span> <span class="nc">ImageUrlString</span></code></pre></figure>

<p>and</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">    <span class="k">type</span> <span class="nc">Player</span> <span class="p">=</span>
        <span class="p">{</span>
            <span class="nc">PlayerId</span><span class="p">:</span> <span class="nc">PlayerId</span>
            <span class="nc">Name</span><span class="p">:</span> <span class="kt">string</span>
            <span class="nc">PlaymatUrl</span><span class="p">:</span> <span class="nc">ImageUrlString</span>
            <span class="nc">RemainingLifePoints</span><span class="p">:</span> <span class="kt">int</span>
        <span class="p">}</span></code></pre></figure>

<p>In the Init I now have to add PlayerIds for the opponent and and current player. To do this I created a createPlayer function which takes a playerIdStr playerName playerCurrentLife playerPlaymatUrl and returns a <code class="language-plaintext highlighter-rouge">Player</code>.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">createPlayer</span> <span class="n">playerIdStr</span> <span class="n">playerName</span> <span class="n">playerCurrentLife</span> <span class="n">playerPlaymatUrl</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">playerId</span> <span class="p">=</span> <span class="nn">NonEmptyString</span><span class="p">.</span><span class="n">build</span> <span class="n">playerIdStr</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">map</span> <span class="nc">PlayerId</span>
    <span class="k">let</span> <span class="n">playerPlaymatUrl</span> <span class="p">=</span> <span class="nn">ImageUrlString</span><span class="p">.</span><span class="n">build</span> <span class="n">playerPlaymatUrl</span>

    <span class="k">match</span> <span class="n">playerId</span><span class="p">,</span> <span class="n">playerPlaymatUrl</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Ok</span> <span class="n">s</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">pm</span> <span class="p">-&gt;</span>
        <span class="nc">Ok</span> <span class="p">{</span>
           <span class="nc">PlayerId</span> <span class="p">=</span> <span class="n">s</span>
           <span class="nc">Name</span> <span class="p">=</span> <span class="n">playerName</span>
           <span class="nc">RemainingLifePoints</span> <span class="p">=</span> <span class="n">playerCurrentLife</span>
           <span class="nc">PlaymatUrl</span> <span class="p">=</span> <span class="n">pm</span>
        <span class="p">}</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="nc">Error</span> <span class="s2">"Unable to create player"</span></code></pre></figure>

<p>I then modified the init to create two players and plug them into the GameState. In doing this modification I had to switch the init to return a Result type.</p>

<p>i.e.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">init</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">player1</span> <span class="p">=</span> <span class="n">createPlayer</span> <span class="s2">"Player1"</span> <span class="s2">"Player1"</span> <span class="mi">10</span> <span class="s2">"https://picsum.photos/id/1000/2500/1667?blur=5"</span>
    <span class="k">let</span> <span class="n">player2</span> <span class="p">=</span> <span class="n">createPlayer</span> <span class="s2">"Player2"</span> <span class="s2">"Player2"</span> <span class="mi">10</span> <span class="s2">"https://picsum.photos/id/10/2500/1667?blur=5'"</span>
    <span class="k">match</span> <span class="n">player1</span><span class="p">,</span> <span class="n">player2</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Ok</span> <span class="n">p1</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">p2</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">model</span> <span class="p">=</span>
            <span class="p">{</span>
                <span class="nc">Players</span> <span class="p">=</span>  <span class="nn">Map</span><span class="p">.</span><span class="n">empty</span>
                <span class="nc">Boards</span> <span class="p">=</span> <span class="nn">Map</span><span class="p">.</span><span class="n">empty</span>
                <span class="nc">CurrentTurn</span> <span class="p">=</span> <span class="nc">None</span>
                <span class="nc">CurrentStep</span><span class="p">=</span>  <span class="nc">NotCurrentlyPlaying</span>
                <span class="nc">TurnNumber</span> <span class="p">=</span> <span class="mi">1</span>
                <span class="nc">CurrentPlayer</span> <span class="p">=</span> <span class="n">p1</span><span class="p">.</span><span class="nc">PlayerId</span>
                <span class="nc">OpponentPlayer</span> <span class="p">=</span> <span class="n">p2</span><span class="p">.</span><span class="nc">PlayerId</span>
            <span class="p">}</span>
        <span class="k">let</span> <span class="n">cmd</span> <span class="p">=</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">ofMsg</span> <span class="nc">GameStarted</span>
        <span class="nc">Ok</span> <span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="s2">"Failed to create players"</span> <span class="p">|&gt;</span> <span class="nc">Error</span></code></pre></figure>

<p>I then had to modify the App.fs in the client to accept a result set back from the init like</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">match</span> <span class="nn">Index</span><span class="p">.</span><span class="n">init</span> <span class="k">with</span>
<span class="p">|</span> <span class="nc">Ok</span> <span class="p">(</span><span class="n">gamesState</span><span class="p">,</span> <span class="n">dispatch</span><span class="p">)</span> <span class="p">-&gt;</span>
    <span class="k">let</span> <span class="n">placeHolderFunc</span> <span class="bp">()</span> <span class="p">=</span>
        <span class="n">gamesState</span><span class="p">,</span> <span class="n">dispatch</span>
    <span class="nn">Program</span><span class="p">.</span><span class="n">mkProgram</span> <span class="n">placeHolderFunc</span> <span class="nn">Index</span><span class="p">.</span><span class="n">update</span> <span class="nn">Index</span><span class="p">.</span><span class="n">view</span>
    <span class="o">...</span></code></pre></figure>

<p>At this point, I ran into an error where the methods I was using from Path and Uri to validate the URLs are not implemented in FABLE. While FABLE implements a large part of the .NET framework some parts are not implemented. for now, I basically made the functions just to validate that the strings not null.</p>

<p>It now builds and displays the <code class="language-plaintext highlighter-rouge">Error in GameState encountered.</code> message from the view definition (since the players and boards are not registered in their respective maps).</p>

<p>Now I will have to update the init to populate these values.</p>

<p>I updated the Players value to</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">                <span class="nc">Players</span> <span class="p">=</span>  <span class="p">[</span>
                            <span class="n">p1</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">,</span> <span class="n">p1</span><span class="p">;</span>
                            <span class="n">p2</span><span class="p">.</span><span class="nc">PlayerId</span><span class="p">,</span> <span class="n">p2</span>
                           <span class="p">]</span> <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">ofList</span></code></pre></figure>

<p>Additionally, I will need to create a function to generate a player board.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">playerBoard</span> <span class="n">player</span> <span class="p">=</span>
    <span class="p">{</span>
            <span class="nc">PlayerId</span><span class="p">=</span>  <span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span>
            <span class="nc">Deck</span><span class="p">=</span> <span class="p">{</span>
                <span class="nc">TopCardsExposed</span> <span class="p">=</span> <span class="mi">0</span>
                <span class="nc">Cards</span> <span class="p">=</span>  <span class="nn">List</span><span class="p">.</span><span class="n">empty</span>
            <span class="p">}</span>
            <span class="nc">Hand</span><span class="p">=</span> <span class="p">{</span> <span class="nc">Cards</span> <span class="p">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">empty</span> <span class="p">}</span>
            <span class="nc">ActiveCreature</span><span class="p">=</span> <span class="nc">None</span>
            <span class="nc">Bench</span><span class="p">=</span>  <span class="nc">None</span>
            <span class="nc">DiscardPile</span><span class="p">=</span> <span class="p">{</span>
                <span class="nc">TopCardsExposed</span> <span class="p">=</span> <span class="mi">0</span>
                <span class="nc">Cards</span> <span class="p">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">empty</span>
            <span class="p">}</span>
            <span class="nc">TotalResourcePool</span><span class="p">=</span> <span class="nc">ResourcePool</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span>
            <span class="nc">AvailableResourcePool</span> <span class="p">=</span>  <span class="nc">ResourcePool</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span>
    <span class="p">}</span></code></pre></figure>

<p>This was not working for me. I spent a long time trying to figure out why. The end answer was that my ImageUrlString build method needed a <code class="language-plaintext highlighter-rouge">not</code> and was actually verifying that the image URL was invalid.</p>

<p>Now it is once again loading the page and I am able to start padding these values to my layout parts.</p>

<p>First I will pass the opponent <code class="language-plaintext highlighter-rouge">Player</code> and <code class="language-plaintext highlighter-rouge">PlayerBoard</code> to the <code class="language-plaintext highlighter-rouge">enemyStats</code> and plug those in.</p>

<p>Similarly, I will do the same for the player control center.</p>

<p>Here I can notice that the health, hand, deck and discard items are shared between the two nav bars and extract that as a shared function.</p>

<p>I, therefore, pulled out a playerStats function:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">playerStats</span>  <span class="p">(</span><span class="n">player</span><span class="p">:</span> <span class="nc">Player</span><span class="p">)</span> <span class="p">(</span><span class="n">playerBoard</span><span class="p">:</span> <span class="nc">PlayerBoard</span><span class="p">)</span> <span class="p">=</span>
    <span class="p">[</span>             <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">a</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"button is-primary"</span>
                          <span class="nc">Href</span> <span class="s2">"#"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"💓 %i/10"</span> <span class="n">player</span><span class="p">.</span><span class="nc">RemainingLifePoints</span><span class="p">)</span> <span class="p">]</span> <span class="p">]</span>
                  <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">a</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"button is-primary"</span>
                          <span class="nc">Href</span> <span class="s2">"#"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"🤚 %i"</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">Hand</span><span class="p">.</span><span class="nn">Cards</span><span class="p">.</span><span class="nc">Length</span><span class="p">)</span> <span class="p">]</span> <span class="p">]</span>
                  <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">a</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"button is-primary"</span>
                          <span class="nc">Href</span> <span class="s2">"#"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"🂠 %i"</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">Deck</span><span class="p">.</span><span class="nn">Cards</span><span class="p">.</span><span class="nc">Length</span><span class="p">)</span> <span class="p">]</span> <span class="p">]</span>
                  <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">a</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"button is-primary"</span>
                          <span class="nc">Href</span> <span class="s2">"#"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">str</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"🗑️ %i"</span> <span class="n">playerBoard</span><span class="p">.</span><span class="nn">DiscardPile</span><span class="p">.</span><span class="nn">Cards</span><span class="p">.</span><span class="nc">Length</span><span class="o">)]</span> <span class="p">]</span> <span class="p">]</span></code></pre></figure>

<p>I can also pull out the step information into a <code class="language-plaintext highlighter-rouge">currentStepInformation</code> function. I can then utilize it if it is the player’s turn and the GameState.CurrentStep to select the classes for the steps like:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">yourCurrentStepClasses</span> <span class="p">(</span><span class="n">player</span><span class="p">:</span> <span class="nc">Player</span><span class="p">)</span> <span class="p">(</span><span class="n">gameState</span> <span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">(</span><span class="n">gamesStep</span><span class="p">:</span> <span class="nc">GameStep</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">if</span> <span class="k">not</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span> <span class="p">=</span> <span class="n">gameState</span><span class="p">.</span><span class="nc">CurrentPlayer</span><span class="p">)</span> <span class="k">then</span> <span class="s2">"button is-primary"</span>
    <span class="k">else</span>
        <span class="k">if</span> <span class="n">gameState</span><span class="p">.</span><span class="nc">CurrentStep</span> <span class="p">=</span> <span class="n">gamesStep</span> <span class="k">then</span> <span class="s2">"button is-danger"</span>
        <span class="k">else</span> <span class="s2">"button is-primary"</span>

<span class="k">let</span> <span class="n">currentStepInformation</span> <span class="p">(</span><span class="n">player</span><span class="p">:</span> <span class="nc">Player</span><span class="p">)</span> <span class="p">(</span><span class="n">playerBoard</span><span class="p">:</span> <span class="nc">PlayerBoard</span><span class="p">)</span> <span class="p">(</span><span class="n">gameState</span> <span class="p">:</span> <span class="nc">GameState</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"navbar-item"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"field is-grouped has-addons is-grouped-right"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"control"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">button</span> <span class="p">[</span> <span class="nc">Class</span> <span class="p">(</span><span class="n">yourCurrentStepClasses</span> <span class="n">player</span> <span class="n">gameState</span> <span class="nn">GameStep</span><span class="p">.</span><span class="nc">Draw</span><span class="p">)</span>
                                       <span class="nc">Disabled</span> <span class="bp">true</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">span</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"Draw"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"control"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">button</span> <span class="p">[</span> <span class="nc">Class</span> <span class="p">(</span><span class="n">yourCurrentStepClasses</span> <span class="n">player</span> <span class="n">gameState</span> <span class="nn">GameStep</span><span class="p">.</span><span class="nc">Play</span><span class="p">)</span>
                                       <span class="nc">Disabled</span> <span class="bp">true</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">span</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"Play"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"control"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">button</span> <span class="p">[</span> <span class="nc">Class</span> <span class="p">(</span><span class="n">yourCurrentStepClasses</span> <span class="n">player</span> <span class="n">gameState</span> <span class="nn">GameStep</span><span class="p">.</span><span class="nc">Attack</span><span class="p">)</span>
                                       <span class="nc">Disabled</span> <span class="bp">true</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">span</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"Attack"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"control"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">button</span> <span class="p">[</span> <span class="nc">Class</span> <span class="p">(</span><span class="n">yourCurrentStepClasses</span> <span class="n">player</span> <span class="n">gameState</span> <span class="nn">GameStep</span><span class="p">.</span><span class="nc">Reconcile</span><span class="p">)</span>
                                       <span class="nc">Disabled</span> <span class="bp">true</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">span</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"Reconcile"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span></code></pre></figure>

<p>All this builds so I am not able to try to populate the Player Hand from the PlayerBoard.Hand. This can be rendered by rendering each card from the list in a yield.</p>

<p>I can do this like</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">renderCardForHand</span> <span class="p">(</span><span class="n">card</span><span class="p">:</span> <span class="nc">Card</span><span class="p">)</span> <span class="p">=</span>
  <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"column is-4"</span> <span class="p">]</span>
                <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card"</span> <span class="p">]</span>
                    <span class="p">[</span> <span class="n">header</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header-title"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">str</span> <span class="s2">"Card Name"</span> <span class="p">]</span>
                          <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-header-icon"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">str</span> <span class="s2">"🍂 x4"</span> <span class="p">]</span> <span class="p">]</span>
                      <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-image"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">figure</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"image is-4by3"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">img</span> <span class="p">[</span> <span class="nc">Src</span> <span class="s2">"https://picsum.photos/320/200?1"</span>
                                    <span class="nc">Alt</span> <span class="s2">"Placeholder image"</span>
                                    <span class="nc">Class</span> <span class="s2">"is-fullwidth"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                      <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-content"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"content"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"is-italic"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="s2">"This is a sweet description."</span> <span class="p">]</span>
                              <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"is-italic"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">strong</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"On Enter Playing Field"</span> <span class="p">]</span>
                                  <span class="n">str</span> <span class="s2">": Effect description."</span> <span class="p">]</span>
                              <span class="n">p</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"is-italic"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">strong</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">str</span> <span class="s2">"On Exit Playing Field"</span> <span class="p">]</span>
                                  <span class="n">str</span> <span class="s2">": Effect description."</span> <span class="p">]</span>
                              <span class="n">h5</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"IsTitle is5"</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">str</span> <span class="s2">"Attacks"</span> <span class="p">]</span>
                              <span class="n">table</span> <span class="p">[</span> <span class="p">]</span>
                                <span class="p">[</span> <span class="n">tr</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                                        <span class="p">[</span> <span class="n">str</span> <span class="s2">"🍂 x1"</span> <span class="p">]</span>
                                      <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                                        <span class="p">[</span> <span class="n">str</span> <span class="s2">"Leaf Cut"</span> <span class="p">]</span>
                                      <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                                        <span class="p">[</span> <span class="n">str</span> <span class="s2">"10"</span> <span class="p">]</span> <span class="p">]</span>
                                  <span class="n">tr</span> <span class="p">[</span> <span class="p">]</span>
                                    <span class="p">[</span> <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                                        <span class="p">[</span> <span class="n">str</span> <span class="s2">"🍂 x2"</span> <span class="p">]</span>
                                      <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                                        <span class="p">[</span> <span class="n">str</span> <span class="s2">"Vine Whip"</span> <span class="p">]</span>
                                      <span class="n">td</span> <span class="p">[</span> <span class="p">]</span>
                                        <span class="p">[</span> <span class="n">str</span> <span class="s2">"30"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                      <span class="n">footer</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"card-footer"</span> <span class="p">]</span>
                        <span class="p">[</span> <span class="n">a</span> <span class="p">[</span> <span class="nc">Href</span> <span class="s2">"#"</span>
                              <span class="nc">Class</span> <span class="s2">"card-footer-item"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">str</span> <span class="s2">"Play"</span> <span class="p">]</span>
                          <span class="n">a</span> <span class="p">[</span> <span class="nc">Href</span> <span class="s2">"#"</span>
                              <span class="nc">Class</span> <span class="s2">"card-footer-item"</span> <span class="p">]</span>
                            <span class="p">[</span> <span class="n">str</span> <span class="s2">"Discard"</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>

<span class="k">let</span> <span class="n">renderCardInstanceForHand</span> <span class="p">(</span><span class="n">card</span><span class="p">:</span> <span class="nc">CardInstance</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">renderCardForHand</span> <span class="n">card</span><span class="p">.</span><span class="nc">Card</span>

<span class="k">let</span> <span class="n">playerHand</span> <span class="p">(</span><span class="n">hand</span> <span class="p">:</span> <span class="nc">Hand</span><span class="p">)</span> <span class="p">=</span>
  <span class="n">section</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"section"</span> <span class="p">]</span>
    <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"container py-4"</span> <span class="p">]</span>
        <span class="p">[</span> <span class="n">h3</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"title is-spaced is-4"</span> <span class="p">]</span>
            <span class="p">[</span> <span class="n">str</span> <span class="s2">"Hand"</span> <span class="p">]</span>
          <span class="n">div</span> <span class="p">[</span> <span class="nc">Class</span> <span class="s2">"columns is-mobile mb-5"</span> <span class="p">]</span>
            <span class="p">[</span> <span class="k">yield</span><span class="o">!</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="n">renderCardInstanceForHand</span> <span class="n">hand</span><span class="p">.</span><span class="nc">Cards</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span></code></pre></figure>

<p>Next to see some data I will have to populate some hand data into the init object.</p>

<p>To do this I am going to create a <code class="language-plaintext highlighter-rouge">testCardSeqGenerator</code> function. This will take a number and return that number of randomly generated cards.</p>

<p>While doing this I realized the all the <code class="language-plaintext highlighter-rouge">GameStateSpecialEffect</code> in the cards and attacks should be Optional and updated the domain like</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp">    <span class="k">and</span> <span class="nc">CharacterCard</span>
        <span class="p">=</span> <span class="p">{</span> <span class="nc">CardId</span><span class="p">:</span> <span class="nc">CardId</span><span class="p">;</span>
            <span class="nc">Name</span><span class="p">:</span> <span class="kt">string</span><span class="p">;</span>
            <span class="nc">Creature</span><span class="p">:</span> <span class="nc">Creature</span><span class="p">;</span>
            <span class="nc">ResourceCost</span><span class="p">:</span> <span class="nc">ResourcePool</span><span class="p">;</span>
            <span class="nc">PrimaryResource</span><span class="p">:</span> <span class="nc">Resource</span><span class="p">;</span>
            <span class="nc">EnterSpecialEffects</span><span class="p">:</span> <span class="nc">Option</span><span class="p">&lt;</span><span class="nc">GameStateSpecialEffect</span><span class="o">&gt;;</span>
            <span class="nc">ExitSpecialEffects</span><span class="p">:</span> <span class="nc">Option</span><span class="p">&lt;</span><span class="nc">GameStateSpecialEffect</span><span class="p">&gt;</span>
          <span class="p">}</span>
    <span class="k">and</span> <span class="nc">EffectCard</span>
        <span class="p">=</span> <span class="p">{</span>
            <span class="nc">CardId</span><span class="p">:</span> <span class="nc">CardId</span><span class="p">;</span>
            <span class="nc">Name</span><span class="p">:</span> <span class="kt">string</span><span class="p">;</span>
            <span class="nc">ResourceCost</span><span class="p">:</span> <span class="nc">ResourcePool</span><span class="p">;</span>
            <span class="nc">PrimaryResource</span><span class="p">:</span> <span class="nc">Resource</span><span class="p">;</span>
            <span class="nc">EnterSpecialEffects</span><span class="p">:</span> <span class="nc">Option</span><span class="p">&lt;</span><span class="nc">GameStateSpecialEffect</span><span class="o">&gt;;</span>
            <span class="nc">ExitSpecialEffects</span><span class="p">:</span> <span class="nc">Option</span><span class="p">&lt;</span><span class="nc">GameStateSpecialEffect</span><span class="o">&gt;;</span>
        <span class="p">}</span>
    <span class="k">and</span> <span class="nc">ResourceCard</span>
        <span class="p">=</span> <span class="p">{</span>
            <span class="nc">CardId</span><span class="p">:</span> <span class="nc">CardId</span><span class="p">;</span>
            <span class="nc">Name</span><span class="p">:</span> <span class="kt">string</span><span class="p">;</span>
            <span class="nc">ResourceCost</span><span class="p">:</span> <span class="nc">ResourcePool</span><span class="p">;</span>
            <span class="nc">PrimaryResource</span><span class="p">:</span> <span class="nc">Resource</span><span class="p">;</span>
            <span class="nc">EnterSpecialEffects</span><span class="p">:</span> <span class="nc">Option</span><span class="p">&lt;</span><span class="nc">GameStateSpecialEffect</span><span class="o">&gt;;</span>
            <span class="nc">ExitSpecialEffects</span><span class="p">:</span> <span class="nc">Option</span><span class="p">&lt;</span><span class="nc">GameStateSpecialEffect</span><span class="o">&gt;;</span>
            <span class="nc">ResourceAvailableOnFirstTurn</span><span class="p">:</span> <span class="kt">bool</span><span class="p">;</span>
            <span class="nc">ResourcesAdded</span><span class="p">:</span> <span class="nc">ResourcePool</span>
        <span class="p">}</span>
    <span class="o">...</span>
    <span class="k">and</span> <span class="nc">Attack</span> <span class="p">=</span>
        <span class="p">{</span>
            <span class="nc">Damage</span><span class="p">:</span> <span class="kt">int</span>
            <span class="nc">Cost</span><span class="p">:</span> <span class="nc">ResourcePool</span>
            <span class="nc">SpecialEffect</span><span class="p">:</span> <span class="nc">Option</span><span class="p">&lt;</span><span class="nc">GameStateSpecialEffect</span><span class="p">&gt;</span>
        <span class="p">}</span></code></pre></figure>

<p>After playing around for a while I was eventually able to create functions to generate test data:</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">testCardGenerator</span> <span class="n">cardInstanceIdStr</span> <span class="n">cardIdStr</span> <span class="p">=</span>

    <span class="k">let</span> <span class="n">cardInstanceId</span> <span class="p">=</span> <span class="nn">NonEmptyString</span><span class="p">.</span><span class="n">build</span> <span class="n">cardInstanceIdStr</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">map</span> <span class="nc">CardInstanceId</span>

    <span class="k">let</span> <span class="n">cardId</span> <span class="p">=</span> <span class="nn">NonEmptyString</span><span class="p">.</span><span class="n">build</span> <span class="n">cardInstanceIdStr</span> <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">map</span> <span class="nc">CardId</span>

    <span class="k">match</span> <span class="n">cardInstanceId</span><span class="p">,</span> <span class="n">cardId</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Ok</span> <span class="n">id</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">cid</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">creature</span> <span class="p">=</span>
          <span class="p">{</span>
            <span class="nc">Health</span><span class="p">=</span> <span class="mi">95</span>
            <span class="nc">Weaknesses</span><span class="p">=</span>  <span class="nn">List</span><span class="p">.</span><span class="n">empty</span>
            <span class="nc">Attach</span> <span class="p">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">empty</span>
          <span class="p">}</span>
        <span class="k">let</span> <span class="n">card</span> <span class="p">=</span>
            <span class="p">{</span>
                <span class="nc">CardId</span> <span class="p">=</span> <span class="n">cid</span>
                <span class="nc">ResourceCost</span> <span class="p">=</span> <span class="p">[</span> <span class="nn">Resource</span><span class="p">.</span><span class="nc">Grass</span><span class="p">,</span> <span class="mi">4</span><span class="p">;</span>
                                 <span class="nn">Resource</span><span class="p">.</span><span class="nc">Colorless</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">ofList</span> <span class="p">|&gt;</span> <span class="nc">ResourcePool</span>
                <span class="nc">Name</span> <span class="p">=</span> <span class="n">cardIdStr</span>
                <span class="nc">EnterSpecialEffects</span> <span class="p">=</span> <span class="nc">None</span>
                <span class="nc">ExitSpecialEffects</span> <span class="p">=</span> <span class="nc">None</span>
                <span class="nc">PrimaryResource</span> <span class="p">=</span> <span class="nn">Resource</span><span class="p">.</span><span class="nc">Grass</span>
                <span class="nc">Creature</span> <span class="p">=</span> <span class="n">creature</span>
            <span class="p">}</span>
        <span class="nc">Ok</span>  <span class="p">{</span>
                <span class="nc">CardIntanceId</span>  <span class="p">=</span>  <span class="n">id</span>
                <span class="nc">Card</span> <span class="p">=</span>  <span class="n">card</span> <span class="p">|&gt;</span> <span class="nc">CharacterCard</span>
            <span class="p">}</span>
    <span class="p">|</span> <span class="o">_,</span> <span class="p">_</span> <span class="p">-&gt;</span>
        <span class="n">sprintf</span> <span class="s2">"Unable to create card instance for %s</span><span class="se">\t</span><span class="s2">%s"</span> <span class="n">cardInstanceIdStr</span> <span class="n">cardIdStr</span>
        <span class="p">|&gt;</span> <span class="nc">Error</span>

<span class="k">let</span> <span class="n">testCardSeqGenerator</span> <span class="p">(</span><span class="n">numberOfCards</span> <span class="p">:</span> <span class="kt">int</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">seq</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">..</span> <span class="p">(</span><span class="n">numberOfCards</span> <span class="p">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Exciting Character #%i"</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">testCardGenerator</span> <span class="n">x</span> <span class="n">x</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span>
                        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                        <span class="p">|</span> <span class="nc">Ok</span> <span class="n">s</span> <span class="p">-&gt;</span> <span class="p">[</span> <span class="n">s</span> <span class="p">]</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>
                        <span class="p">|</span> <span class="nc">Error</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="n">e</span> <span class="p">|&gt;</span> <span class="nc">Error</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">fold</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="p">-&gt;</span>
                    <span class="k">match</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="k">with</span>
                    <span class="p">|</span> <span class="nc">Ok</span> <span class="n">accum</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">curr</span> <span class="p">-&gt;</span> <span class="n">curr</span> <span class="o">@</span> <span class="n">accum</span> <span class="p">|&gt;</span> <span class="nc">Ok</span>
                    <span class="p">|</span> <span class="o">_,_</span> <span class="p">-&gt;</span> <span class="s2">"Eating Errors lol"</span> <span class="p">|&gt;</span> <span class="nc">Error</span>
                <span class="p">)</span> <span class="p">(</span><span class="nc">Ok</span> <span class="nn">List</span><span class="p">.</span><span class="n">empty</span><span class="p">)</span></code></pre></figure>

<p>One of the major issues I encountered was transforming the Sequence of results into a Result of a sequence. I ended up having to map the Seq&lt;Result&lt;Card, string» to a Seq&lt;Result&lt;Card list, string» and fold across that.</p>

<p>I was then able to update the <code class="language-plaintext highlighter-rouge">playerBoard</code> function to</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="n">playerBoard</span> <span class="p">(</span><span class="n">player</span> <span class="p">:</span> <span class="nc">Player</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">deckTemp</span> <span class="p">=</span>  <span class="n">testCardSeqGenerator</span> <span class="mi">35</span>
    <span class="k">let</span> <span class="n">handTemp</span> <span class="p">=</span> <span class="n">testCardSeqGenerator</span> <span class="mi">3</span>

    <span class="k">match</span> <span class="n">deckTemp</span><span class="p">,</span> <span class="n">handTemp</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Ok</span> <span class="n">deck</span><span class="p">,</span> <span class="nc">Ok</span> <span class="n">hand</span> <span class="p">-&gt;</span>
        <span class="nc">Ok</span>  <span class="p">{</span>
                <span class="nc">PlayerId</span><span class="p">=</span>  <span class="n">player</span><span class="p">.</span><span class="nc">PlayerId</span>
                <span class="nc">Deck</span><span class="p">=</span> <span class="p">{</span>
                    <span class="nc">TopCardsExposed</span> <span class="p">=</span> <span class="mi">0</span>
                    <span class="nc">Cards</span> <span class="p">=</span>  <span class="n">deck</span>
                <span class="p">}</span>
                <span class="nc">Hand</span><span class="p">=</span>
                    <span class="p">{</span>
                        <span class="nc">Cards</span> <span class="p">=</span> <span class="n">hand</span>
                    <span class="p">}</span>
                <span class="nc">ActiveCreature</span><span class="p">=</span> <span class="nc">None</span>
                <span class="nc">Bench</span><span class="p">=</span>  <span class="nc">None</span>
                <span class="nc">DiscardPile</span><span class="p">=</span> <span class="p">{</span>
                    <span class="nc">TopCardsExposed</span> <span class="p">=</span> <span class="mi">0</span>
                    <span class="nc">Cards</span> <span class="p">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">empty</span>
                <span class="p">}</span>
                <span class="nc">TotalResourcePool</span><span class="p">=</span> <span class="nc">ResourcePool</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span>
                <span class="nc">AvailableResourcePool</span> <span class="p">=</span>  <span class="nc">ResourcePool</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span>
            <span class="p">}</span>
    <span class="p">|</span> <span class="o">_,_</span> <span class="p">-&gt;</span> <span class="s2">"Error creating deck or hand"</span> <span class="p">|&gt;</span> <span class="nc">Error</span></code></pre></figure>

<p>I feel like there has to be a much better way to deal with these Result types but I am going to keep driving on and revisit later.</p>

<p>In building out this generator I realized I needed to add an image URL for the cards so I added an <code class="language-plaintext highlighter-rouge">ImageUrl</code> to the types of type <code class="language-plaintext highlighter-rouge">ImageUrlString</code> and added this to the builder.</p>

<p>Now I need to update the <code class="language-plaintext highlighter-rouge">renderCardForHand</code>. First I switch the card type and push the character cards into a <code class="language-plaintext highlighter-rouge">renderCharacterCard</code>.</p>

<p>Apparently, a description is also needed on the card types.</p>

<p>Also, a description is needed on the <code class="language-plaintext highlighter-rouge">GameStateSpecialEffect</code>.</p>

<p>Also, a <code class="language-plaintext highlighter-rouge">ToString</code> override is needed for the <code class="language-plaintext highlighter-rouge">ImageUrlString</code> type. I set this by overriding all the ToString methods on the <code class="language-plaintext highlighter-rouge">NonEmptyString</code>, <code class="language-plaintext highlighter-rouge">UrlString</code>, and <code class="language-plaintext highlighter-rouge">ImageUrlString</code>.</p>

<p>i.e.</p>

<figure class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">NonEmptyString</span> <span class="p">=</span> <span class="k">private</span> <span class="nc">NonEmptyString</span> <span class="k">of</span> <span class="kt">string</span>
    <span class="k">with</span> <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="p">=</span> <span class="k">match</span> <span class="n">this</span> <span class="k">with</span> <span class="nc">NonEmptyString</span> <span class="n">s</span> <span class="p">-&gt;</span> <span class="n">s</span>
<span class="o">...</span>

<span class="k">type</span> <span class="nc">UrlString</span> <span class="p">=</span> <span class="k">private</span> <span class="nc">UrlString</span> <span class="k">of</span> <span class="nc">NonEmptyString</span>
    <span class="k">with</span> <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="p">=</span> <span class="k">match</span> <span class="n">this</span> <span class="k">with</span> <span class="nc">UrlString</span> <span class="n">s</span> <span class="p">-&gt;</span> <span class="n">s</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>
<span class="o">...</span>

<span class="k">type</span> <span class="nc">ImageUrlString</span> <span class="p">=</span> <span class="k">private</span> <span class="nc">ImageUrlString</span> <span class="k">of</span> <span class="nc">UrlString</span>
    <span class="k">with</span> <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="p">=</span> <span class="k">match</span> <span class="n">this</span> <span class="k">with</span> <span class="nc">ImageUrlString</span> <span class="n">s</span> <span class="p">-&gt;</span> <span class="n">s</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span></code></pre></figure>

<p>This has proven to be extremely time-consuming and I am calling it quits for the day.</p>

<p>This is the last commit in the branch <code class="language-plaintext highlighter-rouge">step-5-wire-up-layout-to-gamestate</code></p>

<p><a href="https://github.com/jamesclancy/SafeCardGame/tree/step-5-wire-up-layout-to-gamestate">Git branch for this step</a></p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page13">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page11">Newer</a>
    
  
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
